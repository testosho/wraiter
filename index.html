		<!DOCTYPE html>
		<html lang="en">
		<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
		<title>Wraiter - AI Writing Assistant</title>
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">
		</head>
		<body class="dark-mode">
		<div id="top-ad-container" style="display: none; position: fixed; top: 0; left: 0; right: 0; z-index: 99999; background: transparent;"></div>
		

		<div id="modal-backdrop"></div>
		<div id="modal">
		    <h3 id="modal-title"></h3>
		    <div id="modal-content"></div>
		</div>

		<div id="ai-top-panel">
		    <div class="ai-panel-content" id="ai-panel-content"></div>
		</div>


		<button id="fullscreen-toggle" data-action="exit-focus-mode">
		    <span class="material-symbols-outlined">close_fullscreen</span>
		</button>

		<div id="mobile-top-bar">
		   <button data-action="toggle-main-menu" class="wraiter-btn">
		       wr<span style="color: #4285F4;">Ai</span>ter<span style="color: #4285F4; font-weight: 300; margin-left: 4px;">≡</span>
		   </button>
			<div id="mobile-slider-menu">
			    <button data-action="ai-instructions">API Instructions</button>
			    <button data-action="manage-apis">AI Settings</button>
			    <button data-action="local-instructions">Local AI Setup</button>
			    <button data-action="local-ai">Local AI</button>
			    <hr style="border-color: var(--mobile-border-color); margin: 6px 0;">
			    <button data-action="save-as">Save As</button>
			    <button data-action="open-text-file">Open</button>
			    <button data-action="share-content">Share</button>
			    <hr style="border-color: var(--mobile-border-color); margin: 6px 0;">
				<button data-action="remove-ads" id="remove-ads-btn">Remove Ads</button>
				 <hr style="border-color: var(--mobile-border-color); margin: 6px 0;">
			    <button data-action="show-info">Info</button>
			    <button data-action="show-about">About</button>
			</div>   
		    <button id="ai-status-btn" data-action="toggle-ai-panel" class="header-btn">
		        <span class="material-symbols-outlined">memory</span>
		    </button>
		    <button data-action="undo" class="header-btn">
		        <span class="material-symbols-outlined">undo</span>
		    </button>
		    <button data-action="redo" class="header-btn">
		        <span class="material-symbols-outlined">redo</span>
		    </button>
		    <button data-action="toggle-dark-mode" class="header-btn">
		        <span id="dark-mode-icon" class="material-symbols-outlined">light_mode</span>
		    </button>
		    <button data-action="toggle-focus" class="header-btn">
		        <span class="material-symbols-outlined">fullscreen</span>
			    <button data-action="toggle-library" class="header-btn">
			        <span class="material-symbols-outlined">library_books</span>
			    </button>
		    </button>
		</div>

		<div class="main-container">
		    <div id="editor" contenteditable="true" placeholder="Click wrAiter≡ to set up AI & Start writing here..."></div>
		</div>

		<div id="suggestion">
		    <button id="sidebar-close" data-action="close-sidebar">
		        <span class="material-symbols-outlined">close</span>
		    </button>
		    <div id="suggestion-content"></div>
		</div>

		<div id="file-library">
		    <!-- Clean header with title, action icons, and close -->
		    <div style="padding: 12px 15px; border-bottom: 1px solid var(--mobile-border-color); background: var(--modal-bg); display: flex; align-items: center; justify-content: space-between;">
		        <h4 style="margin: 0; font-size: 18px; font-weight: 600;">Library</h4>
		        <div style="display: flex; gap: 8px; align-items: center;">
		            <button onclick="showTagEditor()" style="background: none; border: none; color: var(--mobile-btn-color); cursor: pointer; padding: 6px; opacity: 0.8; display: flex; align-items: center;">
		                <span class="material-symbols-outlined" style="font-size: 20px;">label</span>
		            </button>
		            <button onclick="createNewFolder()" style="background: none; border: none; color: var(--mobile-btn-color); cursor: pointer; padding: 6px; opacity: 0.8; display: flex; align-items: center;">
		                <span class="material-symbols-outlined" style="font-size: 20px;">create_new_folder</span>
		            </button>
		            <button data-action="new-document" style="background: none; border: none; color: var(--mobile-btn-color); cursor: pointer; padding: 6px; opacity: 0.8; display: flex; align-items: center;">
		                <span class="material-symbols-outlined" style="font-size: 20px;">add</span>
		            </button>
		            <button data-action="close-library" style="background: none; border: none; color: var(--mobile-btn-color); cursor: pointer; padding: 6px; opacity: 0.8; display: flex; align-items: center;">
		                <span class="material-symbols-outlined" style="font-size: 22px;">close</span>
		            </button>
		        </div>
		    </div>
    
		    <!-- Content area -->
		    <div id="file-library-content" style="padding: 8px; overflow-y: auto; height: calc(100% - 50px);"></div>
		</div>
		
		
		
		
		<div id="mobile-bottom-bar">
		    <div class="popup-menu-container">
		        <button class="popup-menu-toggle" data-menu="ai-tools-menu">AI Tools</button>
		        <div class="popup-menu" id="ai-tools-menu">
		            <button data-action="ai-suggest">AI Suggest</button>
		            <button data-action="ai-proofread">AI Proofread</button>
		            <button data-action="ai-custom">AI Custom</button>
		            <button data-action="ai-translate">AI Translate</button>
		        </div>
		    </div>
		    <div class="popup-menu-container">
		        <button class="popup-menu-toggle" data-menu="rewrite-menu">Rewrite</button>
		        <div class="popup-menu" id="rewrite-menu">
		            <button data-action="rewrite-shorten">Shorten</button>
		            <button data-action="rewrite-expand">Expand</button>
		            <button data-action="rewrite-paraphrase">Paraphrase</button>
		            <button data-action="rewrite-grammar">Fix Grammar</button>
		        </div>
		    </div>
		    <div class="popup-menu-container">
		        <button class="popup-menu-toggle" data-menu="styles-menu">Styles</button>
		        <div class="popup-menu" id="styles-menu">
		            <button data-action="style-narrate">Narrate</button>
		            <button data-action="style-visualize">Visualize</button>
		            <button data-action="style-explain">Explain</button>
		            <button data-action="style-creative">Creative</button>
		        </div>
		    </div>
		    <div class="popup-menu-container">
		        <button class="popup-menu-toggle" data-menu="tone-menu">Tone</button>
		        <div class="popup-menu" id="tone-menu">
		            <button data-action="tone-candid">Candid</button>
		            <button data-action="tone-humorous">Humorous</button>
		            <button data-action="tone-intense">Intense</button>
		            <button data-action="tone-sarcastic">Sarcastic</button>
		        </div>
		    </div>
		    <div class="popup-menu-container">
		        <button class="popup-menu-toggle" data-menu="format-menu">Format</button>
		        <div class="popup-menu" id="format-menu">
		            <button data-action="font-increase">Font +</button>
		            <button data-action="font-decrease">Font -</button>
		            <button data-action="format-bold">Bold</button>
		            <button data-action="format-italic">Italic</button>
		            <button data-action="format-center">Center</button>
		            <button data-action="format-list">Number List</button>
		            <button data-action="format-quote">Quote</button>
		        </div>
		    </div>
		</div>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
		<style>
		@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600&display=swap');

		:root {
		    --mobile-bar-bg: #f5f5f5;
		    --mobile-btn-color: #000;
		    --mobile-border-color: #ccc;
		    --modal-bg: #fff;
		    --modal-shadow: rgba(0,0,0,0.2);
		    --modal-text: #333;
		    --display-scale: 1;
		    --editor-font-size: 18px;
		    --header-height: 50px;
		    --footer-height: 48px;
		    --keyboard-height: 0px;
		    --toolbar-visible: 1;WindowCompat.setDecorFitsSystemWindows(window, false)
		    --safe-bottom: 0px;
		}

		body.dark-mode {
		    color: #ddd;
		    --mobile-bar-bg: #252525;
		    --mobile-btn-color: #ddd;
		    --mobile-border-color: #444;
		    --modal-bg: #3a3a3a;
		    --modal-shadow: rgba(0,0,0,0.5);
		    --modal-text: #ddd;
		}

		body {
		    margin: 0;
		    padding: 0;
		    font-family: 'Roboto', sans-serif;
		    background-color: #252525; 
		    color: var(--editor-text);
		    overflow: hidden;
		    height: 100vh;
		    display: flex;
		    flex-direction: column;
    
		    /* ✅ ADD THESE TWO LINES */
		    padding-top: env(safe-area-inset-top);
		    padding-bottom: env(safe-area-inset-bottom);
		}
		

		body.dark-mode {
		    background: #222;
		}

		button, .popup-menu-toggle, input, textarea {
		    pointer-events: auto !important;
		    touch-action: manipulation !important;
		    cursor: pointer !important;
		    font-size: calc(14px * var(--display-scale));
		    transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
		    font-family: 'Roboto', Arial, sans-serif;
		}

		button:active, .popup-menu-toggle:active {
		    transform: scale(0.95);
		}

		#mobile-top-bar {
		    display: flex;
		    align-items: center;
		    height: 50px;
		    background-color: var(--mobile-bar-bg);
		    border-bottom: 1px solid var(--mobile-border-color);
		    padding: 0 4px;
		    box-sizing: border-box;
		    position: fixed;
		    top: 0;
		    left: 0;
		    right: 0;
		    z-index: 25000;
		    gap: 4px;
		    backdrop-filter: blur(10px);
		    -webkit-backdrop-filter: blur(10px);
		}

		.wraiter-btn {
		    background: none;
		    border: none;
		    color: var(--mobile-btn-color);
		    font-size: 20px !important;
		    font-weight: 700 !important;
		    cursor: pointer;
		    white-space: nowrap;
		    font-family: 'Roboto', sans-serif;
		    letter-spacing: 1px !important;
		    text-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
		    height: 38px;
		    width: 120px !important;
		    padding: 0;
		    border-radius: 8px;
		    display: flex;
		    align-items: center;
		    justify-content: center;
		    position: relative;
		}

		.header-btn {
		    background: none;
		    border: none;
		    color: var(--mobile-btn-color);
		    cursor: pointer;
		    height: 38px;
		    width: 38px;
		    border-radius: 8px;
		    display: flex;
		    align-items: center;
		    justify-content: center;
		    transition: all 0.2s ease;
		    flex-shrink: 0;
		}

		.header-btn:hover, .wraiter-btn:hover {
		    background-color: rgba(0,0,0,0.08);
		}

		.dark-mode .header-btn:hover, .dark-mode .wraiter-btn:hover {
		    background-color: rgba(255,255,255,0.12);
		}

		.header-btn .material-symbols-outlined {
		    font-size: 20px !important;
		    line-height: 1;
		}

		/* ✅ AI BUTTON - FORCE TO MATCH OTHER HEADER BUTTONS */
		#ai-status-btn {
		    position: relative !important;
		    background: none !important;
		    border: none !important;
		    color: var(--mobile-btn-color) !important;
		    cursor: pointer !important;
		    height: 38px !important;
		    width: 38px !important;
		    border-radius: 8px !important;
		    display: flex !important;
		    align-items: center !important;
		    justify-content: center !important;
		    transition: all 0.2s ease !important;
		    flex-shrink: 0 !important;
		}

		/* ✅ FORCE NORMAL HOVER LIKE OTHER BUTTONS */
		#ai-status-btn:hover {
		    background-color: rgba(0,0,0,0.08) !important;
		}

		.dark-mode #ai-status-btn:hover {
		    background-color: rgba(255,255,255,0.12) !important;
		}

		/* ✅ FLIP AI ICON & MATCH THEME COLOR */
		#ai-status-btn .material-symbols-outlined {
		    font-size: 20px !important;
		    line-height: 1 !important;
		    color: var(--mobile-btn-color) !important;
		}

		/* ✅ ONLY SYMBOL TURNS BLUE WHEN ACTIVE */
		#ai-status-btn.active .material-symbols-outlined {
		    color: #4285F4 !important;
		}

		//* ✅ AI STATUS BUTTON FLICKERING ANIMATIONS */
		#ai-status-btn.processing {
		    animation: aiProcessing 1.5s ease-in-out infinite !important;
		}

		#ai-status-btn.has-results {
		    animation: aiNewResult 2s ease-in-out infinite !important;
		    color: #4285F4 !important;
		}

		#ai-status-btn.viewed {
		    animation: none !important;
		    color: var(--mobile-btn-color) !important;
		}

		@keyframes aiProcessing {
		    0%, 100% { 
		        opacity: 0.4; 
				 transform: scale(1);
		    }
		    50% { 
		        opacity: 1; 
				transform: scale(1.1); 
		    }
		}

		@keyframes aiNewResult {
		    0%, 100% { 
		        opacity: 0.7; 
				transform: scale(1);
		    }
		    50% { 
		        opacity: 1; 
				transform: scale(1.05); 
		        color: #4285F4 !important;
		    }
		}

		/* ✅ SMALL TOOLTIP ON AI BUTTON */
		#ai-status-btn::after {
		    content: attr(data-tooltip);
		    position: absolute;
		    bottom: -25px;
		    left: 50%;
		    transform: translateX(-50%);
		    background: var(--modal-bg);
		    color: var(--modal-text);
		    padding: 4px 8px;
		    border-radius: 4px;
		    font-size: 10px;
		    white-space: nowrap;
		    opacity: 0;
		    pointer-events: none;
		    transition: opacity 0.3s ease;
		    border: 1px solid var(--mobile-border-color);
		    z-index: 1000;
		}

		#ai-status-btn.has-results::after {
		    opacity: 1;
		}

		#mobile-slider-menu {
		    display: none;
		    position: fixed;
		    background-color: var(--mobile-bar-bg);
		    border: 1px solid var(--mobile-border-color);
		    border-radius: 12px;
		    box-shadow: 0 8px 32px rgba(0,0,0,0.25);
		    z-index: 26001;
		    width: 180px;
		    padding: 6px 0;
		    pointer-events: auto !important;
		    opacity: 0;
		    transform: translateY(-10px) scale(0.98);
		    transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
		    backdrop-filter: blur(15px);
		    -webkit-backdrop-filter: blur(15px);
		    top: 55px;
		    left: 10px;
		}

		#mobile-slider-menu.show {
		    display: block;
		    opacity: 1;
		    transform: translateY(0) scale(1);
		}

		#mobile-slider-menu button {
		    display: block;
		    width: 100%;
		    text-align: left;
		    font-size: 14px;
		    font-weight: 500;
		    padding: 10px 14px;
		    margin: 0;
		    border: none;
		    background: transparent;
		    color: inherit;
		    pointer-events: auto !important;
		    font-family: 'Roboto', sans-serif;
		}

		#mobile-slider-menu button:hover {
		    background-color: rgba(0,0,0,0.05);
		}

		.dark-mode #mobile-slider-menu button:hover {
		    background-color: rgba(255,255,255,0.08);
		}

		.font-btn {
		    background: var(--mobile-btn-color);
		    color: var(--modal-bg);
		    border: none;
		    padding: 14px 20px;
		    border-radius: 8px;
		    font-size: 13px;
		    font-weight: 600;
		    cursor: pointer;
		    transition: all 0.2s ease;
		    font-family: 'Roboto', sans-serif;
		    width: 100px;
		    height: 42px;
		}

		.font-btn:hover {
		    opacity: 0.8;
		    transform: translateY(-1px);
		}

		.font-btn:active {
		    transform: translateY(0);
		}

		.font-size-control {
		    display: flex;
		    flex-direction: column;
		    align-items: center;
		    padding: 16px 14px;
		    border-bottom: 1px solid var(--mobile-border-color);
		    gap: 10px;
		}

		/* Add this after the #mobile-bottom-bar definition */
		#mobile-bottom-bar {
		    display: flex;
		    align-items: center;
		    height: calc(var(--footer-height) * var(--display-scale));
		    width: 100%;
		    background-color: var(--mobile-bar-bg);
		    border-top: 1px solid var(--mobile-border-color);
		    padding: 0;
		    box-sizing: border-box;
		    z-index: 25000 !important;
		    pointer-events: auto !important;
		    position: fixed !important;
		    bottom: 0 !important;
		    left: 0 !important;
		    right: 0 !important;
		    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
		    backdrop-filter: blur(10px);
		    -webkit-backdrop-filter: blur(10px);
		    transition: bottom 0.3s ease !important; /* ✅ ADD THIS */
		}

		/* ✅ ADD THIS NEW RULE - Footer moves up when ad is visible */
		body.ad-visible #mobile-bottom-bar {
		    bottom: 50px !important;
		}
		
		/* ✅ ADD THESE RULES TO HANDLE THE KEYBOARD */
		       body.keyboard-visible #mobile-bottom-bar {
		           bottom: var(--keyboard-height);
		       }

			   body.keyboard-visible #editor {
			              padding-bottom: calc(var(--keyboard-height) + var(--footer-height) + 40px) !important;
			          }
		

		.dark-mode #mobile-bottom-bar {
		    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
		}

		.popup-menu-container {
		    flex: 1;
		    position: relative;
		    pointer-events: auto !important;
		}

		.popup-menu-container .popup-menu-toggle {
		    width: 100%;
		    height: calc(var(--footer-height) * var(--display-scale));
		    border: none !important;
		    font-size: calc(11px * var(--display-scale));
		    font-weight: 500;
		    background: transparent !important;
		    outline: none !important;
		    box-shadow: none !important;
		    color: var(--mobile-btn-color);
		    display: flex;
		    align-items: center;
		    justify-content: center;
		    font-family: 'Roboto', sans-serif;
		}

		.popup-menu-container .popup-menu-toggle:hover {
		    background-color: rgba(0,0,0,0.05) !important;
		}

		.dark-mode .popup-menu-container .popup-menu-toggle:hover {
		    background-color: rgba(255,255,255,0.08) !important;
		}

		.main-container {
		    margin-top: 50px;
		    margin-bottom: 0;
		    height: calc(100vh - 50px);
		    display: flex;
		    flex-direction: column;
		    min-height: 0;
		    transition: all 0.3s ease;
		    position: relative;
		    overflow: hidden;
		}

		#editor {
		    flex: 1;
		    padding: 20px;
		    font-size: calc(var(--editor-font-size) * var(--display-scale));
		    line-height: 1.6;
		    background-color: #fff;
		    border: none;
		    outline: none;
		    resize: none;
		    overflow-y: auto;
		    overflow-x: hidden;
		    font-family: 'Courier New', monospace;
		    color: #111;
		    -webkit-overflow-scrolling: touch;
		    overscroll-behavior: contain;
		    scroll-behavior: smooth;
		    will-change: scroll-position;
		    contain: layout style;
		    word-wrap: break-word;
		    overflow-wrap: break-word;
		    white-space: pre-wrap;
		    position: relative;
		    height: 100%;
		    min-height: 100%;
		    pointer-events: auto !important;
		    user-select: text !important;
		    -webkit-user-select: text !important;
		    padding-bottom: calc(var(--footer-height) * var(--display-scale) + var(--keyboard-height) + 60px) !important;
		    box-sizing: border-box;
		    scroll-padding-bottom: calc(var(--footer-height) * var(--display-scale) + 80px);
		}
		

		.dark-mode #editor {
		    background-color: #333;
		    color: #ddd;
		}

		#editor:empty:before {
		    content: attr(placeholder);
		    color: grey;
		}

		#ai-top-panel {
		    position: fixed;
		    top: 50px;
		    left: 0;
		    right: 0;
		    bottom: 0;
		    background-color: var(--mobile-bar-bg);
		    z-index: 20000;
		    display: none;
		    transform: translateY(-100%);
		    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		}

		#ai-top-panel.show {
		    display: block;
		    transform: translateY(0);
		}

		#ai-panel-content {
		    height: 100%;
		    /* ✅ FIX: Added 60px padding to the bottom */
		    padding: 15px 15px 57px 15px;
		    overflow-y: auto;
		    background-color: var(--mobile-bar-bg);
		    box-sizing: border-box; /* Ensures padding is calculated correctly */
		}

		/* Fix for content scrolling */
		#ai-panel-content > div {
		    max-height: none !important;
		    overflow-y: visible !important;
		}

		.popup-menu {
		    display: none;
		    position: fixed;
		    background-color: var(--modal-bg);
		    border: 1px solid var(--mobile-border-color);
		    border-radius: 16px;
		    box-shadow: 0 12px 40px var(--modal-shadow);
		    z-index: 30000 !important;
		    width: auto !important;
		    max-width: 180px !important;
		    min-width: 120px !important;
		    overflow-y: auto;
		    overflow-x: hidden;
		    padding: 0 !important;
		    pointer-events: auto !important;
		    backdrop-filter: blur(20px);
		    -webkit-backdrop-filter: blur(20px);
		    opacity: 0;
		    transform: translateY(10px) scale(0.95);
		    transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
		}

		.popup-menu.show {
		    display: block;
		    opacity: 1;
		    transform: translateY(0) scale(1);
		}

		.popup-menu button {
		    display: block !important;
		    width: 100% !important;
		    text-align: left !important;
		    margin: 0 !important;
		    padding: 10px 12px !important;
		    background: transparent !important;
		    color: var(--modal-text) !important;
		    border: none !important;
		    font-size: 13px !important;
		    font-weight: 500 !important;
		    pointer-events: auto !important;
		    border-radius: 0 !important;
		    transition: all 0.2s ease !important;
		    white-space: nowrap !important;
		    font-family: 'Roboto', sans-serif !important;
		    line-height: 1.4 !important;
		    box-sizing: border-box !important;
		}

		.popup-menu button:hover {
		    background-color: rgba(0,0,0,0.08) !important;
		}

		.dark-mode .popup-menu button:hover {
		    background-color: rgba(255,255,255,0.12) !important;
		}

		.popup-menu button:first-child {
		    border-top-left-radius: 16px !important;
		    border-top-right-radius: 16px !important;
		}

		.popup-menu button:last-child {
		    border-bottom-left-radius: 16px !important;
		    border-bottom-right-radius: 16px !important;
		}

		.ai-result-container {
		    background: rgba(0,0,0,0.03);
		    border-radius: 12px;
		    padding: 15px;
		    margin: 15px auto;
		    border: 1px solid var(--mobile-border-color);
		    width: 90%;
		    max-width: 90%;
		    position: relative;
		    box-sizing: border-box;
		    transition: all 0.2s ease;
		}

		.dark-mode .ai-result-container {
		    background: rgba(255,255,255,0.03);
		}

		.ai-result-buttons {
		    display: flex;
		    gap: 8px;
		    margin-bottom: 12px;
		    justify-content: flex-start;
		}

		.ai-action-btn {
		    background: var(--mobile-btn-color);
		    color: var(--modal-bg);
		    border: none;
		    padding: 8px 16px;
		    border-radius: 20px;
		    font-size: 12px;
		    font-weight: 500;
		    cursor: pointer;
		    transition: all 0.2s;
		    pointer-events: auto !important;
		    white-space: nowrap;
		    font-family: 'Roboto', sans-serif;
		}

		.ai-action-btn:hover {
		    opacity: 0.8;
		    transform: translateY(-1px);
		}

		.ai-result-delete {
		    position: absolute;
		    top: 8px;
		    right: 8px;
		    background: none;
		    border: none;
		    color: var(--mobile-btn-color);
		    cursor: pointer;
		    padding: 4px;
		    border-radius: 50%;
		    opacity: 0.6;
		    font-size: 16px;
		    transition: all 0.2s;
		}

		.ai-result-delete:hover {
		    opacity: 1;
		    background: rgba(255, 0, 0, 0.1);
		    color: #ff4444;
		}

		.ai-result-text {
		    white-space: pre-wrap;
		    padding: 12px;
		    background: var(--modal-bg);
		    border-radius: 8px;
		    border: 1px solid var(--mobile-border-color);
		    font-family: 'Courier New', monospace;
		    font-size: 14px;
		    line-height: 1.5;
		    word-wrap: break-word;
		    max-height: none;
		}

		#file-library, #suggestion {
		    background-color: var(--mobile-bar-bg);
		    border-left: 1px solid var(--mobile-border-color);
		    display: none;
		    position: fixed;
		    /* ✅ FIX: Position from the very top and bottom of the screen */
		    top: 0; 
		    bottom: 0;
		    right: 0;
		    width: 280px;
		    /* ✅ FIX: Set a higher z-index to appear above the header/footer */
		    z-index: 26000 !important; 
		    box-sizing: border-box;
		    color: var(--modal-text);
		    transform: translateX(100%);
		    transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
		    backdrop-filter: blur(10px);
		    -webkit-backdrop-filter: blur(10px);
		    /* ✅ FIX: Add padding to respect phone notches and navigation bars */
		    padding-top: env(safe-area-inset-top);
		    padding-bottom: env(safe-area-inset-bottom);
		}
		
		#suggestion {
		    left: 0;
		    right: auto;
		    transform: translateX(-100%);
		}

		body.sidebar-visible #suggestion,
		body.library-visible #file-library {
		    display: block;
		    transform: translateX(0);
		}

		#suggestion-content {
		    padding: 15px;
		    overflow-y: auto;
		    height: calc(100% - 50px);
		}

		#modal-backdrop {
		    display: none;
		    position: fixed;
		    inset: 0;
		    background: rgba(0,0,0,0.4);
		    z-index: 30000;
		    backdrop-filter: blur(4px);
		    -webkit-backdrop-filter: blur(4px);
		}

		#modal {
		    display: none;
		    position: fixed;
		    top: 50%;
		    left: 50%;
		    transform: translate(-50%, -50%);
		    background: var(--modal-bg);
		    color: var(--modal-text);
		    border: 1px solid var(--mobile-border-color);
		    border-radius: 16px;
		    padding: 20px;
		    width: min(420px, 85vw);
		    max-width: 420px;
		    max-height: 70vh;
		    box-shadow: 0 12px 48px var(--modal-shadow);
		    z-index: 30001;
		    backdrop-filter: blur(20px);
		    -webkit-backdrop-filter: blur(20px);
		    overflow: hidden;
		    flex-direction: column;
		}

		#modal.info-modal {
		    width: min(350px, 80vw);
		    max-width: 350px;
		    max-height: 60vh;
		    padding: 16px;
		}

		#modal-title {
		    margin: 0 0 12px 0;
		    font-size: 18px;
		    font-weight: 600;
		    flex-shrink: 0;
		}

		#modal-content {
		    flex: 1;
		    overflow-y: auto;
		    margin: 0;
		    font-size: 14px;
		    line-height: 1.5;
		}

		.custom-alert-modal {
		    width: min(300px, 80vw) !important;
		    max-width: 300px !important;
		    padding: 16px !important;
		}

		.custom-alert-modal #modal-title {
		    font-size: 16px !important;
		    margin-bottom: 8px !important;
		}

		.progress-container {
		    width: 100%;
		    background-color: var(--mobile-border-color);
		    border-radius: 10px;
		    overflow: hidden;
		    margin: 10px 0;
		}

		.progress-bar {
		    height: 6px;
		    background-color: var(--mobile-btn-color);
		    width: 0%;
		    transition: width 0.3s ease;
		}

		.progress-text {
		    text-align: center;
		    font-size: 12px;
		    margin-top: 5px;
		    opacity: 0.7;
		}

		.modal-button {
		    background: var(--mobile-btn-color);
		    color: var(--modal-bg);
		    border: none;
		    padding: 12px 24px;
		    border-radius: 8px;
		    cursor: pointer;
		    margin: 5px;
		    font-family: 'Roboto', sans-serif;
		    font-weight: 500;
		    transition: all 0.2s ease;
		    font-size: 14px;
		    min-width: 80px;
		    pointer-events: auto !important;
		    touch-action: manipulation !important;
		}

		.modal-button:hover {
		    transform: translateY(-1px);
		    opacity: 0.9;
		}

		.modal-button.secondary {
		    background: var(--mobile-border-color);
		    color: var(--modal-text);
		}

		body.focus-mode #mobile-top-bar,
		body.focus-mode #mobile-bottom-bar,
		body.focus-mode #suggestion,
		body.focus-mode #file-library {
		    display: none;
		}

		body.focus-mode .main-container {
		    margin: 0 !important;
		    height: 100vh !important;
		}
		

		#fullscreen-toggle {
		    display: none;
		    position: fixed;
		    bottom: 20px;
		    right: 20px;
		    z-index: 30000 !important;
		    background: var(--modal-bg);
		    color: var(--modal-text);
		    border: 2px solid var(--mobile-border-color);
		    border-radius: 50%;
		    width: 56px;
		    height: 56px;
		    font-size: 24px;
		    cursor: pointer;
		    box-shadow: 0 6px 20px var(--modal-shadow);
		    pointer-events: auto !important;
		    transition: all 0.3s ease;
		}

		body.focus-mode #fullscreen-toggle {
		    display: flex;
		    align-items: center;
		    justify-content: center;
		}

		.language-input {
		    width: 100%;
		    padding: 12px;
		    border: 2px solid var(--mobile-border-color);
		    border-radius: 8px;
		    background: var(--modal-bg);
		    color: var(--modal-text);
		    font-size: 16px;
		    transition: all 0.2s ease;
		    box-sizing: border-box;
		    margin: 10px 0;
		    font-family: 'Roboto', sans-serif;
		}

		.language-input:focus {
		    outline: none;
		    border-color: var(--mobile-btn-color);
		    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
		}

		.dark-mode .language-input:focus {
		    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
		}
		
		.folder-content {
		    display: block;
		    transition: max-height 0.3s ease;
		    overflow: hidden;
		}

		.folder-content.collapsed {
		    display: none;
		}

		.folder-arrow {
		    display: inline-block;
		    transition: transform 0.2s ease;
		    margin-right: 8px;
		}

		.folder-arrow.collapsed {
		    transform: rotate(-90deg);
		}
		
		.clickable-link {
		    color: var(--mobile-btn-color);
		    text-decoration: underline;
		    cursor: pointer;
		    background: none;
		    border: none;
		    padding: 0;
		    font-size: inherit;
		    font-family: inherit;
		}
		</style>
		</head>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
		<script>
		document.addEventListener('touchstart', function() {}, { passive: true });
		
		
	// 🔄 REPLACE YOUR ENTIRE FloatingToolbar CLASS WITH THIS ONE
		class FloatingToolbar {
            constructor() {
                this.keyboardHeight = 0;
                this.isKeyboardVisible = false;
                this.lastViewportHeight = window.innerHeight;
                this.isEditorFocused = false;
                this.toolbar = document.getElementById('mobile-bottom-bar');
                this.debounceTimer = null;
                this.resizeTimer = null;
  
                this.init();
            }

            init() {
                if ('virtualKeyboard' in navigator) {
                    this.initVirtualKeyboardAPI();
                }
  
                if (window.visualViewport) {
                    this.initVisualViewportAPI();
                } else {
                    this.initWindowResizeAPI();
                }
  
                this.initEditorFocusDetection();
                this.initSafeAreaDetection();
                this.initOrientationHandling();
            }

            initVirtualKeyboardAPI() {
                try {
                    navigator.virtualKeyboard.overlaysContent = true;
      
                    navigator.virtualKeyboard.addEventListener('geometrychange', (event) => {
                        const rect = event.target.boundingRect;
                        this.updateKeyboardState(rect.height > 0, rect.height);
                    });
                } catch (e) {
                    console.log('VirtualKeyboard API not fully supported');
                }
            }

            initVisualViewportAPI() {
                const initialHeight = window.visualViewport.height;
                this.lastViewportHeight = initialHeight;
  
                const handleViewportChange = () => {
                    clearTimeout(this.debounceTimer);
                    this.debounceTimer = setTimeout(() => {
                        const currentHeight = window.visualViewport.height;
                        const heightDiff = initialHeight - currentHeight;
          
                        const isKeyboard = heightDiff > 150 && this.isEditorFocused;
                        const keyboardHeight = isKeyboard ? heightDiff : 0;
          
                        this.updateKeyboardState(isKeyboard, keyboardHeight);
                    }, 100);
                };
  
                window.visualViewport.addEventListener('resize', handleViewportChange);
                window.visualViewport.addEventListener('scroll', handleViewportChange);
            }

            initWindowResizeAPI() {
                let initialHeight = window.innerHeight;
  
                const handleResize = () => {
                    clearTimeout(this.resizeTimer);
                    this.resizeTimer = setTimeout(() => {
                        const currentHeight = window.innerHeight;
                        const heightDiff = initialHeight - currentHeight;
          
                        const isKeyboard = heightDiff > 150 && this.isEditorFocused;
                        const keyboardHeight = isKeyboard ? heightDiff : 0;
          
                        this.updateKeyboardState(isKeyboard, keyboardHeight);
                    }, 150);
                };
  
                window.addEventListener('resize', handleResize);
            }

            initEditorFocusDetection() {
                const editor = document.getElementById('editor');
  
                editor.addEventListener('focus', () => {
                    this.isEditorFocused = true;
                    this.ensureCursorVisible(); // Scroll into view on focus
                });
  
                editor.addEventListener('blur', () => {
                    setTimeout(() => {
                        if (!document.querySelector('#mobile-bottom-bar:hover') && 
                            !document.querySelector('.popup-menu:hover')) {
                            this.isEditorFocused = false;
                            setTimeout(() => {
                                if (!this.isEditorFocused) {
                                    this.updateKeyboardState(false, 0);
                                }
                            }, 200);
                        }
                    }, 100);
                });
            }

            initSafeAreaDetection() {
                // ... This function remains unchanged ...
                const testEl = document.createElement('div');
                testEl.style.cssText = 'position: fixed; bottom: env(safe-area-inset-bottom, 0px); height: 1px; pointer-events: none; opacity: 0;';
                document.body.appendChild(testEl);
                const safeBottom = window.innerHeight - testEl.getBoundingClientRect().bottom;
                if (safeBottom > 0) {
                    document.documentElement.style.setProperty('--safe-bottom', safeBottom + 'px');
                }
                document.body.removeChild(testEl);
            }

            initOrientationHandling() {
                // ... This function remains unchanged ...
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => {
                        this.updateKeyboardState(false, 0);
                        this.isKeyboardVisible = false;
                    }, 500);
                });
                window.addEventListener('resize', () => {
                    clearTimeout(this.resizeTimer);
                    this.resizeTimer = setTimeout(() => {
                        if (!this.isEditorFocused) {
                            this.updateKeyboardState(false, 0);
                        }
                    }, 300);
                });
            }
      
            updateKeyboardState(isVisible, height) {
                // ... This function remains unchanged ...
                this.isKeyboardVisible = isVisible;
                this.keyboardHeight = height;
                document.body.classList.toggle('keyboard-visible', isVisible);
                document.documentElement.style.setProperty('--keyboard-height', height + 'px');
                if (isVisible) {
                    closeAllMenus();
                }
            }
            
            /// ✅ THIS IS THE NEW, MORE RELIABLE SCROLLING FUNCTION
			ensureCursorVisible() {
			    if (!this.isKeyboardVisible) return;

			    setTimeout(() => {
			        const editor = document.getElementById('editor');
			        const selection = window.getSelection();
			        if (!selection || !selection.rangeCount) return;

			        const range = selection.getRangeAt(0);
			        const rect = range.getBoundingClientRect();
        
			        // Calculate safe zone (keyboard + toolbar + 2 lines buffer)
			        const lineHeight = 25; // approximate line height
			        const buffer = lineHeight * 2; // 2 lines space
			        const toolbarHeight = 48;
			        const viewportHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
			        const safeBottom = viewportHeight - toolbarHeight - buffer;
        
			        // If cursor is too low, scroll it up
			        if (rect.bottom > safeBottom) {
			            const scrollAmount = rect.bottom - safeBottom + 20;
			            editor.scrollTop += scrollAmount;
			        }
			    }, 100);
			}
			
			
            getKeyboardHeight() {
                return this.keyboardHeight;
            }
      
            isKeyboardOpen() {
                return this.isKeyboardVisible;
            }
        }
		
		
		function moveCursorToEnd() {
		    const editor = document.getElementById('editor');
		    const range = document.createRange();
		    const selection = window.getSelection();
    
		    range.selectNodeContents(editor);
		    range.collapse(false); // false = end of content
		    selection.removeAllRanges();
		    selection.addRange(range);
    
		    // Scroll to bottom
		    editor.scrollTop = editor.scrollHeight;
		}
		
		
		function positionPopupMenu(menu, trigger) {
		    const rect = trigger.getBoundingClientRect();
		    const menuRect = menu.getBoundingClientRect();
		    const viewportHeight = window.innerHeight;
		    const keyboardHeight = floatingToolbar.getKeyboardHeight();
		    const availableHeight = viewportHeight - keyboardHeight;
    
		    const spaceAbove = rect.top;
		    const spaceBelow = availableHeight - rect.bottom;
		    const menuHeight = menuRect.height || 300;
    
		    if (spaceAbove > menuHeight + 20) {
		        menu.style.bottom = 'calc(100vh - ' + rect.top + 'px + 8px)';
		        menu.style.top = 'auto';
		    } else {
		        const optimalTop = Math.max(20, Math.min(spaceBelow - menuHeight - 20, rect.bottom + 8));
		        menu.style.top = optimalTop + 'px';
		        menu.style.bottom = 'auto';
		    }
    
		    const centerX = rect.left + (rect.width / 2);
		    const menuWidth = menuRect.width || 200;
		    const leftPosition = Math.max(16, Math.min(window.innerWidth - menuWidth - 16, centerX - menuWidth / 2));
    
		    menu.style.left = leftPosition + 'px';
		    menu.style.right = 'auto';
		}

		// ✅ UPDATE THESE BRIDGE FUNCTIONS IN YOUR HTML
		function loadBannerAdForResults() {
		    if (window.TaskModelBridge) {
		        window.TaskModelBridge.loadBannerAd();
		    }
		}

		function loadVideoAdForProcessing() {
		    if (window.TaskModelBridge) {
		        window.TaskModelBridge.loadVideoAd();
		    }
		}



		function addAiResult(text, source) {
		    source = source || 'Unknown AI';
    
		    var result = {
		        id: 'ai_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
		        text: text,
		        source: source,
		        timestamp: Date.now()
		    };
    
		    aiResults.unshift(result); // Add to beginning
    
		    // ✅ Limit to 20 results to prevent memory issues
		    if (aiResults.length > 20) {
		        aiResults = aiResults.slice(0, 20);
		    }
    
		    // ✅ Save to localStorage for persistence
		    try {
		        localStorage.setItem('wraiterAiResults', JSON.stringify(aiResults.slice(0, 20)));
		    } catch (e) {
		        console.warn('Could not save AI results to localStorage');
		    }
    
		    displayAiHistory();
		    updateAiStatus('has-results');
		}


		document.addEventListener('DOMContentLoaded', function() {

		var history = [''];
		var historyIndex = 0;
		var isProcessing = false;
		var currentDocumentId = null;
		var currentTags = [];
		var currentFolder = 'All Documents';
		var isAutoSaving = false;
		var selectedTextForAI = '';
		var aiResults = [];
		var currentAiResult = '';

		var editor = document.getElementById('editor');
		var suggestionContent = document.getElementById('suggestion-content');
		var fileLibraryContent = document.getElementById('file-library-content');
		var modal = document.getElementById('modal');
		var modalBackdrop = document.getElementById('modal-backdrop');
		var modalTitle = document.getElementById('modal-title');
		var modalContent = document.getElementById('modal-content');
		var darkModeIcon = document.getElementById('dark-mode-icon');
		var aiTopPanel = document.getElementById('ai-top-panel');
		var aiPanelContent = document.getElementById('ai-panel-content');
		var aiStatusBtn = document.getElementById('ai-status-btn');

		var floatingToolbar = new FloatingToolbar();
		window.floatingToolbar = floatingToolbar;
		

		    // Re-apply on orientation change
		    window.addEventListener('resize', function() {
		        applySafeAreaPadding();
		    });
		

		let inputTimeout;
		function ultraDebounce(func, delay) {
		    return function() {
		        var args = arguments;
		        clearTimeout(inputTimeout);
		        inputTimeout = setTimeout(function() { func.apply(null, args); }, delay || 500);
		    };
		}

		function showCustomAlert(title, message, dismissible = true) {
		    modalTitle.textContent = title;
		    modalContent.innerHTML = '<div style="padding: 10px 0; line-height: 1.5;">' + message + '</div>' + 
		        (dismissible ? '<div style="text-align: right; margin-top: 20px;"><button id="alert-close-btn" class="modal-button">Close</button></div>' : '');
		    modal.className = 'custom-alert-modal';
		    modalBackdrop.style.display = 'block';
		    modal.style.display = 'flex';
    
		    if (dismissible) {
		        setTimeout(() => {
		            const closeBtn = document.getElementById('alert-close-btn');
		            if (closeBtn) {
		                closeBtn.onclick = function() {
		                    hideModal();
		                };
		            }
		        }, 50);
		    }
		}

		function updateDownloadProgress(progress) {
		    modalContent.innerHTML = '<div style="padding: 10px 0;">' +
		        '<div class="progress-container">' +
		            '<div class="progress-bar" style="width: ' + progress + '%"></div>' +
		        '</div>' +
		        '<div class="progress-text">' + progress + '%</div>' +
		        '</div>';
		}
		
	    // =======================================================================
	    // THIS IS THE FUNCTION THAT WAS REPLACED. IT IS NOW CORRECT.
	    // =======================================================================
	               window.updateUiForProStatus = function(isPro) {
	                   const removeAdsBtn = document.getElementById('remove-ads-btn');
	                   if (!removeAdsBtn) return;

	                   if (isPro) {
	                       // --- PRO USER STATE ---
	                       // This runs after a successful purchase.
	                       removeAdsBtn.innerHTML = 'Wraiter Pro';
	                       removeAdsBtn.dataset.action = 'pro-status'; 
	                       removeAdsBtn.style.color = '#4285F4';      // Set color to blue
	                       removeAdsBtn.style.fontWeight = '600';    // Make it bold
	                       removeAdsBtn.style.pointerEvents = 'none'; // Disable the button
                    
	                       // Hide all ad containers permanently
	                       const topAd = document.getElementById('top-ad-container');
	                       if (topAd) topAd.style.display = 'none';
                    
	                       hideFallbackAd();

	                   } else {
	                       // --- DEFAULT STATE ---
	                       // This is how the button looks initially.
	                       removeAdsBtn.innerHTML = 'Remove Ads';
	                       removeAdsBtn.dataset.action = 'remove-ads';
	                       removeAdsBtn.style.color = '#4285F4';      // Set color to blue
	                       removeAdsBtn.style.fontWeight = '600';    // Make it bold
	                       removeAdsBtn.style.pointerEvents = 'auto'; // Make sure it's clickable
	                   }
	               };
		

		window.showCustomAlert = showCustomAlert;
		window.updateDownloadProgress = updateDownloadProgress;

		// ✅ ENHANCED AI STATUS WITH FLICKERING
		function updateAiStatus(status) {
		    const aiBtn = document.getElementById('ai-status-btn');
    
		    // Remove all status classes
		    aiBtn.classList.remove('processing', 'has-results', 'viewed');
		    aiBtn.removeAttribute('data-tooltip');
    
		    switch(status) {
		        case 'processing':
		            aiBtn.classList.add('processing');
		            aiBtn.title = 'AI Processing...';
		            aiBtn.setAttribute('data-tooltip', 'Processing...');
		            break;
		        case 'has-results':
		            aiBtn.classList.add('has-results');
		            aiBtn.title = 'New AI Results - Click to View';
		            aiBtn.setAttribute('data-tooltip', 'New Results!');
		            break;
		        case 'viewed':
		            aiBtn.classList.add('viewed');
		            aiBtn.title = 'AI Results';
		            aiBtn.removeAttribute('data-tooltip');
		            break;
		        default:
		            aiBtn.title = 'AI Results';
		            break;
		    }
		}


		function showAiPanel() {
		    // HIDE FOOTER WHEN AI HISTORY PANEL IS OPEN  
		    document.getElementById('mobile-bottom-bar').style.display = 'none';

		    // ✅ RESET DISPLAY AND TRANSFORM BEFORE SHOWING
		    aiTopPanel.style.display = 'flex';
		    aiTopPanel.style.transform = 'translateY(-100%)';

		    // ✅ FORCE REFLOW THEN ANIMATE IN
		    requestAnimationFrame(() => {
		        aiTopPanel.classList.add('show');
		        aiTopPanel.style.transform = 'translateY(0)';
		    });

		    displayAiHistory();
    
		    // 🔧 ADD: Show banner ad
		    setTimeout(() => {
		        if (window.TaskModelBridge) {
		            TaskModelBridge.showAiHistoryBannerAd();
		        }
		    }, 500);
		}
		


		function hideAiPanel() {
		    aiTopPanel.classList.remove('show');
    
		    // IMMEDIATELY HIDE BANNER - NO DELAY
		    if (window.TaskModelBridge) {
		        TaskModelBridge.hideAiHistoryBannerAd();
		    }
    
		    // RESTORE FOOTER WHEN AI HISTORY PANEL IS CLOSED
		    document.getElementById('mobile-bottom-bar').style.display = 'flex';
    
		    setTimeout(() => {
		        aiTopPanel.style.display = 'none';
		    }, 300);
    
		    updateAiStatus(aiResults.length > 0 ? 'has-results' : '');
		    document.getElementById('ai-status-btn').classList.remove('active');
		}
		
		

// 🔄 REPLACE your existing toggleAiPanel function with this one.

function toggleAiPanel() {
    const aiButton = document.getElementById('ai-status-btn');

    if (aiTopPanel.classList.contains('show')) {
        // CLOSING PANEL - MARK AS VIEWED
        hideAiPanel();
        aiButton.classList.remove('active');
        updateAiStatus('viewed'); // Stop flickering when viewed
    } else {
        // CLOSE OTHER PANELS FIRST
        closePanelsExcept('ai');

        // OPENING PANEL
        if (aiResults.length > 0) {
            // If there are results, show the history
            displayAiHistory();
            updateAiStatus('viewed'); // Stop flickering when opened
        } else {
            // ✅ NEW: If there are NO results, show a simple message.
            // The full instructions are now handled by displayAiHistory().
            document.querySelector('#ai-top-panel .ai-panel-content').innerHTML = 
                '<div style="padding: 40px; text-align: center; opacity: 0.7; font-size: 16px;">' +
                'No AI results yet.<br><br>Use AI tools to generate content.' +
                '</div>';
        }

        showAiPanel();
        aiButton.classList.add('active');
    }
}

		window.hideAiPanel = hideAiPanel;
		window.toggleAiPanel = toggleAiPanel;

		// ✅ FONT SIZE MANAGEMENT
		var currentFontSize = parseInt(localStorage.getItem('editorFontSize')) || 18;

		function updateEditorFontSize(fontSize) {
		    document.documentElement.style.setProperty('--editor-font-size', fontSize + 'px');
		    localStorage.setItem('editorFontSize', fontSize);
		    currentFontSize = fontSize;
		}

		// ✅ INITIALIZE FONT SIZE ON LOAD
		updateEditorFontSize(currentFontSize);


		function generateId() {
		    return 'doc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
		}

		var ultraDebouncedUpdateEditor = ultraDebounce(function() {
		    var content = editor.innerHTML;
		    if (history[historyIndex] !== content) {
		        if (historyIndex < history.length - 1) {
		            history = history.slice(0, historyIndex + 1);
		        }
		        history.push(content);
		        historyIndex++;
		    }
		    autoSaveCurrentDocument();
		});

		function updateEditorState() {
		    ultraDebouncedUpdateEditor();
		}

		function showModal(title, contentHTML) {
		    modalTitle.textContent = title;
		    modalContent.innerHTML = contentHTML;
		    modalBackdrop.style.display = 'block';
		    modal.style.display = 'flex';
    
		    if (title === 'Button Guide' || title === 'About Wraiter') {
		        modal.classList.add('info-modal');
		    } else {
		        modal.classList.remove('info-modal');
		    }
		}

		function hideModal() {
		    modalBackdrop.style.display = 'none';
		    modal.style.display = 'none';
		    modalContent.innerHTML = '';
		    modal.classList.remove('info-modal', 'custom-alert-modal');
		}

		function showAiSettingsModal() {
		    // ✅ Simply redirect to the new API Manager
		    showApiManagerModal();
		}
		
		function showApiManagerModal() {
		    var customAPIs = getCustomAPIs();
    
		    modalTitle.textContent = '⚙️ AI Settings';
    
		    var apiListHTML = '';
    
		    // ✅ ALWAYS SHOW AT LEAST ONE EMPTY API FORM
		    if (customAPIs.length === 0) {
		        apiListHTML = '<div style="text-align: center; color: var(--secondary-text-color); padding: 15px; font-style: italic; background: var(--modal-bg); border: 2px dashed var(--mobile-border-color); border-radius: 8px; margin-bottom: 15px;">' +
		            '<div style="font-size: 14px; margin-bottom: 10px;">👆 Click "Add New API" to get started!</div>' +
		            '<div style="font-size: 12px;">Add OpenAI, Groq, Claude, Gemini or any AI provider</div>' +
		        '</div>';
		    } else {
		        // ✅ IMPROVED LAYOUT - SHOW ONLY API NAME + BUTTONS
		        for (var i = 0; i < customAPIs.length; i++) {
		            var api = customAPIs[i];
		            var toggleText = api.active ? '🟢' : '🔴';
		            var statusText = api.active ? 'Active' : 'Inactive';
		            var statusColor = api.active ? '#10B981' : '#6B7280';
            
		            apiListHTML += 
		                '<div style="border: 1px solid var(--mobile-border-color); border-radius: 8px; padding: 15px; margin-bottom: 12px; background: var(--modal-bg);">' +
                    
		                    // ✅ CLEAN LAYOUT - API NAME + STATUS
		                    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">' +
		                        '<div style="flex: 1;">' +
		                            '<div style="font-weight: 600; color: var(--primary-text-color); font-size: 15px;">' + api.name + '</div>' +
		                            '<div style="font-size: 12px; color: ' + statusColor + '; margin-top: 3px;">● ' + statusText + '</div>' +
		                        '</div>' +
		                    '</div>' +
                    
		                    // ✅ BUTTONS ROW - WITH DATA ATTRIBUTES (NO INLINE ONCLICK)
		                    '<div style="display: flex; gap: 8px; flex-wrap: wrap;">' +
		                        '<button class="toggle-api-btn" data-index="' + i + '" style="background: ' + (api.active ? '#10B981' : '#EF4444') + '; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 12px; cursor: pointer; font-weight: 600; flex: 1; min-width: 70px;">' +
		                            toggleText + ' ' + (api.active ? 'ON' : 'OFF') +
		                        '</button>' +
		                        '<button class="edit-api-btn" data-index="' + i + '" style="background: #3B82F6; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 12px; cursor: pointer; font-weight: 600; flex: 1; min-width: 60px;">Edit</button>' +
		                        '<button class="delete-api-btn" data-index="' + i + '" style="background: #EF4444; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 12px; cursor: pointer; font-weight: 600; flex: 1; min-width: 60px;">Delete</button>' +
		                    '</div>' +
		                '</div>';
		        }
		    }
    
		    modalContent.innerHTML = 
		        '<div style="max-height: 450px; overflow-y: auto; padding: 10px;">' +
		            '<div style="background: linear-gradient(45deg, #8B5CF6, #06B6D4); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px;">' +
		                '<div style="font-weight: 600; font-size: 16px;">🌐 Custom AI Manager</div>' +
		                '<div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">Add AI provider • Toggle On/Off • Manage</div>' +
		            '</div>' +
            
		            apiListHTML +
            
		            '<div style="margin-top: 20px; display: flex; gap: 10px;">' +
		                '<button id="add-new-api-btn" style="background: #10B981; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; flex: 1;">➕ Add API</button>' +
		                '<button id="done-api-btn" style="background: var(--mobile-border-color); color: var(--primary-text-color); border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">✅ Done</button>' +
		            '</div>' +
		        '</div>';
    
		    modal.className = 'custom-prompt-modal';
		    modalBackdrop.style.display = 'block';
		    modal.style.display = 'flex';
    
		    // ✅ PROPER EVENT LISTENERS - ALL WORKING
		    setTimeout(() => {
		        // Add New API button
		        document.getElementById('add-new-api-btn').onclick = function() {
		            showAddApiModal();
		        };
        
		        // Done button
		        document.getElementById('done-api-btn').onclick = function() {
		            hideModal();
		        };
        
		        // ✅ TOGGLE BUTTONS
		        var toggleButtons = document.querySelectorAll('.toggle-api-btn');
		        for (var i = 0; i < toggleButtons.length; i++) {
		            toggleButtons[i].onclick = function() {
		                var index = parseInt(this.getAttribute('data-index'));
		                toggleAPI(index);
		            };
		        }
        
		        // ✅ EDIT BUTTONS
		        var editButtons = document.querySelectorAll('.edit-api-btn');
		        for (var i = 0; i < editButtons.length; i++) {
		            editButtons[i].onclick = function() {
		                var index = parseInt(this.getAttribute('data-index'));
		                editAPI(index);
		            };
		        }
        
		        // ✅ DELETE BUTTONS
		        var deleteButtons = document.querySelectorAll('.delete-api-btn');
		        for (var i = 0; i < deleteButtons.length; i++) {
		            deleteButtons[i].onclick = function() {
		                var index = parseInt(this.getAttribute('data-index'));
		                deleteAPI(index);
		            };
		        }
		    }, 100);
		}


		// ✅ Toggle API on/off
		function toggleAPI(index) {
		    var apis = getCustomAPIs();
		    apis[index].active = !apis[index].active;
		    saveCustomAPIs(apis);
		    showApiManagerModal(); // Refresh display
		}

		// ✅ Edit API
		function editAPI(index) {
		    var apis = getCustomAPIs();
		    var api = apis[index];
		    showAddApiModal(api, index);
		}

		// ✅ Delete API
		function deleteAPI(index) {
		    if (confirm('Delete this API?')) {
		        var apis = getCustomAPIs();
		        apis.splice(index, 1);
		        saveCustomAPIs(apis);
		        showApiManagerModal(); // Refresh display
		    }
		}
		
		

	function showAddApiModal(existingAPI, editIndex) {
	    var isEdit = existingAPI !== undefined;
	    var api = existingAPI || { 
	        name: '', 
	        url: '', 
	        key: '', 
	        active: true 
	    };

	    // AUTO-FILL PLACEHOLDER FOR NEW USERS
	    if (!isEdit && getCustomAPIs().length === 0) {
	        api = {
	            name: 'Groq API (Free)',
	            url: 'https://api.groq.com/openai/v1/chat/completions',
	            key: '',
	            active: true
	        };
	    }

	    modalTitle.textContent = isEdit ? 'Edit API' : '➕ Add New API';

	    // DELETE BUTTON HTML (only for edit mode)
	    var deleteButtonHTML = isEdit ? 
	        '<button id="delete-api-btn" style="background: #EF4444; color: white; border: none; padding: 12px 18px; border-radius: 6px; font-weight: 600; cursor: pointer;">Delete</button>' : '';

	    modalContent.innerHTML = 
	        '<div style="max-height: 900px; overflow-y: auto; padding: 15px;">' +
	            '<div style="background: linear-gradient(45deg, #10B981, #3B82F6); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px;">' +
	                '<div style="font-weight: 600; font-size: 16px;">🤖 Universal AI Setup</div>' +
	                '<div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">Pick AI → Url → Enter Ur key → Done!</div>' +
	            '</div>' +
            
	            // PROVIDER SELECTION DROPDOWN
	            '<div style="margin-bottom: 15px;">' +
	                '<label style="display: block; font-weight: 600; margin-bottom: 5px;">AI Provider</label>' +
	                '<select id="api-provider" style="width: 100%; padding: 10px; border: 1px solid var(--mobile-border-color); border-radius: 6px; background: var(--modal-bg); color: var(--modal-text);">' +
	                    '<option value="">-- Select Provider --</option>' +
						'<option value="google">Google Gemini (Free & Paid)</option>' +
	                    '<option value="groq">Groq (Free & Fast)</option>' +
	                    '<option value="openai">OpenAI (ChatGPT)</option>' + 
	                    '<option value="anthropic">Anthropic (Claude)</option>' +
	                    '<option value="perplexity">Perplexity</option>' +
	                    '<option value="deepseek">DeepSeek</option>' +
	                    '<option value="mistral">Mistral AI</option>' +
	                    '<option value="together">Together AI</option>' +
	                    '<option value="custom">Custom Provider</option>' +
	                '</select>' +
	            '</div>' +
            
	            // API NAME
	            '<div style="margin-bottom: 15px;">' +
	                '<label style="display: block; font-weight: 600; margin-bottom: 5px;">API Name</label>' +
	                '<input type="text" id="add-api-name" placeholder="My AI API" value="' + api.name + '" style="width: 100%; padding: 10px; border: 1px solid var(--mobile-border-color); border-radius: 6px; background: var(--modal-bg); color: var(--modal-text);">' +
	            '</div>' +
            
	            // API URL
	            '<div style="margin-bottom: 15px;">' +
	                '<label style="display: block; font-weight: 600; margin-bottom: 5px;">API URL</label>' +
	                '<input type="url" id="add-api-url" placeholder="https://api.groq.com/openai/v1/chat/completions" value="' + api.url + '" style="width: 100%; padding: 10px; border: 1px solid var(--mobile-border-color); border-radius: 6px; background: var(--modal-bg); color: var(--modal-text);">' +
	                '<div style="font-size: 11px; color: #6B7280; margin-top: 3px;">💡 Auto-filled when you select a provider above</div>' +
	            '</div>' +
            
	            // API KEY
	            '<div style="margin-bottom: 20px;">' +
	                '<label style="display: block; font-weight: 600; margin-bottom: 5px;">API Key</label>' +
	                '<input type="password" id="add-api-key" placeholder="Your API key" value="' + api.key + '" style="width: 100%; padding: 10px; border: 1px solid var(--mobile-border-color); border-radius: 6px; background: var(--modal-bg); color: var(--modal-text);">' +
	            '</div>' +
            
	            // PROVIDER INFO PANEL
	            '<div id="provider-info" style="background: var(--modal-bg); border: 1px solid var(--mobile-border-color); border-radius: 8px; padding: 12px; margin-bottom: 20px; display: none;">' +
	                '<div style="font-weight: 600; margin-bottom: 8px;">📋 How to get API key:</div>' +
	                '<div id="provider-instructions" style="font-size: 12px; color: var(--secondary-text-color); line-height: 1.4;"></div>' +
	            '</div>' +
            
	            // BUTTONS
	            '<div style="display: flex; gap: 10px; flex-wrap: wrap;">' +
	                '<button id="test-new-api-btn" style="background: #10B981; color: white; border: none; padding: 12px 18px; border-radius: 6px; font-weight: 600; flex: 1; cursor: pointer;">Test</button>' +
	                '<button id="save-new-api-btn" style="background: #3B82F6; color: white; border: none; padding: 12px 18px; border-radius: 6px; font-weight: 600; flex: 1; cursor: pointer;">Save</button>' +
	                deleteButtonHTML +
	                '<button id="cancel-new-api-btn" style="background: var(--mobile-border-color); color: var(--primary-text-color); border: none; padding: 12px 18px; border-radius: 6px; font-weight: 600; cursor: pointer;">❌</button>' +
	            '</div>' +
	        '</div>';

	    modal.className = 'custom-prompt-modal';
	    modalBackdrop.style.display = 'block';
	    modal.style.display = 'flex';

	    // SETUP ALL EVENT LISTENERS
	    setTimeout(function() {
	        setupProviderDropdown();
	        setupModalButtons(editIndex, isEdit);
	    }, 100);
	}

	// PROVIDER DROPDOWN HANDLER
	function setupProviderDropdown() {
	    var providerSelect = document.getElementById('api-provider');
	    var nameField = document.getElementById('add-api-name');
	    var urlField = document.getElementById('add-api-url');
	    var providerInfo = document.getElementById('provider-info');
	    var providerInstructions = document.getElementById('provider-instructions');
    
	    var providers = {
	        'groq': {
	            name: 'Groq API (Free)',
	            url: 'https://api.groq.com/openai/v1/chat/completions',
	            instructions: '1. Go to <strong>console.groq.com</strong><br>2. Sign up for FREE<br>3. Go to API Keys<br>4. Create new key<br>5. Paste here'
	        },
	        'openai': {
	            name: 'OpenAI API',
	            url: 'https://api.openai.com/v1/chat/completions',
	            instructions: '1. Go to <strong>platform.openai.com</strong><br>2. Sign up/Login<br>3. Go to API Keys<br>4. Create new key<br>5. Paste here'
	        },
	        'google': {
	            name: 'Google Gemini',
	            url: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent',
	            instructions: '1. Go to <strong>aistudio.google.com</strong><br>2. Sign in<br>3. Click "Get API key"<br>4. Create key<br>5. Paste here'
	        },
	        'anthropic': {
	            name: 'Anthropic Claude',
	            url: 'https://api.anthropic.com/v1/messages',
	            instructions: '1. Go to <strong>console.anthropic.com</strong><br>2. Create account<br>3. Go to API Keys<br>4. Create key<br>5. Paste here'
	        },
	        'perplexity': {
	            name: 'Perplexity API',
	            url: 'https://api.perplexity.ai/chat/completions',
	            instructions: '1. Go to <strong>perplexity.ai</strong><br>2. Subscribe to Pro<br>3. Get API access<br>4. Generate key<br>5. Paste here'
	        },
	        'deepseek': {
	            name: 'DeepSeek API',
	            url: 'https://api.deepseek.com/v1/chat/completions',
	            instructions: '1. Go to <strong>platform.deepseek.com</strong><br>2. Register<br>3. Go to API Keys<br>4. Create key<br>5. Paste here'
	        },
	        'mistral': {
	            name: 'Mistral AI',
	            url: 'https://api.mistral.ai/v1/chat/completions',
	            instructions: '1. Go to <strong>console.mistral.ai</strong><br>2. Create account<br>3. Go to API Keys<br>4. Create key<br>5. Paste here'
	        },
	        'together': {
	            name: 'Together AI',
	            url: 'https://api.together.xyz/v1/chat/completions',
	            instructions: '1. Go to <strong>api.together.xyz</strong><br>2. Sign up<br>3. Get API key<br>4. Create key<br>5. Paste here'
	        }
	    };
    
	    if (providerSelect) {
	        providerSelect.onchange = function() {
	            var selectedProvider = this.value;
            
	            if (!selectedProvider) {
	                providerInfo.style.display = 'none';
	                return;
	            }
            
	            if (selectedProvider === 'custom') {
	                nameField.value = '⚙️ Custom API';
	                urlField.value = '';
	                providerInfo.style.display = 'none';
	                return;
	            }
            
	            var config = providers[selectedProvider];
	            if (config) {
	                nameField.value = config.name;
	                urlField.value = config.url;
	                providerInfo.style.display = 'block';
	                providerInstructions.innerHTML = config.instructions;
	            }
	        };
	    }
	}

	// MODAL BUTTONS HANDLER - FIXED VERSION
	function setupModalButtons(editIndex, isEdit) {
	    // Test button - REAL WORKING TEST
	    var testBtn = document.getElementById('test-new-api-btn');
	    if (testBtn) {
	        testBtn.onclick = function() {
	            testNewAPI();
	        };
	    }

	    // Save button
	    var saveBtn = document.getElementById('save-new-api-btn');
	    if (saveBtn) {
	        saveBtn.onclick = function() {
	            saveNewAPI(editIndex !== undefined ? editIndex : -1);
	        };
	    }

	    // Delete button (only in edit mode)
	    var deleteBtn = document.getElementById('delete-api-btn');
	    if (deleteBtn && isEdit) {
	        deleteBtn.onclick = function() {
	            if (confirm('Delete this API? This cannot be undone.')) {
	                var apis = getCustomAPIs();
	                apis.splice(editIndex, 1);
	                saveCustomAPIs(apis);
	                showApiManagerModal();
	                showCustomAlert('✅ Deleted!', 'API deleted successfully.');
	            }
	        };
	    }

	    // Cancel button - SIMPLE FIX
	    var cancelBtn = document.getElementById('cancel-new-api-btn');
	    if (cancelBtn) {
	        cancelBtn.onclick = function() {
	            hideModal();
	        };
	    }
	}

	// REAL WORKING TEST FUNCTION
	function testNewAPI() {
	    var name = document.getElementById('add-api-name').value.trim();
	    var url = document.getElementById('add-api-url').value.trim();
	    var key = document.getElementById('add-api-key').value.trim();
    
	    if (!name || !url || !key) {
	        showCustomAlert('❌ Missing Info', 'Please fill all fields first.');
	        return;
	    }
    
	    var testBtn = document.getElementById('test-new-api-btn');
	    var originalText = testBtn.textContent;
	    testBtn.textContent = '⏳ Testing...';
	    testBtn.disabled = true;
    
	    // Reset button after 3 seconds regardless of result
	    setTimeout(function() {
	        testBtn.textContent = originalText;
	        testBtn.disabled = false;
	    }, 3000);
    
	    // Basic connection test
	    fetch(url, {
	        method: 'POST',
	        headers: {
	            'Authorization': 'Bearer ' + key,
	            'Content-Type': 'application/json'
	        },
	        body: JSON.stringify({
	            messages: [{ role: 'user', content: 'Hi' }],
	            max_tokens: 5
	        })
	    })
	    .then(function(response) {
	        if (response.ok) {
	            showCustomAlert('✅ Test Passed!', name + ' is working correctly!');
	        } else {
	            showCustomAlert('⚠️ Response Error', 'Got ' + response.status + ' status. But API is reachable.');
	        }
	    })
	    .catch(function(error) {
	        showCustomAlert('❌ Connection Failed', 'Cannot reach API. Check URL and key.');
	    });
	}

	// WORKING SAVE FUNCTION
	function saveNewAPI(editIndex) {
	    var name = document.getElementById('add-api-name').value.trim();
	    var url = document.getElementById('add-api-url').value.trim();
	    var key = document.getElementById('add-api-key').value.trim();
    
	    if (!name || !url || !key) {
	        showCustomAlert('❌ Missing Info', 'Please fill all required fields.');
	        return;
	    }
    
	    var apis = getCustomAPIs();
	    var newAPI = {
	        name: name,
	        url: url,
	        key: key,
	        active: true,
	        id: Date.now()
	    };
    
	    if (editIndex >= 0) {
	        // Edit existing API
	        apis[editIndex] = newAPI;
	        showCustomAlert('✅ Updated!', name + ' has been updated!');
	    } else {
	        // Add new API
	        apis.push(newAPI);
	        showCustomAlert('✅ Added!', name + ' has been added!');
	    }
    
	    saveCustomAPIs(apis);
    
	    // Show API manager after save
	    setTimeout(function() {
	        showApiManagerModal();
	    }, 1500);
	}

	// WORKING VERSION - RESTORED FROM YOUR ORIGINAL CODE
	function showApiManagerModal() {
	    var customAPIs = getCustomAPIs();
	    modalTitle.textContent = '⚙️ AI Settings';
    
	    var apiListHTML = '';
    
	    // ALWAYS SHOW AT LEAST ONE EMPTY API FORM
	    if (customAPIs.length === 0) {
	        apiListHTML = '<div style="text-align: center; color: var(--secondary-text-color); padding: 15px; font-style: italic; background: var(--modal-bg); border: 2px dashed var(--mobile-border-color); border-radius: 8px; margin-bottom: 15px;">' +
	                     '<div style="font-size: 14px; margin-bottom: 10px;">🤖 Click "Add New API" to get started!</div>' +
	                     '<div style="font-size: 12px;">Add OpenAI, Groq, Claude, Gemini or any AI provider</div>' +
	                     '</div>';
	    } else {
	        // IMPROVED LAYOUT - SHOW ONLY API NAME & BUTTONS
	        for (var i = 0; i < customAPIs.length; i++) {
	            var api = customAPIs[i];
	            var toggleText = api.active ? '🟢' : '🔴';
	            var statusText = api.active ? 'Active' : 'Inactive';
	            var statusColor = api.active ? '#10B981' : '#6B7280';
            
	            apiListHTML += 
	                '<div style="border: 1px solid var(--mobile-border-color); border-radius: 8px; padding: 15px; margin-bottom: 12px; background: var(--modal-bg);">' +
	                    '<!-- CLEAN LAYOUT - API NAME & STATUS -->' +
	                    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">' +
	                        '<div style="flex: 1;">' +
	                            '<div style="font-weight: 600; color: var(--primary-text-color); font-size: 15px;">' + api.name + '</div>' +
	                            '<div style="font-size: 12px; color: ' + statusColor + '; margin-top: 3px;">' + statusText + '</div>' +
	                        '</div>' +
	                    '</div>' +
                    
	                    '<!-- BUTTONS ROW - WITH DATA ATTRIBUTES (NO INLINE ONCLICK) -->' +
	                    '<div style="display: flex; gap: 8px; flex-wrap: wrap;">' +
	                        '<button class="toggle-api-btn" data-index="' + i + '" style="background: ' + (api.active ? '#10B981' : '#EF4444') + '; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 12px; cursor: pointer; font-weight: 600; flex: 1; min-width: 70px;">' + toggleText + ' ' + (api.active ? 'ON' : 'OFF') + '</button>' +
	                        '<button class="edit-api-btn" data-index="' + i + '" style="background: #3B82F6; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 12px; cursor: pointer; font-weight: 600; flex: 1; min-width: 60px;">Edit</button>' +
	                        '<button class="delete-api-btn" data-index="' + i + '" style="background: #EF4444; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 12px; cursor: pointer; font-weight: 600; flex: 1; min-width: 60px;">Delete</button>' +
	                    '</div>' +
	                '</div>';
	        }
	    }
    
	    modalContent.innerHTML = 
	        '<div style="max-height: 450px; overflow-y: auto; padding: 10px;">' +
	            '<div style="background: linear-gradient(45deg, #8B5CF6, #06B6D4); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px;">' +
	                '<div style="font-weight: 600; font-size: 16px;">🤖 AI Manager</div>' +
	                '<div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">Add AI provider • Toggle On/Off • Manage</div>' +
	            '</div>' +
            
	            apiListHTML +
            
	            '<div style="margin-top: 20px; display: flex; gap: 10px;">' +
	                '<button id="add-new-api-btn" style="background: #10B981; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; flex: 1;">➕ Add API</button>' +
	                '<button id="done-api-btn" style="background: var(--mobile-border-color); color: var(--primary-text-color); border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">✅ Done</button>' +
	            '</div>' +
	        '</div>';
    
	    modal.className = 'custom-prompt-modal';
	    modalBackdrop.style.display = 'block';
	    modal.style.display = 'flex';
    
	    // PROPER EVENT LISTENERS - ALL WORKING
	    setTimeout(function() {
	        // Add New API button
	        document.getElementById('add-new-api-btn').onclick = function() {
	            showAddApiModal();
	        };
        
	        // Done button
	        document.getElementById('done-api-btn').onclick = function() {
	            hideModal();
	        };
        
	        // TOGGLE BUTTONS
	        var toggleButtons = document.querySelectorAll('.toggle-api-btn');
	        for (var i = 0; i < toggleButtons.length; i++) {
	            toggleButtons[i].onclick = function() {
	                var index = parseInt(this.getAttribute('data-index'));
	                toggleAPI(index);
	            };
	        }
        
	        // EDIT BUTTONS
	        var editButtons = document.querySelectorAll('.edit-api-btn');
	        for (var i = 0; i < editButtons.length; i++) {
	            editButtons[i].onclick = function() {
	                var index = parseInt(this.getAttribute('data-index'));
	                editAPI(index);
	            };
	        }
        
	        // DELETE BUTTONS
	        var deleteButtons = document.querySelectorAll('.delete-api-btn');
	        for (var i = 0; i < deleteButtons.length; i++) {
	            deleteButtons[i].onclick = function() {
	                var index = parseInt(this.getAttribute('data-index'));
	                deleteAPI(index);
	            };
	        }
	    }, 100);
	}

	// WORKING SAVE FUNCTION - FROM YOUR ORIGINAL CODE
	function saveNewAPI(editIndex) {
	    var name = document.getElementById('add-api-name').value.trim();
	    var url = document.getElementById('add-api-url').value.trim();
	    var key = document.getElementById('add-api-key').value.trim();
    
	    if (!name || !url || !key) {
	        showCustomAlert('❌ Missing Info', 'Please fill all required fields.');
	        return;
	    }
    
	    var apis = getCustomAPIs();
	    var newAPI = {
	        name: name,
	        url: url,
	        key: key,
	        active: true,
	        id: Date.now()
	    };
    
	    if (editIndex >= 0) {
	        // Edit existing API
	        apis[editIndex] = newAPI;
	    } else {
	        // Add new API
	        apis.push(newAPI);
	    }
    
	    saveCustomAPIs(apis);
	    showCustomAlert('✅ Saved!', name + ' has been saved!');
    
	    // Show API manager after save - THIS IS THE KEY!
	    setTimeout(function() {
	        showApiManagerModal();
	    }, 1500);
	}

	// FIXED MODAL BUTTONS HANDLER
	function setupModalButtons(editIndex, isEdit) {
	    // Test button
	    var testBtn = document.getElementById('test-new-api-btn');
	    if (testBtn) {
	        testBtn.onclick = function() {
	            testNewAPI();
	        };
	    }

	    // Save button
	    var saveBtn = document.getElementById('save-new-api-btn');
	    if (saveBtn) {
	        saveBtn.onclick = function() {
	            saveNewAPI(editIndex !== undefined ? editIndex : -1);
	        };
	    }

	    // Delete button (only in edit mode)
	    var deleteBtn = document.getElementById('delete-api-btn');
	    if (deleteBtn && isEdit) {
	        deleteBtn.onclick = function() {
	            if (confirm('Delete this API? This cannot be undone.')) {
	                var apis = getCustomAPIs();
	                apis.splice(editIndex, 1);
	                saveCustomAPIs(apis);
	                showApiManagerModal();
	                showCustomAlert('✅ Deleted!', 'API deleted successfully.');
	            }
	        };
	    }

	    // Cancel button - SIMPLE FIX
	    var cancelBtn = document.getElementById('cancel-new-api-btn');
	    if (cancelBtn) {
	        cancelBtn.onclick = function() {
	            hideModal();
	        };
	    }
	}
	
		

		function customAlert(title, message) {
		    showCustomAlert(title, message);
		}

		function customPrompt(title, message, placeholder, isPassword = false) {
		    return new Promise(function(resolve) {
		        var inputType = isPassword ? 'password' : 'text';
		        var content = '<div style="line-height: 1.5; margin-bottom: 15px;">' + message + '</div>' +
		            '<input type="' + inputType + '" id="modal-input" class="language-input" placeholder="' + placeholder + '">' +
		            '<div style="text-align: right; margin-top: 20px;">' +
		            '<button id="modal-cancel" class="modal-button secondary">Cancel</button>' +
		            '<button id="modal-ok" class="modal-button">OK</button>' +
		            '</div>';
		        showModal(title, content);
        
		        var input = document.getElementById('modal-input');
		        input.focus();
        
				var handleOk = function() {
				    var value = input.value.trim();
				    hideModal();
				    resolve(value || null);
				};
        
        
		        var handleCancel = function() {
		            hideModal();
		            resolve(null);
		        };
        
		        document.getElementById('modal-ok').onclick = handleOk;
		        document.getElementById('modal-cancel').onclick = handleCancel;
        
		        input.addEventListener('keydown', function(e) {
		            if (e.key === 'Enter') handleOk();
		            if (e.key === 'Escape') handleCancel();
		        });
		    });
		}

		function customConfirm(title, message) {
		    return new Promise(function(resolve) {
		        modalTitle.textContent = title;
		        modalContent.innerHTML = '<div style="padding: 10px 0; line-height: 1.5;">' + message + '</div>' +
		            '<div style="text-align: right; margin-top: 20px;">' +
		            '<button id="confirm-cancel" class="modal-button secondary">Cancel</button>' +
		            '<button id="confirm-delete" class="modal-button" style="background: #ff4444; color: white;">Delete</button>' +
		            '</div>';
		        modal.className = 'custom-alert-modal';
		        modalBackdrop.style.display = 'block';
		        modal.style.display = 'flex';
        
		        setTimeout(() => {
		            var deleteBtn = document.getElementById('confirm-delete');
		            var cancelBtn = document.getElementById('confirm-cancel');
            
		            if (deleteBtn) {
		                deleteBtn.onclick = function() {
		                    hideModal();
		                    resolve(true);
		                };
		            }
            
		            if (cancelBtn) {
		                cancelBtn.onclick = function() {
		                    hideModal();
		                    resolve(false);
		                };
		            }
		        }, 50);
		    });
		}

		function closeAllMenus() {
		    // Close all popup menus
		    document.querySelectorAll('.popup-menu.show').forEach(function(m) {
		        m.classList.remove('show');
		    });
    
		    // ✅ CLOSE MAIN MENU AND UPDATE FLAG
		    var mainMenu = document.getElementById('mobile-slider-menu');
		    if (mainMenu) {
		        mainMenu.classList.remove('show');
		        window.wraiterMenuOpen = false; // ✅ UPDATE FLAG
		    }
		}


		function saveToStorage(id, data) {
		    var files = JSON.parse(localStorage.getItem('wraiterFiles') || '{}');
		    files[id] = {
		        id: data.id || id,
		        content: data.content || '',
		        text: data.text || '',
		        title: data.title || 'Untitled',
		        lastModified: data.lastModified || new Date().toISOString(),
		        tags: data.tags || [],
		        folder: data.folder || 'All Documents'
		    };
		    localStorage.setItem('wraiterFiles', JSON.stringify(files));
		}
		

		function getAllFiles() {
		    return JSON.parse(localStorage.getItem('wraiterFiles') || '{}');
		}

		function deleteFile(fileId) {
		    customConfirm('Delete Document', 'Are you sure you want to delete this document?').then(function(confirmed) {
		        if (confirmed) {
		            var files = getAllFiles();
		            delete files[fileId];
		            localStorage.setItem('wraiterFiles', JSON.stringify(files));
		            loadFileLibrary();
		        }
		    });
		}

		function deleteAiResult(resultId) {
		    customConfirm('Delete AI Result', 'Are you sure you want to delete this AI result?').then(function(confirmed) {
		        if (confirmed) {
		            aiResults = aiResults.filter(function(result) {
		                return result.id !== resultId;
		            });
            
		            localStorage.setItem('wraiterAiResults', JSON.stringify(aiResults.slice(0, 20)));
            
		            if (aiResults.length > 0) {
		                displayAiHistory();
		                updateAiStatus('has-results');
		            } else {
		                aiPanelContent.innerHTML = '<div style="padding: 40px; text-align: center; opacity: 0.7; font-size: 16px;">No AI results yet.<br><br>Use AI tools to generate content.</div>';
		                updateAiStatus('');
		            }
		        }
		    });
		}

		window.deleteAiResult = deleteAiResult;

		var ultraDebouncedAutoSave = ultraDebounce(function() {
		    if (isAutoSaving || !currentDocumentId) return;
		    isAutoSaving = true;
		    var text = editor.innerText;
		    if (text.trim()) {
		        // Extract hashtags from text ONLY when saving (not on every keystroke)
		        var detectedTags = extractHashtagsFromText(text);
		        currentTags = detectedTags; // Replace tags completely
        
		        saveToStorage(currentDocumentId, {
		            id: currentDocumentId,
		            content: editor.innerHTML,
		            text: text,
		            title: text.split('\n')[0].substring(0, 50) || 'Untitled',
		            lastModified: new Date().toISOString(),
		            tags: currentTags,
		            folder: currentFolder
		        });
		    }
		    isAutoSaving = false;
		}, 2000);
		

		function autoSaveCurrentDocument() {
		    ultraDebouncedAutoSave();
		}

		function createNewDocument() {
		    currentDocumentId = generateId();
		    editor.innerHTML = '';
		    editor.focus();
		    history = [''];
		    historyIndex = 0;
		    saveToStorage(currentDocumentId, {
		        id: currentDocumentId,
		        content: '',
		        text: '',
		        title: 'New Document',
		        lastModified: new Date().toISOString()
		    });
		}
		
		function getAllTags() {
		    var files = getAllFiles();
		    var tagSet = {};
		    Object.values(files).forEach(function(file) {
		        if (file.tags && file.tags.length > 0) {
		            file.tags.forEach(function(tag) {
		                tagSet[tag] = true;
		            });
		        }
		    });
		    return Object.keys(tagSet).sort();
		}
		
		window.showTagEditor = showTagEditor;

		function getAllFolders() {
		    var foldersData = getAllFoldersData();
		    return Object.keys(foldersData).sort();
		}
		
	
		
		// Store folders separately from documents
		function getAllFoldersData() {
		    return JSON.parse(localStorage.getItem('wraiterFolders') || '{"All Documents": {"id": "all", "name": "All Documents", "created": ""}}');
		}

		function saveFoldersData(folders) {
		    localStorage.setItem('wraiterFolders', JSON.stringify(folders));
		}

		function createNewFolder() {
		    customPrompt('Create Folder', 'Enter folder name:', '')
		        .then(function(folderName) {
		            if (folderName && folderName.trim()) {
		                var folders = getAllFoldersData();
		                var folderId = 'folder_' + Date.now();
                
		                if (folders[folderName.trim()]) {
		                    showCustomAlert('Error', 'Folder already exists!');
		                    return;
		                }
                
		                folders[folderName.trim()] = {
		                    id: folderId,
		                    name: folderName.trim(),
		                    created: new Date().toISOString()
		                };
                
		                saveFoldersData(folders);
                
		                // Force refresh library
		                setTimeout(function() {
		                    loadFileLibrary();
		                }, 200);
                
		                showCustomAlert('Folder Created', 'Folder "' + folderName.trim() + '" has been created');
		            }
		        });
		}
		

		function deleteFolder(folderName) {
		    if (folderName === 'All Documents') {
		        showCustomAlert('Error', 'Cannot delete default folder');
		        return;
		    }
    
		    var files = getAllFiles();
		    var filesInFolder = Object.values(files).filter(function(f) {
		        return (f.folder || 'All Documents') === folderName;
		    });
    
		    if (filesInFolder.length > 0) {
		        showCustomAlert('Error', 'Cannot delete folder with documents. Move or delete documents first.');
		        return;
		    }
    
		    var folders = getAllFoldersData();
		    delete folders[folderName];
		    saveFoldersData(folders);
		    loadFileLibrary();
		    showCustomAlert('Folder Deleted', 'Folder "' + folderName + '" has been deleted');
		}

		function renameFolder(oldName) {
		    if (oldName === 'All Documents') {
		        showCustomAlert('Error', 'Cannot rename default folder');
		        return;
		    }
    
		    customPrompt('Rename Folder', 'Enter new folder name:', oldName)
		        .then(function(newName) {
		            if (newName && newName.trim() && newName.trim() !== oldName) {
		                var folders = getAllFoldersData();
                
		                if (folders[newName.trim()]) {
		                    showCustomAlert('Error', 'Folder name already exists!');
		                    return;
		                }
                
		                folders[newName.trim()] = folders[oldName];
		                folders[newName.trim()].name = newName.trim();
		                delete folders[oldName];
		                saveFoldersData(folders);
                
		                // Update all documents in this folder
		                var files = getAllFiles();
		                Object.values(files).forEach(function(file) {
		                    if ((file.folder || 'All Documents') === oldName) {
		                        file.folder = newName.trim();
		                        saveToStorage(file.id, file);
		                    }
		                });
                
		                loadFileLibrary();
		                showCustomAlert('Folder Renamed', 'Folder renamed to "' + newName.trim() + '"');
		            }
		        });
		}

		function moveDocumentToFolder(docId, targetFolder) {
		    var files = getAllFiles();
		    var doc = files[docId];
		    if (doc) {
		        doc.folder = targetFolder;
		        saveToStorage(docId, doc);
		        loadFileLibrary();
		    }
		}

		window.createNewFolder = createNewFolder;
		window.deleteFolder = deleteFolder;
		window.renameFolder = renameFolder;
		window.moveDocumentToFolder = moveDocumentToFolder;
		
		

		function showTagEditor() {
		    var allTags = getAllTags();
		    var files = getAllFiles();
    
		    if (allTags.length === 0) {
		        showCustomAlert('No Tags', 'No tags found. Add hashtags (e.g., #work) in your documents to create tags.');
		        return;
		    }
    
		    // Clear library content and show tag manager
		    fileLibraryContent.innerHTML = '';
    
		    // Back button header
		    var header = document.createElement('div');
		    header.style.cssText = 'padding: 15px; background: var(--modal-bg); border-bottom: 1px solid var(--mobile-border-color); position: sticky; top: 0; z-index: 10;';
    
		    var titleDiv = document.createElement('div');
		    titleDiv.style.cssText = 'font-size: 18px; font-weight: 600; color: var(--primary-text-color); margin-bottom: 10px;';
		    titleDiv.textContent = 'Tag Manager';
		    header.appendChild(titleDiv);
    
		    var backBtn = document.createElement('button');
		    backBtn.textContent = '← Back to Library';
		    backBtn.style.cssText = 'background: #6B7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer;';
		    backBtn.onclick = function() { 
		        loadFileLibrary(); 
		    };
		    header.appendChild(backBtn);
    
		    fileLibraryContent.appendChild(header);
    
		    // Tag list
		    allTags.forEach(function(tag) {
		        var taggedDocs = Object.values(files).filter(function(f) {
		            return f.tags && f.tags.includes(tag);
		        });
        
		        var tagItem = document.createElement('div');
		        tagItem.style.cssText = 'padding: 15px; border-bottom: 1px solid var(--mobile-border-color); background: var(--modal-bg);';
        
		        var tagHeader = document.createElement('div');
		        tagHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;';
        
		        var tagName = document.createElement('div');
		        tagName.style.cssText = 'font-weight: 600; font-size: 16px; color: var(--primary-text-color);';
		        tagName.innerHTML = '<span style="color: #10B981;">#' + tag + '</span> <span style="color: var(--secondary-text-color); font-size: 14px; font-weight: normal;">(' + taggedDocs.length + ' docs)</span>';
		        tagHeader.appendChild(tagName);
        
		        var exportBtn = document.createElement('button');
		        exportBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 16px;">download</span>';
		        exportBtn.style.cssText = 'background: #4285F4; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 12px;';
		        exportBtn.onclick = function() {
		            exportTaggedDocuments(tag);
		        };
		        tagHeader.appendChild(exportBtn);
        
		        tagItem.appendChild(tagHeader);
        
		        // Document list
		        var docList = document.createElement('div');
		        docList.style.cssText = 'font-size: 13px; color: var(--secondary-text-color); padding-left: 8px;';
		        taggedDocs.forEach(function(doc) {
		            var docItem = document.createElement('div');
		            docItem.style.cssText = 'padding: 4px 0; cursor: pointer;';
		            docItem.textContent = '• ' + doc.title;
		            docItem.onclick = function() {
		                currentDocumentId = doc.id;
		                currentTags = doc.tags || [];
		                currentFolder = doc.folder || 'All Documents';
		                editor.innerHTML = doc.content;
		                document.body.classList.remove('library-visible');
		                history = [editor.innerHTML];
		                historyIndex = 0;
		            };
		            docList.appendChild(docItem);
		        });
		        tagItem.appendChild(docList);
        
		        fileLibraryContent.appendChild(tagItem);
		    });
		}

		function exportTaggedDocuments(tag) {
		    var files = getAllFiles();
		    var taggedDocs = Object.values(files).filter(function(f) {
		        return f.tags && f.tags.includes(tag);
		    }).sort(function(a, b) {
		        return new Date(a.lastModified) - new Date(b.lastModified);
		    });
    
		    if (taggedDocs.length === 0) {
		        showCustomAlert('No Documents', 'No documents found with tag #' + tag);
		        return;
		    }
    
		    // Combine all documents
		    var combinedText = '# Documents tagged with #' + tag + '\n\n';
		    combinedText += 'Generated: ' + new Date().toLocaleString() + '\n';
		    combinedText += 'Total documents: ' + taggedDocs.length + '\n\n';
		    combinedText += '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n';
    
		    taggedDocs.forEach(function(doc, index) {
		        combinedText += '## Document ' + (index + 1) + ': ' + doc.title + '\n\n';
		        combinedText += doc.text + '\n\n';
		        combinedText += '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n';
		    });
    
		    // Create downloadable text file
		    var blob = new Blob([combinedText], { type: 'text/plain' });
		    var url = URL.createObjectURL(blob);
		    var a = document.createElement('a');
		    a.href = url;
		    a.download = 'tag_' + tag + '_' + Date.now() + '.txt';
		    document.body.appendChild(a);
		    a.click();
		    document.body.removeChild(a);
		    URL.revokeObjectURL(url);
    
		    showCustomAlert('Exported', 'All documents with tag #' + tag + ' have been exported');
		}

		window.showTagEditor = showTagEditor;
		window.exportTaggedDocuments = exportTaggedDocuments;
		

		function showFolderEditor() {
		    // Must have an open document first
		    if (!currentDocumentId) {
		        showCustomAlert('No Document', 'Please open or create a document first before assigning a folder.');
		        return;
		    }
    
		    var folders = getAllFolders();
		    var folderList = folders.length > 0 ? '\n\nExisting folders:\n• ' + folders.join('\n• ') : '';
    
		    customPrompt('Change Folder', 'Enter folder name (or select from existing)' + folderList, currentFolder)
		        .then(function(input) {
		            if (input !== null && input.trim()) {
		                currentFolder = input.trim();
                
		                // Get current document
		                var files = JSON.parse(localStorage.getItem('wraiterFiles') || '{}');
		                var currentDoc = files[currentDocumentId] || {};
                
		                // Update with new folder
		                files[currentDocumentId] = {
		                    id: currentDocumentId,
		                    content: currentDoc.content || editor.innerHTML,
		                    text: currentDoc.text || editor.innerText,
		                    title: currentDoc.title || editor.innerText.split('\n')[0].substring(0, 50) || 'Untitled',
		                    lastModified: new Date().toISOString(),
		                    tags: currentTags || [],
		                    folder: currentFolder
		                };
                
		                // Save immediately
		                localStorage.setItem('wraiterFiles', JSON.stringify(files));
                
		                // Force refresh library if open
		                if (document.body.classList.contains('library-visible')) {
		                    setTimeout(function() {
		                        loadFileLibrary();
		                    }, 100);
		                }
                
		                showCustomAlert('Folder Changed', 'Document moved to: ' + currentFolder);
		            }
		        });
		}
		
		
		window.showFolderEditor = showFolderEditor;
		
		
		function editDocumentTitle(fileId) {
		    var files = getAllFiles();
		    var file = files[fileId];
		    if (!file) return;
    
		    customPrompt('Edit Title', 'Enter new title for this document', file.title)
		        .then(function(newTitle) {
		            if (newTitle !== null && newTitle.trim()) {
		                file.title = newTitle.trim();
		                saveToStorage(fileId, file);
		                loadFileLibrary();
		                showCustomAlert('Title Updated', 'Document title has been changed');
		            }
		        });
		}

		window.editDocumentTitle = editDocumentTitle;
		
		 
		function loadFileLibrary() {
		    var files = getAllFiles();
		    var folders = getAllFoldersData();
		    fileLibraryContent.innerHTML = '';
    
		    var totalDocs = Object.keys(files).length;
    
		    // Group files by folder - include ALL folders (even empty ones)
		    var grouped = {};

		    // First, add all folders from folder storage
		    Object.keys(folders).forEach(function(folderName) {
		        grouped[folderName] = [];
		    });

		    // Then add documents to their folders
		    Object.values(files).forEach(function(file) {
		        var folder = file.folder || 'All Documents';
		        if (!grouped[folder]) grouped[folder] = [];
		        grouped[folder].push(file);
		    });

		    // Display each folder section
		    Object.keys(grouped).sort().forEach(function(folderName) {
		        var folderFiles = grouped[folderName].sort(function(a, b) {
		            return new Date(b.lastModified) - new Date(a.lastModified);
		        });
        
		        // Folder header with hover actions
		        var folderHeader = document.createElement('div');
		        folderHeader.style.cssText = 'padding: 12px 15px; background: var(--modal-bg); border-bottom: 1px solid var(--mobile-border-color); font-weight: 600; font-size: 14px; color: var(--primary-text-color); position: sticky; top: 0; z-index: 9; display: flex; justify-content: space-between; align-items: center; cursor: pointer;';
		        folderHeader.setAttribute('data-folder', folderName);
        
		        var folderTitle = document.createElement('div');
		        folderTitle.innerHTML = '<span class="folder-arrow">▼</span><span style="margin-right: 8px;">📁</span>' + folderName + ' (' + folderFiles.length + ')';
		        folderHeader.appendChild(folderTitle);
        
		        // Folder action buttons (hidden by default, show on hover)
		        if (folderName !== 'All Documents') {
		            var folderActions = document.createElement('div');
		            folderActions.style.cssText = 'display: none; gap: 6px;';
		            folderActions.className = 'folder-actions';
            
		            // SAVE/EXPORT BUTTON
		            var saveBtn = document.createElement('button');
		            saveBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 18px;">download</span>';
		            saveBtn.style.cssText = 'background: #10B981; color: white; border: none; border-radius: 4px; cursor: pointer; padding: 4px 8px;';
		            saveBtn.title = 'Export as Book';
		            saveBtn.onclick = function(e) {
		                e.stopPropagation();
		                exportFolderAsBook(folderName);
		            };
		            folderActions.appendChild(saveBtn);
            
		            // RENAME BUTTON
		            var renameBtn = document.createElement('button');
		            renameBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 18px;">edit</span>';
		            renameBtn.style.cssText = 'background: #4285F4; color: white; border: none; border-radius: 4px; cursor: pointer; padding: 4px 8px;';
		            renameBtn.title = 'Rename Folder';
		            renameBtn.onclick = function(e) {
		                e.stopPropagation();
		                renameFolder(folderName);
		            };
		            folderActions.appendChild(renameBtn);
            
		            // DELETE BUTTON
		            var deleteBtn = document.createElement('button');
		            deleteBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 18px;">delete</span>';
		            deleteBtn.style.cssText = 'background: #EF4444; color: white; border: none; border-radius: 4px; cursor: pointer; padding: 4px 8px;';
		            deleteBtn.title = 'Delete Folder';
		            deleteBtn.onclick = function(e) {
		                e.stopPropagation();
		                deleteFolder(folderName);
		            };
		            folderActions.appendChild(deleteBtn);
            
		            folderHeader.appendChild(folderActions);
            
		            // Show buttons on hover
		            folderHeader.onmouseenter = function() {
		                folderActions.style.display = 'flex';
		            };
		            folderHeader.onmouseleave = function() {
		                folderActions.style.display = 'none';
		            };
		        }
        
		        // Create folder content container
		        var folderContentDiv = document.createElement('div');
		        folderContentDiv.className = 'folder-content';
        
		        // Toggle folder on click (only when clicking title, not buttons)
		        folderHeader.onclick = function(e) {
		            if (e.target.closest('button')) return; // Don't toggle if clicking buttons
            
		            var arrow = folderTitle.querySelector('.folder-arrow');
		            if (folderContentDiv.classList.contains('collapsed')) {
		                folderContentDiv.classList.remove('collapsed');
		                arrow.classList.remove('collapsed');
		            } else {
		                folderContentDiv.classList.add('collapsed');
		                arrow.classList.add('collapsed');
		            }
		        };
        
		        // Make folder header a drop zone for drag-and-drop
		        folderHeader.setAttribute('draggable', 'false');
		        folderHeader.ondragover = function(e) {
		            e.preventDefault();
		            this.style.background = '#4285F4';
		            this.style.color = 'white';
		        };
		        folderHeader.ondragleave = function(e) {
		            this.style.background = 'var(--modal-bg)';
		            this.style.color = 'var(--primary-text-color)';
		        };
		        folderHeader.ondrop = function(e) {
		            e.preventDefault();
		            this.style.background = 'var(--modal-bg)';
		            this.style.color = 'var(--primary-text-color)';
		            var docId = e.dataTransfer.getData('docId');
		            if (docId) {
		                moveDocumentToFolder(docId, folderName);
		            }
		        };
        
		        fileLibraryContent.appendChild(folderHeader);
        
		        // Files in this folder with drag support and hover actions
				// Files in this folder with drag support and touch-friendly actions
				folderFiles.forEach(function(file) {
				    var fileItem = document.createElement('div');
				    fileItem.style.cssText = 'padding: 12px 15px; border-bottom: 1px solid var(--mobile-border-color); cursor: pointer; background: var(--modal-bg); position: relative;';
				    fileItem.setAttribute('draggable', 'true');
				    fileItem.setAttribute('data-doc-id', file.id);
    
				    // Drag events (works on desktop only)
				    fileItem.ondragstart = function(e) {
				        e.dataTransfer.setData('docId', file.id);
				        this.style.opacity = '0.5';
				    };
				    fileItem.ondragend = function(e) {
				        this.style.opacity = '1';
				    };
    
				    var contentDiv = document.createElement('div');
				    contentDiv.style.paddingRight = '80px';
    
				    var titleDiv = document.createElement('div');
				    titleDiv.style.cssText = 'font-weight: 500; font-size: 15px; color: var(--primary-text-color); margin-bottom: 4px;';
				    titleDiv.textContent = file.title;
				    contentDiv.appendChild(titleDiv);
    
				    var metaDiv = document.createElement('div');
				    metaDiv.style.cssText = 'display: flex; align-items: center; gap: 8px; flex-wrap: wrap;';
    
				    if (file.tags && file.tags.length > 0) {
				        file.tags.forEach(function(tag) {
				            var tagSpan = document.createElement('span');
				            tagSpan.textContent = '#' + tag;
				            tagSpan.style.cssText = 'background: #E8F5E9; color: #2E7D32; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500;';
				            metaDiv.appendChild(tagSpan);
				        });
				    }
    
				    var dateSpan = document.createElement('span');
				    dateSpan.style.cssText = 'font-size: 12px; color: var(--secondary-text-color);';
				    dateSpan.textContent = new Date(file.lastModified).toLocaleDateString();
				    metaDiv.appendChild(dateSpan);
    
				    contentDiv.appendChild(metaDiv);
				    fileItem.appendChild(contentDiv);
    
				    // Document action buttons (hidden by default)
				    var docActions = document.createElement('div');
				    docActions.style.cssText = 'position: absolute; top: 12px; right: 12px; display: none; gap: 6px;';
				    docActions.className = 'doc-actions';
    
				    var editBtn = document.createElement('button');
				    editBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 18px;">edit</span>';
				    editBtn.style.cssText = 'background: #4285F4; color: white; border: none; border-radius: 4px; cursor: pointer; padding: 4px 8px;';
				    editBtn.title = 'Edit Title';
				    editBtn.onclick = function(e) {
				        e.stopPropagation();
				        editDocumentTitle(file.id);
				    };
				    docActions.appendChild(editBtn);
    
				    var deleteBtn = document.createElement('button');
				    deleteBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 18px;">delete</span>';
				    deleteBtn.style.cssText = 'background: #EF4444; color: white; border: none; border-radius: 4px; cursor: pointer; padding: 4px 8px;';
				    deleteBtn.title = 'Delete Document';
				    deleteBtn.onclick = function(e) {
				        e.stopPropagation();
				        deleteFile(file.id);
				    };
				    docActions.appendChild(deleteBtn);
    
				    fileItem.appendChild(docActions);
    
				    // Track if buttons are visible
				    var buttonsVisible = false;
    
				    // Desktop: Show buttons on hover
				    fileItem.onmouseenter = function() {
				        docActions.style.display = 'flex';
				        buttonsVisible = true;
				    };
				    fileItem.onmouseleave = function() {
				        docActions.style.display = 'none';
				        buttonsVisible = false;
				    };
    
				    // Mobile: Toggle buttons on tap, open doc on double tap
				    var tapCount = 0;
				    var tapTimer;
    
				    fileItem.onclick = function(e) {
				        if (e.target.closest('button')) return;
        
				        tapCount++;
        
				        if (tapCount === 1) {
				            // First tap: Show buttons
				            tapTimer = setTimeout(function() {
				                if (buttonsVisible) {
				                    // If buttons already visible, open document
				                    currentDocumentId = file.id;
				                    currentTags = file.tags || [];
				                    currentFolder = file.folder || 'All Documents';
				                    editor.innerHTML = file.content;
				                    document.body.classList.remove('library-visible');
				                    history = [editor.innerHTML];
				                    historyIndex = 0;
				                } else {
				                    // Show buttons
				                    docActions.style.display = 'flex';
				                    buttonsVisible = true;
				                }
				                tapCount = 0;
				            }, 300);
				        } else if (tapCount === 2) {
				            // Double tap: Open document immediately
				            clearTimeout(tapTimer);
				            currentDocumentId = file.id;
				            currentTags = file.tags || [];
				            currentFolder = file.folder || 'All Documents';
				            editor.innerHTML = file.content;
				            document.body.classList.remove('library-visible');
				            history = [editor.innerHTML];
				            historyIndex = 0;
				            tapCount = 0;
				        }
				    };
    
				    // Hide buttons when tapping outside
				    document.addEventListener('click', function(e) {
				        if (!fileItem.contains(e.target)) {
				            docActions.style.display = 'none';
				            buttonsVisible = false;
				        }
				    });
    
				    folderContentDiv.appendChild(fileItem);
				});
		        
    
		    // Document summary at bottom
		    var summaryDiv = document.createElement('div');
		    summaryDiv.style.cssText = 'padding: 15px; text-align: center; color: var(--secondary-text-color); font-size: 12px; border-top: 1px solid var(--mobile-border-color); background: var(--modal-bg);';
		    summaryDiv.textContent = totalDocs + ' document' + (totalDocs !== 1 ? 's' : '') + ' in ' + Object.keys(grouped).length + ' folder' + (Object.keys(grouped).length !== 1 ? 's' : '');
		    fileLibraryContent.appendChild(summaryDiv);
		}
		
		
		
		function filterByTag(tagName) {
		    var files = getAllFiles();
		    fileLibraryContent.innerHTML = '';
    
		    var headerDiv = document.createElement('div');
		    headerDiv.style.cssText = 'padding: 15px; background: var(--modal-bg); border-bottom: 1px solid var(--mobile-border-color);';
    
		    var titleDiv = document.createElement('div');
		    titleDiv.style.cssText = 'font-size: 18px; font-weight: 600; color: var(--primary-text-color); margin-bottom: 10px;';
		    titleDiv.textContent = 'Tag: #' + tagName;
		    headerDiv.appendChild(titleDiv);
    
		    var backBtn = document.createElement('button');
		    backBtn.textContent = '← Back to All';
		    backBtn.style.cssText = 'background: #6B7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer;';
		    backBtn.onclick = function() { 
		        loadFileLibrary(); 
		    };
		    headerDiv.appendChild(backBtn);
    
		    fileLibraryContent.appendChild(headerDiv);
    
		    var filtered = Object.values(files).filter(function(file) {
		        return file.tags && file.tags.includes(tagName);
		    }).sort(function(a, b) {
		        return new Date(b.lastModified) - new Date(a.lastModified);
		    });
    
		    if (filtered.length === 0) {
		        var emptyDiv = document.createElement('div');
		        emptyDiv.style.cssText = 'padding: 40px 20px; text-align: center; color: var(--secondary-text-color);';
		        emptyDiv.textContent = 'No documents with this tag';
		        fileLibraryContent.appendChild(emptyDiv);
		        return;
		    }
    
		    filtered.forEach(function(file) {
		        var fileItem = document.createElement('div');
		        fileItem.style.cssText = 'padding: 12px 15px; border-bottom: 1px solid var(--mobile-border-color); cursor: pointer; background: var(--modal-bg); position: relative;';
        
		        var contentDiv = document.createElement('div');
		        contentDiv.style.paddingRight = '80px';
        
		        var titleDiv = document.createElement('div');
		        titleDiv.style.cssText = 'font-weight: 500; font-size: 15px; color: var(--primary-text-color);';
		        titleDiv.textContent = file.title;
		        contentDiv.appendChild(titleDiv);
        
		        var dateDiv = document.createElement('div');
		        dateDiv.style.cssText = 'font-size: 12px; color: var(--secondary-text-color); margin-top: 4px;';
		        dateDiv.textContent = new Date(file.lastModified).toLocaleDateString();
		        contentDiv.appendChild(dateDiv);
        
		        fileItem.appendChild(contentDiv);
        
		        var editBtn = document.createElement('button');
		        editBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 18px;">edit</span>';
		        editBtn.style.cssText = 'position: absolute; top: 12px; right: 45px; background: none; border: none; color: var(--secondary-text-color); cursor: pointer; opacity: 0.6; padding: 4px;';
		        editBtn.onclick = function(e) {
		            e.stopPropagation();
		            editDocumentTitle(file.id);
		        };
		        fileItem.appendChild(editBtn);
        
		        var deleteBtn = document.createElement('button');
		        deleteBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 18px;">delete</span>';
		        deleteBtn.style.cssText = 'position: absolute; top: 12px; right: 12px; background: none; border: none; color: var(--secondary-text-color); cursor: pointer; opacity: 0.6; padding: 4px;';
		        deleteBtn.onclick = function(e) {
		            e.stopPropagation();
		            deleteFile(file.id);
		        };
		        fileItem.appendChild(deleteBtn);
        
		        fileItem.onclick = function() {
		            currentDocumentId = file.id;
		            currentTags = file.tags || [];
		            currentFolder = file.folder || 'All Documents';
		            editor.innerHTML = file.content;
		            document.body.classList.remove('library-visible');
		            history = [editor.innerHTML];
		            historyIndex = 0;
		        };
        
		        fileLibraryContent.appendChild(fileItem);
		    });
		}
		
		
		function filterByFolder(folderName) {
		    var files = getAllFiles();
		    fileLibraryContent.innerHTML = '';
    
		    var headerDiv = document.createElement('div');
		    headerDiv.style.cssText = 'padding: 15px; background: var(--modal-bg); border-bottom: 1px solid var(--mobile-border-color);';
    
		    var titleDiv = document.createElement('div');
		    titleDiv.style.cssText = 'font-size: 18px; font-weight: 600; color: var(--primary-text-color); margin-bottom: 10px;';
		    titleDiv.textContent = '📁 ' + folderName;
		    headerDiv.appendChild(titleDiv);
    
		    var backBtn = document.createElement('button');
		    backBtn.textContent = '← Back to All';
		    backBtn.style.cssText = 'background: #6B7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer;';
		    backBtn.onclick = function() { 
		        loadFileLibrary(); 
		    };
		    headerDiv.appendChild(backBtn);
    
		    fileLibraryContent.appendChild(headerDiv);
    
		    var filtered = Object.values(files).filter(function(file) {
		        return (file.folder || 'All Documents') === folderName;
		    }).sort(function(a, b) {
		        return new Date(b.lastModified) - new Date(a.lastModified);
		    });
    
		    filtered.forEach(function(file) {
		        var fileItem = document.createElement('div');
		        fileItem.style.cssText = 'padding: 12px 15px; border-bottom: 1px solid var(--mobile-border-color); cursor: pointer; background: var(--modal-bg); position: relative;';
        
		        var contentDiv = document.createElement('div');
		        contentDiv.style.paddingRight = '80px';
        
		        var titleDiv = document.createElement('div');
		        titleDiv.style.cssText = 'font-weight: 500; font-size: 15px; color: var(--primary-text-color);';
		        titleDiv.textContent = file.title;
		        contentDiv.appendChild(titleDiv);
        
		        if (file.tags && file.tags.length > 0) {
		            var tagsDiv = document.createElement('div');
		            tagsDiv.style.cssText = 'margin-top: 4px;';
		            file.tags.forEach(function(tag) {
		                var tagSpan = document.createElement('span');
		                tagSpan.textContent = '#' + tag;
		                tagSpan.style.cssText = 'background: #E8F5E9; color: #2E7D32; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-right: 4px;';
		                tagsDiv.appendChild(tagSpan);
		            });
		            contentDiv.appendChild(tagsDiv);
		        }
        
		        var dateDiv = document.createElement('div');
		        dateDiv.style.cssText = 'font-size: 12px; color: var(--secondary-text-color); margin-top: 4px;';
		        dateDiv.textContent = new Date(file.lastModified).toLocaleDateString();
		        contentDiv.appendChild(dateDiv);
        
		        fileItem.appendChild(contentDiv);
        
		        var editBtn = document.createElement('button');
		        editBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 18px;">edit</span>';
		        editBtn.style.cssText = 'position: absolute; top: 12px; right: 45px; background: none; border: none; color: var(--secondary-text-color); cursor: pointer; opacity: 0.6; padding: 4px;';
		        editBtn.onclick = function(e) {
		            e.stopPropagation();
		            editDocumentTitle(file.id);
		        };
		        fileItem.appendChild(editBtn);
        
		        var deleteBtn = document.createElement('button');
		        deleteBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 18px;">delete</span>';
		        deleteBtn.style.cssText = 'position: absolute; top: 12px; right: 12px; background: none; border: none; color: var(--secondary-text-color); cursor: pointer; opacity: 0.6; padding: 4px;';
		        deleteBtn.onclick = function(e) {
		            e.stopPropagation();
		            deleteFile(file.id);
		        };
		        fileItem.appendChild(deleteBtn);
        
		        fileItem.onclick = function() {
		            currentDocumentId = file.id;
		            currentTags = file.tags || [];
		            currentFolder = file.folder || 'All Documents';
		            editor.innerHTML = file.content;
		            document.body.classList.remove('library-visible');
		            history = [editor.innerHTML];
		            historyIndex = 0;
		        };
        
		        fileLibraryContent.appendChild(fileItem);
		    });
		}
		
		window.filterByTag = filterByTag;
		window.filterByFolder = filterByFolder;
		
		function extractHashtagsFromText(text) {
		    var hashtags = [];
		    // Match hashtags followed by space, newline, punctuation, or end of string
		    var regex = /#(\w+)(?=\s|$|\n|[.,!?;:])/g;
		    var match;
    
		    while ((match = regex.exec(text)) !== null) {
		        var tag = match[1];
		        if (hashtags.indexOf(tag) === -1) {
		            hashtags.push(tag);
		        }
		    }
    
		    return hashtags;
		}
		

		function updateTagsFromEditor() {
		    if (!currentDocumentId) return;
    
		    var text = editor.innerText;
		    var detectedTags = extractHashtagsFromText(text);
    
		    // Merge with existing tags
		    detectedTags.forEach(function(tag) {
		        if (currentTags.indexOf(tag) === -1) {
		            currentTags.push(tag);
		        }
		    });
    
		    // Auto-save with updated tags
		    if (currentTags.length > 0) {
		        ultraDebouncedAutoSave();
		    }
		}
		
		function exportFolderAsBook(folderName) {
		    var files = getAllFiles();
		    var folderDocs = Object.values(files).filter(function(f) {
		        return (f.folder || 'All Documents') === folderName;
		    }).sort(function(a, b) {
		        return new Date(a.lastModified) - new Date(b.lastModified);
		    });
    
		    if (folderDocs.length === 0) {
		        showCustomAlert('Empty Folder', 'No documents found in folder "' + folderName + '"');
		        return;
		    }
    
		    // Combine all documents as chapters
		    var bookText = '# ' + folderName + '\n\n';
		    bookText += 'Generated: ' + new Date().toLocaleString() + '\n';
		    bookText += 'Total Chapters: ' + folderDocs.length + '\n\n';
		    bookText += '═══════════════════════════════════════════════════════\n\n';
    
		    folderDocs.forEach(function(doc, index) {
		        bookText += '## Chapter ' + (index + 1) + ': ' + doc.title + '\n\n';
		        bookText += doc.text + '\n\n';
		        bookText += '═══════════════════════════════════════════════════════\n\n';
		    });
    
		    // Create downloadable text file
		    var blob = new Blob([bookText], { type: 'text/plain' });
		    var url = URL.createObjectURL(blob);
		    var a = document.createElement('a');
		    a.href = url;
		    a.download = folderName.replace(/[^a-z0-9]/gi, '_') + '_book_' + Date.now() + '.txt';
		    document.body.appendChild(a);
		    a.click();
		    document.body.removeChild(a);
		    URL.revokeObjectURL(url);
    
		    showCustomAlert('Book Exported', 'All documents in "' + folderName + '" have been exported as chapters');
		}

		window.exportFolderAsBook = exportFolderAsBook;
		

		function getWorkingPrompt(task, textToProcess, customInstruction) {
		    var workingPrompts = {
		        'ai-suggest': 'Based on the following text, provide 5 short, numbered suggestions for what could come next. Respond only with the list.\n\n' + textToProcess,
		        'ai-proofread': 'Proofread the following text for any errors in grammar, spelling, and punctuation. Respond only with the fully corrected text.\n\n' + textToProcess,
		        'ai-custom': 'Follow this instruction: "' + customInstruction + '". Apply it to the following text. Respond only with the result.\n\n' + textToProcess,
		        'ai-translate': 'Translate the following text into ' + customInstruction + '. Respond only with the translated text.\n\n' + textToProcess,
		        'rewrite-shorten': 'Your task is to shorten the following text by about 50%, preserving its core meaning. Respond only with the shortened text.\n\n' + textToProcess,
		        'rewrite-expand': 'Your task is to expand on the following text, adding relevant details to make it about twice as long, preserving its core meaning, idea & context. Respond only with the expanded text.\n\n' + textToProcess,
		        'rewrite-paraphrase': 'Your task is to paraphrase the following text, using different words and sentence structures while keeping the exact same meaning. Respond only with the paraphrased text.\n\n' + textToProcess,
		        'rewrite-grammar': 'Your task is to fix all grammatical errors, spelling mistakes, and punctuation in the following text. Respond only with the corrected text.\n\n' + textToProcess,
		        'style-narrate': 'Rewrite the following text in a narrative storytelling style, making it more engaging and story-like while keeping the same length and core meaning. Use descriptive language and narrative flow. Return only the rewritten text:\n\n' + textToProcess,
		        'style-visualize': 'Rewrite the following text with rich visual and sensory descriptions, helping readers picture the scene clearly. Keep the same meaning but make it more vivid and descriptive. Return only the rewritten text:\n\n' + textToProcess,
		        'style-explain': 'Rewrite the following text in a clear, explanatory style that breaks down concepts and provides better understanding. Make it more educational and detailed while keeping the core message. Return only the rewritten text:\n\n' + textToProcess,
				'style-creative': 'You are a creative writing assistant specializing in artistic expression and imaginative language.\n\nRewrite the following text in a more creative and artistic way, using beautiful language, metaphors, and imaginative expressions while preserving the original meaning. Return only the rewritten text:\n\n' + textToProcess,

				'tone-candid': 'You are a straightforward communicator who values honesty and authenticity.\n\nRewrite the following text in a candid, honest, and direct tone. Make it straightforward and authentic while keeping the same meaning. Return only the rewritten text:\n\n' + textToProcess,

				'tone-humorous': 'You are a comedy writer who makes content entertaining while keeping the message clear.\n\nRewrite the following text with a humorous and entertaining tone, adding wit and light-hearted elements while preserving the core message. Return only the rewritten text:\n\n' + textToProcess,

				'tone-intense': 'You are a dramatic writer who creates powerful emotional impact through language.\n\nRewrite the following text with an intense, powerful, and dramatic tone that creates urgency and emotional impact while keeping the same meaning. Return only the rewritten text:\n\n' + textToProcess,

				'tone-sarcastic': 'You are a witty writer with a sharp sense of humor and mastery of irony.\n\nRewrite the following text with a sarcastic and witty tone, using clever irony and dry humor while maintaining the original message. Return only the rewritten text:\n\n' + textToProcess
		        
		    };
    
		    return workingPrompts[task] || textToProcess;
		}
		
		
		window.taskModelCallbacks = {};

		// ✅ MASTER AI FUNCTION - ADD THIS
		async function callMultipleAI(promptText, taskType) {
		    taskType = taskType || 'general';
		    console.log('🤖 Starting AI request:', taskType);
    
		    // ✅ Load custom APIs from storage
		    var customAPIs = JSON.parse(localStorage.getItem('customAPIs') || '[]');
    
		    // ✅ Try each active custom API
		    for (var i = 0; i < customAPIs.length; i++) {
		        var api = customAPIs[i];
		        if (api.active && api.key && api.key.trim() !== '') {
		            try {
		                console.log('🔄 Trying ' + api.name + '...');
		                var result = await callCustomAPI(api.url, api.key, promptText);
		                console.log('✅ ' + api.name + ' succeeded!');
		                return {
		                    text: result,
		                    source: api.name
		                };
		            } catch (error) {
		                console.log('❌ ' + api.name + ' failed:', error.message);
		                continue;
		            }
		        }
		    }
    
		    // ✅ Fallback to local model (unchanged)
		    if (window.TaskModelBridge && window.TaskModelBridge.isModelLoaded()) {
		        console.log('🔄 Trying local model...');
		        return new Promise(function(resolve) {
		            var callbackId = 'callback_' + Date.now();
		            window.taskModelCallbacks[callbackId] = function(result) {
		                delete window.taskModelCallbacks[callbackId];
		                resolve({
		                    text: result || 'No response',
		                    source: 'Local Model'
		                });
		            };
		            window.TaskModelBridge.callTaskModelAsync(promptText, callbackId);
		        });
		    }
    
		    throw new Error('No AI services available. Please add Custom APIs or load a local model.');
		}

		// ✅ Universal API caller function
		// ✅ Universal API caller function - PRIORITY ORDERED VERSION
		async function callCustomAPI(url, key, prompt) {
		    console.log('🔄 Attempting API call to:', url);
    
		    // ✅ FORMAT ATTEMPTS IN YOUR PREFERRED ORDER
		    const formatAttempts = [
		        // 🥇 1. GOOGLE FORMAT (FIRST PRIORITY)
		        {
		            name: 'Google Format',
		            condition: function() { 
		                return url.includes('generativelanguage.googleapis.com'); 
		            },
		            url: url.includes('?') ? url + '&key=' + key : url + '?key=' + key,
		            headers: { 'Content-Type': 'application/json' },
		            body: function() {
		                return { contents: [{ parts: [{ text: prompt }] }] };
		            },
		            extract: function(data) {
		                return data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] ? data.candidates[0].content.parts[0].text : null;
		            }
		        },
        
		        // 🥈 2. GROQ FORMAT (SECOND PRIORITY)
		        {
		            name: 'Groq Format',
		            condition: function() { 
		                return url.includes('groq.com'); 
		            },
		            headers: { 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' },
		            body: function() {
		                return {
		                    model: "llama-3.3-70b-versatile",
		                    messages: [{ role: 'user', content: prompt }],
		                    max_tokens: 1000
		                };
		            },
		            extract: function(data) {
		                return data.choices && data.choices[0] && data.choices[0].message ? data.choices[0].message.content : null;
		            }
		        },
        
		        // 🥉 3. HUGGING FACE FORMAT (THIRD PRIORITY)
		        {
		            name: 'Hugging Face Format',
		            condition: function() { 
		                return url.includes('huggingface.co') || url.includes('api-inference.huggingface.co') || url.includes('router.huggingface.co'); 
		            },
		            headers: { 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' },
		            body: function() {
		                if (url.includes('/chat/completions') || url.includes('router.huggingface.co')) {
		                    return {
							   inputs: prompt,
							   parameters: { max_new_tokens: 1000, return_full_text: false }
		                    };
		                } else {
		                    return {
		                        inputs: prompt,
		                        parameters: { max_new_tokens: 1000, return_full_text: false }
		                    };
		                }
		            },
		            extract: function(data) {
		                if (data.choices && data.choices[0] && data.choices[0].message) {
		                    return data.choices[0].message.content;
		                } else if (Array.isArray(data) && data[0]) {
		                    return data[0].generated_text || data[0].text;
		                } else if (data.generated_text) {
		                    return data.generated_text;
		                } else if (typeof data === 'string') {
		                    return data;
		                }
		                return null;
		            }
		        },
        
		        // 4. PERPLEXITY FORMAT
		        {
		            name: 'Perplexity Format',
		            condition: function() { 
		                return url.includes('perplexity.ai'); 
		            },
		            headers: { 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' },
		            body: function() {
		                return {
		                    model: "sonar-pro",
		                    messages: [{ role: 'user', content: prompt }],
		                    max_tokens: 1000
		                };
		            },
		            extract: function(data) {
		                return data.choices && data.choices[0] && data.choices[0].message ? data.choices[0].message.content : null;
		            }
		        },
        
		        // 5. OPENAI FORMAT
		        {
		            name: 'OpenAI Format',
		            condition: function() { 
		                return url.includes('openai.com'); 
		            },
		            headers: { 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' },
		            body: function() {
		                return {
		                    model: "gpt-3.5-turbo",
		                    messages: [{ role: 'user', content: prompt }],
		                    max_tokens: 1000
		                };
		            },
		            extract: function(data) {
		                return data.choices && data.choices[0] && data.choices[0].message ? data.choices[0].message.content : null;
		            }
		        },
        
		        // 6. MISTRAL FORMAT
		        {
		            name: 'Mistral Format',
		            condition: function() { 
		                return url.includes('mistral.ai'); 
		            },
		            headers: { 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' },
		            body: function() {
		                return {
		                    model: "mistral-large-latest",
		                    messages: [{ role: 'user', content: prompt }],
		                    max_tokens: 1000
		                };
		            },
		            extract: function(data) {
		                return data.choices && data.choices[0] && data.choices[0].message ? data.choices[0].message.content : null;
		            }
		        },
        
		        // 7. TOGETHER AI FORMAT
		        {
		            name: 'Together AI Format',
		            condition: function() { 
		                return url.includes('together.xyz') || url.includes('together.ai'); 
		            },
		            headers: { 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' },
		            body: function() {
		                return {
		                    model: "meta-llama/Meta-Llama-3.1-8B-Instruct-Turbo",
		                    messages: [{ role: 'user', content: prompt }],
		                    max_tokens: 1000
		                };
		            },
		            extract: function(data) {
		                return data.choices && data.choices[0] && data.choices[0].message ? data.choices[0].message.content : null;
		            }
		        },
        
		        // 8. DEEPSEEK FORMAT
		        {
		            name: 'DeepSeek Format',
		            condition: function() { 
		                return url.includes('deepseek.com'); 
		            },
		            headers: { 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' },
		            body: function() {
		                return {
		                    model: "deepseek-chat",
		                    messages: [{ role: 'user', content: prompt }],
		                    max_tokens: 1000
		                };
		            },
		            extract: function(data) {
		                return data.choices && data.choices[0] && data.choices[0].message ? data.choices[0].message.content : null;
		            }
		        },
        
		        // 9. ANTHROPIC FORMAT (LAST PRIORITY)
		        {
		            name: 'Anthropic Format',
		            condition: function() { 
		                return url.includes('anthropic.com'); 
		            },
		            headers: { 'x-api-key': key, 'Content-Type': 'application/json', 'anthropic-version': '2023-06-01' },
		            body: function() {
		                return {
		                    model: 'claude-3-haiku-20240307',
		                    max_tokens: 1000,
		                    messages: [{ role: 'user', content: prompt }]
		                };
		            },
		            extract: function(data) {
		                return data.content && data.content[0] ? data.content[0].text : null;
		            }
		        }
		    ];
    
		    // ✅ TRY EACH FORMAT IN ORDER
		    for (let attempt of formatAttempts) {
		        if (attempt.condition && !attempt.condition()) {
		            continue;
		        }
        
		        try {
		            console.log('🔄 Trying ' + attempt.name + '...');
            
		            const requestBody = typeof attempt.body === 'function' ? attempt.body() : attempt.body;
		            console.log('📤 Request body:', JSON.stringify(requestBody));
            
		            const response = await fetch(attempt.url || url, {
		                method: 'POST',
		                headers: attempt.headers,
		                body: JSON.stringify(requestBody)
		            });
            
		            console.log('📥 Response status:', response.status);
            
		            if (response.ok) {
		                const data = await response.json();
		                console.log('📥 Response data:', data);
                
		                const result = attempt.extract(data);
		                if (result && result.trim()) {
		                    console.log('✅ ' + attempt.name + ' succeeded!');
		                    return result.trim();
		                } else {
		                    console.log('❌ ' + attempt.name + ' no valid content found');
		                }
		            } else {
		                const errorText = await response.text();
		                console.log('❌ ' + attempt.name + ' HTTP error:', response.status, errorText);
		            }
		        } catch (error) {
		            console.log('❌ ' + attempt.name + ' failed:', error.message);
		            continue;
		        }
		    }
    
		    throw new Error('No compatible API format found');
		}
		
		
		
		
		// ✅ Get all custom APIs
		function getCustomAPIs() {
		    return JSON.parse(localStorage.getItem('customAPIs') || '[]');
		}

		// ✅ Save custom APIs
		function saveCustomAPIs(apis) {
		    localStorage.setItem('customAPIs', JSON.stringify(apis));
		}


		async function callAiModel(promptText) {
					if (!promptText || isProcessing) return;

					isProcessing = true;
					updateAiStatus('processing');
					showAiPanel();

					// ✅ FIX: New innerHTML with a CSS spinner, helpful note, and redesigned ad.
					aiPanelContent.innerHTML = `
						<style>
							.processing-spinner {
								width: 24px;
								height: 24px;
								border: 3px solid rgba(0, 0, 0, 0.1);
								border-top-color: #4285F4; /* Wraiter's blue color */
								border-radius: 50%;
								animation: spin 1s linear infinite;
								margin-right: 12px;
							}
							body.dark-mode .processing-spinner {
								border: 3px solid rgba(255, 255, 255, 0.2);
								border-top-color: #4285F4;
							}
							@keyframes spin {
								to {
									transform: rotate(360deg);
								}
							}
						</style>

						<div style="padding: 30px 20px 0 20px; text-align: center;">
							<div style="display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 500;">
								<div class="processing-spinner"></div>
								<span>🤖 AI Processing...</span>
							</div>
							<div style="font-size: 13px; color: grey; margin-top: 15px;">
								You can continue writing. <br> We'll notify you when it's ready.
							</div>
						</div>

						<div style="width: 100%; display: flex; justify-content: center; margin: 25px 0; font-family: 'Roboto', sans-serif;">
							<div style="background: #4285F4; border-radius: 12px; padding: 20px; text-align: center; max-width: 320px; width: 90%;">
						
								<div style="color: white; font-size: 16px; font-weight: 600; margin-bottom: 8px;">Turn Your Idea into a Screenplay</div>
								<div style="color: white; font-size: 13px; margin-bottom: 15px; opacity: 0.9; line-height: 1.5;">Stop worrying about formatting and focus on what matters most: your story. ToScript automatically formats your screenplay.</div>
						
								<a href="https://play.google.com/store/apps/details?id=com.thosho.toscript&hl=en_IN" target="_blank" style="text-decoration: none;">
									<button style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;">Get ToScript on Google Play</button>
								</a>
							</div>
						</div>
					`;

					try {
						const result = await callMultipleAI(promptText, 'general');
						aiResults.unshift({
							id: generateId(),
							text: result.text,
							timestamp: new Date().toISOString(),
							source: result.source
						});
						localStorage.setItem('wraiterAiResults', JSON.stringify(aiResults.slice(0, 20)));
						isProcessing = false;
						displayAiHistory();
					} catch (error) {
						isProcessing = false;
						displayAiResult(error.message);
					}
				}



		// ✅ ENHANCED AI RESULT WITH VARIATION BUTTONS
		function displayAiResult(resultText) {
		    // ✅ DETECT IF TEXT HAS NUMBERED VARIATIONS
		    const hasVariations = /^\d+\.\s/m.test(resultText);
    
		    if (hasVariations) {
		        // ✅ SPLIT INTO INDIVIDUAL VARIATIONS
		        const variations = resultText.split(/^\d+\.\s/m).filter(v => v.trim().length > 0);
        
		        let html = '<div class="ai-result-container">';
		        html += '<div style="font-size: 14px; font-weight: 600; margin-bottom: 15px; color: var(--modal-text);">🎯 AI Variations (' + variations.length + ')</div>';
        
		        variations.forEach(function(variation, index) {
		            const cleanVariation = variation.trim();
		            if (cleanVariation) {
		                html += '<div class="variation-item" style="margin: 10px 0; padding: 12px; background: var(--modal-bg); border: 1px solid var(--mobile-border-color); border-radius: 8px;">';
		                html += '<div class="variation-buttons" style="margin-bottom: 8px;">';
		                html += '<button class="variation-btn" onclick="insertVariation(\'' + cleanVariation.replace(/'/g, "\\'").replace(/"/g, "&quot;") + '\')" style="background: #4285F4; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 11px; margin-right: 6px; cursor: pointer;">Insert</button>';
		                html += '<button class="variation-btn" onclick="replaceVariation(\'' + cleanVariation.replace(/'/g, "\\'").replace(/"/g, "&quot;") + '\')" style="background: #34A853; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 11px; margin-right: 6px; cursor: pointer;">Replace</button>';
		                html += '<button class="variation-btn" onclick="copyVariation(\'' + cleanVariation.replace(/'/g, "\\'").replace(/"/g, "&quot;") + '\')" style="background: var(--mobile-btn-color); color: var(--modal-bg); border: none; padding: 6px 12px; border-radius: 15px; font-size: 11px; cursor: pointer;">Copy</button>';
		                html += '</div>';
		                html += '<div class="variation-text" style="font-size: 13px; line-height: 1.4; color: var(--modal-text);">' + (index + 1) + '. ' + cleanVariation.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
		                html += '</div>';
		            }
		        });
        
		        html += '</div>';
		        aiPanelContent.innerHTML = html;
		    } else {
		        // ✅ REGULAR AI RESULT (NON-VARIATIONS)
		        var html = '<div class="ai-result-container">';
		        html += '<div class="ai-result-buttons">';
		        html += '<button class="ai-action-btn insert-btn">Insert</button>';
		        html += '<button class="ai-action-btn replace-btn">Replace</button>';
		        html += '<button class="ai-action-btn copy-btn">Copy</button>';
		        html += '</div>';
		        html += '<div class="ai-result-text">' + resultText.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
		        html += '</div>';
		        aiPanelContent.innerHTML = html;
		    }
    
		    showAiPanel();
		    updateAiStatus('has-results');
			loadBannerAdForResults()
		}

		function displayAiHistory() {
		    // ✅ IF NO RESULTS, SHOW NEW CUSTOM API INSTRUCTIONS
		if (aiResults.length === 0) {
		    aiPanelContent.innerHTML = 
		        '<div style="font-size: 14px; line-height: 1.6; max-height: 350px; overflow-y: auto; padding: 0 15px 15px 15px;">' +
		            '<div style="text-align: center; margin-bottom: 20px; font-size: 16px; font-weight: 600; color: var(--primary-text-color);">🤖 AI Setup Guide</div>' +
            
		            // --- Custom API Section ---
		            '<div style="background: linear-gradient(45deg, #10B981, #3B82F6); color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px;">' +
		                '<p style="margin: 0;"><strong>Option 1: Custom API</strong></p>' +
		                '<p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">⚡ Use any provider • 🎯 Your choice • 🔒 Your control</p>' +
		            '</div>' +
		            '<div style="margin: 15px 0;"><strong>Step 1:</strong> Click wr<span style="color: #4285F4;">Ai</span>ter<span style="color: #4285F4; font-weight: 300; margin-left: 4px;">≡</span> → AI Settings</div>' +
		            '<div style="margin: 15px 0;"><strong>Step 2:</strong> Click "Add New API"</div>' +
		            '<div style="margin: 15px 0;"><strong>Step 3:</strong> Enter your API name, URL and key</div>' +
		            '<div style="margin: 15px 0;"><strong>Step 4:</strong> Click "Test" to verify connection</div>' +
		            '<div style="margin: 15px 0;"><strong>Step 5:</strong> Click "Save" to start using AI!</div>' +
            
		            // --- API Key Links Section ---
		            '<div style="background: var(--modal-bg); border: 1px solid var(--mobile-border-color); color: var(--modal-text); padding: 12px; border-radius: 8px; margin: 20px 0;">' +
		                '<div style="font-weight: 600; margin-bottom: 8px;">🌟 Get Your API Keys</div>' +
		                '<div style="font-size: 13px; line-height: 1.8;">' +
		                    '• <strong>Gemini:</strong> <a href="https://aistudio.google.com/app/apikey" target="_blank" class="clickable-link">Create Key</a><br>' +
		                    '• <strong>Groq:</strong> <a href="https://console.groq.com/keys" target="_blank" class="clickable-link">Create Key</a><br>' +
		                    '• <strong>Perplexity:</strong> <a href="https://www.perplexity.ai/settings/api" target="_blank" class="clickable-link">View Keys</a><br>' +
		                    '• <strong>OpenAI:</strong> <a href="https://platform.openai.com/api-keys" target="_blank" class="clickable-link">Create Key</a><br>' +
		                    '• <strong>Anthropic:</strong> <a href="https://console.anthropic.com/settings/keys" target="_blank" class="clickable-link">Create Key</a><br>' +
		                    '• <strong>DeepSeek:</strong> <a href="https://platform.deepseek.com/api_keys" target="_blank" class="clickable-link">View Keys</a><br>' +
		                '</div>' +
		            '</div>' +

		            // --- Local AI Section ---
		            '<hr style="border-color: var(--mobile-border-color); margin: 20px 0;">' +
		            '<div style="background: linear-gradient(45deg, #6B46C1, #EC4899); color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px;">' +
		                '<p style="margin: 0;"><strong>Option 2: Local AI (Offline)</strong></p>' +
		                '<p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">🔒 Private • 📶 Works offline • 💾 No limits</p>' +
		            '</div>' +
		            '<div style="margin: 15px 0;"><strong>Step 1:</strong> Click wr<span style="color: #4285F4;">Ai</span>ter<span style="color: #4285F4; font-weight: 300; margin-left: 4px;">≡</span> → Local AI Setup</div>' +
		            '<div style="margin: 15px 0;"><strong>Step 2:</strong> Download a `.task` model from the setup screen.</div>' +
		            '<div style="margin: 15px 0;"><strong>Step 3:</strong> Click wr<span style="color: #4285F4;">Ai</span>ter<span style="color: #4285F4; font-weight: 300; margin-left: 4px;">≡</span> → Local AI</div>' +
		            '<div style="margin: 15px 0;"><strong>Step 4:</strong> Select your downloaded `.task` file</div>' +
		            '<div style="margin: 15px 0;"><strong>Step 5:</strong> Wait 1-2 minutes for the model to load</div>' +
					'<hr style="border-color: var(--mobile-border-color); margin: 20px 0;">' +
		  
			                '<div style="font-size: 16px; font-weight: 600;">🤖 Ready-to-Use Local AI Models</div>' +
			                '<div style="font-weight: 600; margin-bottom: 10px;">📝 Instructions:</div>' +
			                '<div style="font-size: 13px; line-height: 1.4;">' +
			                    '1. Click download button below<br>' +
			                    '2. Save .task file to Downloads folder<br>' +
			                    '3. Go to Wraiter menu → Local AI<br>' +
			                    '4. Select the downloaded .task file<br>' +
			                    '5. Wait 1-2 minutes for loading<br>' +
			                    '<br>' +
								'<hr style="border-color: var(--mobile-border-color); margin: 20px 0;">' +
			                    '<strong>💡 Tip:</strong> Both models are similar size. Qwen is faster, Gemma has better quality.' +
			                '</div>' +
			            '</div>' +

			            // ✅ MODEL DOWNLOADS SECTION SECOND
			            '<div class="model-item" style="margin: 15px 0; padding: 12px; border: 1px solid var(--mobile-border-color); border-radius: 8px;">' +
			                '<div style="font-weight: 600; margin-bottom: 5px;">Qwen2.5-0.5B-Instruct </div>' +
			                '<div style="font-size: 12px; color: var(--secondary-text-color); margin-bottom: 8px;">⚡ Ultra fast • 📱 Small size • 🎯 High quality</div>' +
			                '<button onclick="downloadModel(\'https://huggingface.co/litert-community/Qwen2.5-0.5B-Instruct/resolve/main/Qwen2.5-0.5B-Instruct_multi-prefill-seq_q8_ekv1280.task\')" style="background: #4285F4; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: 600;">Download (~547MB)</button>' +
			            '</div>' +

			            '<div class="model-item" style="margin: 15px 0; padding: 12px; border: 1px solid var(--mobile-border-color); border-radius: 8px;">' +
			                '<div style="font-weight: 600; margin-bottom: 5px;">Gemma3-1B-IT</div>' +
			                '<div style="font-size: 12px; color: var(--secondary-text-color); margin-bottom: 8px;">🧠 Smart responses • 📈 Better quality</div>' +
			                '<button onclick="downloadModel(\'https://huggingface.co/litert-community/Gemma3-1B-IT/resolve/main/gemma3-1b-it-int4.task\')" style="background: #34A853; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: 600;">Download (~555MB)</button>' +
			            '</div>' +
			        '</div>';
					
					
		           
		  
		                '</div>' +
		            '</div>' +
		        '</div>';
        
		        return;
		    }

		    // ✅ IF HAS RESULTS, SHOW HISTORY WITH SOURCE ATTRIBUTION
		    var historyHtml = '<div style="font-size: 16px; font-weight: 500; margin-bottom: 20px; text-align: center;">AI Results History (' + aiResults.length + ')</div>';
    
		    aiResults.slice(0, 10).forEach(function(result, index) {
		        var timeAgo = new Date(result.timestamp || Date.now()).toLocaleString();
        
		        // ✅ NEW: Get AI source info and color
		        var sourceInfo = result.source || 'Unknown AI';
		        var sourceColor = getSourceColor(sourceInfo);
        
		        historyHtml += 
		            '<div style="margin-bottom: 15px; padding: 15px; background: var(--modal-bg); border-radius: 8px; border-left: 4px solid ' + sourceColor + ';">' +
                
		                // ✅ NEW: Source attribution header
		                '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--mobile-border-color);">' +
		                    '<div style="font-size: 12px; font-weight: 600; color: ' + sourceColor + ';">🤖 ' + sourceInfo + '</div>' +
		                    '<div style="font-size: 11px; color: var(--secondary-text-color);">' + timeAgo + '</div>' +
		                '</div>' +
                
		                // ✅ AI response content
		                '<div style="font-size: 14px; line-height: 1.5; color: var(--primary-text-color); white-space: pre-wrap; margin-bottom: 12px;">' + 
		                    result.text.replace(/</g, '&lt;').replace(/>/g, '&gt;') + 
		                '</div>' +
                
		                // ✅ Action buttons (removed Replace, kept Insert, Copy, Delete)
		                '<div style="display: flex; justify-content: space-between; align-items: center;">' +
		                    '<div style="display: flex; gap: 8px;">' +
		                        '<button onclick="insertAiResult(\'' + result.id + '\')" style="background: #10B981; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 600;">Insert</button>' +
		                        '<button onclick="copyAiResult(\'' + result.id + '\')" style="background: #3B82F6; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 600;">Copy</button>' +
		                    '</div>' +
		                    '<button onclick="deleteAiResult(\'' + result.id + '\')" style="color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 600;" title="Delete this result">🗑️</button>' +
		                '</div>' +
		            '</div>';
		    });

		    if (aiResults.length > 10) {
		        historyHtml += '<div style="text-align: center; opacity: 0.6; margin-top: 15px; font-size: 14px;">Showing latest 10 results</div>';
		    }

		    aiPanelContent.innerHTML = historyHtml;
	
			if (aiResults.length > 0) {
			        loadBannerAdForResults();
			    }
	
		}

		// ✅ NEW: Get color for different AI sources
		function getSourceColor(source) {
		    if (source.toLowerCase().includes('local')) return '#8B5CF6';
		    if (source.toLowerCase().includes('openai')) return '#10B981';
		    if (source.toLowerCase().includes('groq')) return '#F59E0B';
		    if (source.toLowerCase().includes('gemini')) return '#3B82F6';
		    if (source.toLowerCase().includes('claude')) return '#EF4444';
		    if (source.toLowerCase().includes('deepseek')) return '#EC4899';
		    return '#6B7280'; // Default gray for custom APIs
		}



		function insertAiResult(resultId) {
		    var result = aiResults.find(function(r) { return r.id === resultId; });
		    if (result) {
		        insertTextAtCursor(result.text);
		        setTimeout(hideAiPanel, 300);
		    }
		}


		function copyAiResult(resultId) {
		    var result = aiResults.find(function(r) { return r.id === resultId; });
		    if (result) {
		        copyToClipboard(result.text);
		        setTimeout(hideAiPanel, 300);
		    }
		}

		window.insertAiResult = insertAiResult;
		window.copyAiResult = copyAiResult;

		function insertTextAtCursor(text) {
		    editor.focus();
		    document.execCommand('insertText', false, text);
		    updateEditorState();
		}

		function copyToClipboard(text) {
		    navigator.clipboard.writeText(text).then(function() {
		        showCustomAlert('Copied!', 'Text copied to clipboard!');
		    }).catch(function() {
		        showCustomAlert('Error', 'Could not copy text.');
		    });
		}

		// ✅ VARIATION BUTTON FUNCTIONS
		function insertVariation(text) {
		    insertTextAtCursor(text);
		    setTimeout(hideAiPanel, 300);
		}

		function copyVariation(text) {
		    copyToClipboard(text);
		}

		// ✅ MAKE FUNCTIONS GLOBALLY AVAILABLE
		window.insertVariation = insertVariation;
		window.copyVariation = copyVariation;


		function handleLocalAi() {
			// ✅ CHECK MODEL STATUS FIRST
			    var modelStatus = '';
			    var modelName = 'No Model Loaded';
    
			    // Check if local model is loaded
			    if (window.TaskModelBridge && window.TaskModelBridge.isModelLoaded && window.TaskModelBridge.isModelLoaded()) {
			        // Detect model type from stored preference or file name
			        var storedModelName = localStorage.getItem('loadedModelName') || 'Local AI Model';
			        modelName = storedModelName;
			        modelStatus = '<div style="background: linear-gradient(45deg, #10B981, #3B82F6); color: white; padding: 12px; border-radius: 8px; text-align: center; margin: 10px 0;">' +
			            '<div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">✅ Currently Loaded:</div>' +
			            '<div style="font-size: 13px; opacity: 0.9;">' + modelName + '</div>' +
			        '</div>';
			    } else {
			        modelStatus = '<div style="background: var(--modal-bg); border: 1px dashed var(--mobile-border-color); color: var(--secondary-text-color); padding: 12px; border-radius: 8px; text-align: center; margin: 10px 0;">' +
			            '<div style="font-size: 14px; opacity: 0.7;">❌ No Local Model Loaded</div>' +
			            '<div style="font-size: 12px; opacity: 0.5; margin-top: 4px;">Load a .task file to enable offline AI</div>' +
			        '</div>';
			    }
    
			    var modalHTML = '<div style="line-height: 1.5;"><p>Configure Local AI Model</p>' +
			        modelStatus +
			        '<button id="open-model-btn" class="modal-button" style="width: 100%; margin: 10px 0;">Open .task File</button>' +
			        '<button id="download-model-btn" class="modal-button" style="width: 100%; margin: 10px 0; background: #4285F4; color: white;">Download AI Setup</button>' +
			        '<button id="clear-model-btn" class="modal-button secondary" style="width: 100%;">Clear Current Model</button>' +
			        '</div>';
    
			    showModal('Local AI Configuration', modalHTML);
    
		    // ✅ ADD TIMEOUT SO BUTTONS EXIST BEFORE ATTACHING EVENTS
		    setTimeout(() => {
		        const openBtn = document.getElementById('open-model-btn');
		        const downloadBtn = document.getElementById('download-model-btn');
		        const clearBtn = document.getElementById('clear-model-btn');
        
		        if (openBtn) {
		            openBtn.onclick = function() {
		                hideModal();
		                if (window.TaskModelBridge) {
							window.TaskModelBridge.loadTaskModel();
					
		                } else {
		                    showCustomAlert('Error', 'TaskModelBridge not available');
		                }
		            };
		        }
        
				if (downloadBtn) {
				    downloadBtn.onclick = function() {
				        hideModal();
				        // ✅ TRIGGER THE LOCAL INSTRUCTIONS INSTEAD
				        handleAction('local-instructions');
				    };
				}
        
        
		        if (clearBtn) {
		            clearBtn.onclick = function() {
		                hideModal();
		                if (window.TaskModelBridge) {
		                    window.TaskModelBridge.clearLocalModel();
		                } else {
		                    showCustomAlert('Model Cleared', 'Local AI model cleared. Use "Open .task File" to load again.');
		                }
		            };
		        }
		    }, 100);
		}


		function downloadModel(url) {
		    // ✅ Tell Android to open in external browser
		    if (window.AndroidBridge && window.AndroidBridge.openExternalBrowser) {
		        window.AndroidBridge.openExternalBrowser(url);
		    } else {
		        // ✅ Fallback: Show instructions to user
		        hideModal();
		        showCustomAlert('📥 Download Instructions', 
		            '🔗 <strong>Copy this link and open in Chrome:</strong><br><br>' +
		            '<div style="background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 11px; word-break: break-all; margin: 10px 0;">' + url + '</div>' +
		            '<br>📱 <strong>Or follow these steps:</strong><br>' +
		            '1. Click menu → Share → Copy Link<br>' +
		            '2. Open Chrome browser<br>' +
		            '3. Paste the link and go<br>' +
		            '4. Download will start automatically'
		        );
		    }
		}



		window.downloadModel = downloadModel;

		// ✅ CORS-FRIENDLY MYMEMORY (WORKS IN ANDROID)
		async function translateWithMyMemory(text, targetLang) {
		    try {
		        const email = 'wraiter-app@example.com';
		        // ✅ Use JSONP-style API that bypasses CORS
		        const url = 'https://api.mymemory.translated.net/get?q=' + encodeURIComponent(text) + '&langpair=auto|' + targetLang + '&de=' + email;
        
		        const response = await fetch(url, {
		            method: 'GET',
		            mode: 'cors'
		        });
        
		        const data = await response.json();
		        console.log('MyMemory response:', data);
        
		        if (data.responseStatus === 200) {
		            return data.responseData.translatedText;
		        } else {
		            throw new Error('MyMemory API error: ' + data.responseDetails);
		        }
		    } catch (error) {
		        console.log('MyMemory failed:', error);
		        throw new Error('MyMemory failed: ' + error.message);
		    }
		}

		// ✅ WORKING GOOGLE TRANSLATE ALTERNATIVE (NO OFFICIAL KEY NEEDED)
		async function translateWithGoogleFree(text, targetLang) {
		    try {
		        // ✅ Use Google Translate's public endpoint
		        const url = 'https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=' + targetLang + '&dt=t&q=' + encodeURIComponent(text);
        
		        const response = await fetch(url);
		        const data = await response.json();
		        console.log('Google free response:', data);
        
		        if (data && data[0] && data[0][0] && data[0][0][0]) {
		            return data[0][0][0];
		        } else {
		            throw new Error('Google free translation failed');
		        }
		    } catch (error) {
		        console.log('Google free failed:', error);
		        throw new Error('Google free failed: ' + error.message);
		    }
		}

		// ✅ UPDATED MAIN FUNCTION WITH WORKING APIS
		async function translateTextOnly(text, targetLang) {
		    console.log('Starting translation with text:', text, 'targetLang:', targetLang);
    
		    try {
		        // ✅ Priority 1: Gemini API (if available)
		        const geminiApiKey = localStorage.getItem('geminiApiKey');
		        if (geminiApiKey && geminiApiKey.trim() !== '') {
		            console.log('Trying Gemini translation...');
		            const translationPrompt = 'Translate the following text to ' + targetLang + '. Only return the translated text, nothing else:\n\n' + text;
            
		            const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + geminiApiKey, {
		                method: 'POST',
		                headers: { 'Content-Type': 'application/json' },
		                body: JSON.stringify({
		                    contents: [{ parts: [{ text: translationPrompt }] }]
		                })
		            });
            
		            const data = await response.json();
		            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
		                console.log('Gemini translation successful!');
		                return data.candidates[0].content.parts[0].text.trim();
		            }
		        }
		    } catch (error) {
		        console.log('Gemini translation failed:', error.message);
		    }
    
		    try {
		        // Priority 2: Google Free Translation (no API key)
		        console.log('Trying Google free translation...');
		        const result = await translateWithGoogleFree(text, targetLang);
		        console.log('Google free translation successful:', result);
		        return result;
		    } catch (error) {
		        console.log('Google free translation failed:', error.message);
        
		        try {
		            // Priority 3: MyMemory (backup)
		            console.log('Trying MyMemory translation...');
		            const result = await translateWithMyMemory(text, targetLang);
		            console.log('MyMemory translation successful:', result);
		            return result;
		        } catch (error) {
		            console.log('MyMemory translation failed:', error.message);
		            throw new Error('All translation services failed. Check console for details.');
		        }
		    }
		}

		// ✅ CONVERT LANGUAGE NAMES TO CODES
		function getLanguageCode(languageName) {
		    const languageMap = {
		        // ✅ POPULAR LANGUAGES
		        'spanish': 'es', 'español': 'es',
		        'french': 'fr', 'français': 'fr',
		        'german': 'de', 'deutsch': 'de',
		        'italian': 'it', 'italiano': 'it',
		        'portuguese': 'pt', 'português': 'pt',
		        'russian': 'ru', 'русский': 'ru',
		        'chinese': 'zh', '中文': 'zh',
		        'japanese': 'ja', '日本語': 'ja',
		        'korean': 'ko', '한국어': 'ko',
		        'arabic': 'ar', 'العربية': 'ar',
		        'hindi': 'hi', 'हिन्दी': 'hi',
		        'bengali': 'bn', 'বাংলা': 'bn',
		        'tamil': 'ta', 'தமிழ்': 'ta',
		        'telugu': 'te', 'తెలుగు': 'te',
		        'marathi': 'mr', 'मराठी': 'mr',
		        'gujarati': 'gu', 'ગુજરાતી': 'gu',
		        'punjabi': 'pa', 'ਪੰਜਾਬੀ': 'pa',
		        'urdu': 'ur', 'اردو': 'ur',
		        'dutch': 'nl', 'nederlands': 'nl',
		        'swedish': 'sv', 'svenska': 'sv',
		        'norwegian': 'no', 'norsk': 'no',
		        'danish': 'da', 'dansk': 'da',
		        'finnish': 'fi', 'suomi': 'fi',
		        'polish': 'pl', 'polski': 'pl',
		        'turkish': 'tr', 'türkçe': 'tr',
		        'greek': 'el', 'ελληνικά': 'el',
		        'hebrew': 'he', 'עברית': 'he',
		        'thai': 'th', 'ไทย': 'th',
		        'vietnamese': 'vi', 'tiếng việt': 'vi',
		        'indonesian': 'id', 'bahasa indonesia': 'id',
		        'malay': 'ms', 'bahasa melayu': 'ms',
		        'filipino': 'tl', 'tagalog': 'tl',
		        'english': 'en'
		    };
    
		    const normalizedInput = languageName.toLowerCase().trim();
    
		    // ✅ CHECK IF IT'S ALREADY A LANGUAGE CODE (2-3 letters)
		    if (normalizedInput.length <= 3 && /^[a-z]+$/.test(normalizedInput)) {
		        return normalizedInput;
		    }
    
		    // ✅ LOOK UP LANGUAGE NAME
		    return languageMap[normalizedInput] || normalizedInput;
		}

	
		async function testNewAPI() {
		    var name = document.getElementById('add-api-name').value.trim();
		    var url = document.getElementById('add-api-url').value.trim();
		    var key = document.getElementById('add-api-key').value.trim();
    
		    if (!name || !url || !key) {
		        showCustomAlert('Missing Info', '⚠️ Please fill all fields');
		        return;
		    }
    
		    var testBtn = document.getElementById('test-new-api-btn');
		    var originalText = testBtn.textContent;
		    testBtn.textContent = '🔄 Testing...';
		    testBtn.disabled = true;
    
		    try {
		        var result = await callCustomAPI(url, key, 'Hello! This is a test message. Please respond with "Test successful!"');
        
		        // ✅ SHOW SUCCESS BUT DON'T CLOSE MODAL - FIELDS STAY FILLED
		        var alertModal = document.createElement('div');
		        alertModal.innerHTML = '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 99999; display: flex; align-items: center; justify-content: center;">' +
		            '<div style="background: var(--modal-bg); padding: 20px; border-radius: 10px; max-width: 90%; text-align: center;">' +
		                '<div style="font-size: 18px; margin-bottom: 10px;">✅ Connection Successful!</div>' +
		                '<div style="margin-bottom: 15px; color: var(--secondary-text-color);">API Response: ' + result.substring(0, 150) + (result.length > 150 ? '...' : '') + '</div>' +
		                '<button onclick="this.parentElement.parentElement.remove()" style="background: #10B981; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">Continue</button>' +
		            '</div>' +
		        '</div>';
        
		        document.body.appendChild(alertModal);
        
		    } catch (error) {
		        // ✅ SHOW ERROR BUT DON'T CLOSE MODAL
		        var alertModal = document.createElement('div');
		        alertModal.innerHTML = '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 99999; display: flex; align-items: center; justify-content: center;">' +
		            '<div style="background: var(--modal-bg); padding: 20px; border-radius: 10px; max-width: 90%; text-align: center;">' +
		                '<div style="font-size: 18px; margin-bottom: 10px;">❌ Connection Failed</div>' +
		                '<div style="margin-bottom: 15px; color: var(--secondary-text-color);">Error: ' + error.message + '</div>' +
		                '<button onclick="this.parentElement.parentElement.remove()" style="background: #EF4444; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">Try Again</button>' +
		            '</div>' +
		        '</div>';
        
		        document.body.appendChild(alertModal);
		    } finally {
		        testBtn.textContent = originalText;
		        testBtn.disabled = false;
		    }
		}




		function shareContent() {
		    var text = editor.innerText.trim();
		    if (!text) {
		        return showCustomAlert('Nothing to Share', 'Please write some text first.');
		    }
    
		    if (window.TaskModelBridge) {
		        window.TaskModelBridge.shareContent(text);
		    } else {
		        if (navigator.share) {
		            navigator.share({
		                title: 'From Wraiter',
		                text: text
		            }).catch(function() {
		                window.open('https://wa.me/?text=' + encodeURIComponent(text));
		            });
		        } else {
		            window.open('https://wa.me/?text=' + encodeURIComponent(text));
		        }
		    }
		}

		function showAdvancedSaveOptions() {
		    var modalHTML = `
		        <div style="line-height: 1.5; padding: 10px;">
		            <p style="margin-bottom: 15px; font-weight: 600;">Choose Export Option:</p>
            
		            <button id="save-all-txt" class="modal-button" style="width: 100%; margin: 8px 0; text-align: left; padding: 12px;">
		                📚 Save All Folders as Text<br>
		                <small style="opacity: 0.7;">Complete library with folder structure</small>
		            </button>
            
		            <button id="save-all-pdf" class="modal-button" style="width: 100%; margin: 8px 0; text-align: left; padding: 12px;">
		                📚 Save All Folders as PDF<br>
		                <small style="opacity: 0.7;">Complete library with folder structure</small>
		            </button>
            
		            <button id="save-current-txt" class="modal-button" style="width: 100%; margin: 8px 0; text-align: left; padding: 12px;">
		                📄 Save Current Document as Text<br>
		                <small style="opacity: 0.7;">Active document only</small>
		            </button>
            
		            <button id="save-current-pdf" class="modal-button" style="width: 100%; margin: 8px 0; text-align: left; padding: 12px;">
		                📄 Save Current Document as PDF<br>
		                <small style="opacity: 0.7;">Active document only</small>
		            </button>
            
		            <button id="cancel-save" class="modal-button secondary" style="width: 100%; margin-top: 15px;">
		                Cancel
		            </button>
		        </div>
		    `;
    
		    showModal('Save As', modalHTML);
    
		    setTimeout(function() {
		        document.getElementById('save-all-txt').onclick = function() {
		            hideModal();
		            exportAllFoldersAsText();
		        };
        
		        document.getElementById('save-all-pdf').onclick = function() {
		            hideModal();
		            exportAllFoldersAsPDF();
		        };
        
		        document.getElementById('save-current-txt').onclick = function() {
		            hideModal();
		            exportCurrentDocumentAsText();
		        };
        
		        document.getElementById('save-current-pdf').onclick = function() {
		            hideModal();
		            exportCurrentDocumentAsPDF();
		        };
        
		        document.getElementById('cancel-save').onclick = function() {
		            hideModal();
		        };
		    }, 100);
		}

		function exportAllFoldersAsText() {
		    var files = getAllFiles();
		    var folders = getAllFoldersData();
    
		    var bookText = '# Complete Library Export\n\n';
		    bookText += 'Generated: ' + new Date().toLocaleString() + '\n';
		    bookText += 'Total Documents: ' + Object.keys(files).length + '\n';
		    bookText += 'Total Folders: ' + Object.keys(folders).length + '\n\n';
		    bookText += '═══════════════════════════════════════════════════════\n\n';
    
		    Object.keys(folders).sort().forEach(function(folderName) {
		        var folderDocs = Object.values(files).filter(function(f) {
		            return (f.folder || 'All Documents') === folderName;
		        }).sort(function(a, b) {
		            return new Date(a.lastModified) - new Date(b.lastModified);
		        });
        
		        if (folderDocs.length > 0) {
		            bookText += '# ' + folderName + '\n\n';
		            bookText += 'Documents: ' + folderDocs.length + '\n\n';
		            bookText += '───────────────────────────────────────────────────────\n\n';
            
		            folderDocs.forEach(function(doc, index) {
		                bookText += '## ' + doc.title + '\n\n';
		                bookText += doc.text + '\n\n';
		                bookText += '───────────────────────────────────────────────────────\n\n';
		            });
            
		            bookText += '═══════════════════════════════════════════════════════\n\n';
		        }
		    });
    
		    var blob = new Blob([bookText], { type: 'text/plain' });
		    var url = URL.createObjectURL(blob);
		    var a = document.createElement('a');
		    a.href = url;
		    a.download = 'Wraiter_Complete_Library_' + Date.now() + '.txt';
		    document.body.appendChild(a);
		    a.click();
		    document.body.removeChild(a);
		    URL.revokeObjectURL(url);
    
		    showCustomAlert('Exported', 'Complete library exported as text file');
		}

		function exportAllFoldersAsPDF() {
		    if (!window.jspdf) {
		        showCustomAlert('Error', 'PDF library not loaded');
		        return;
		    }
    
		    var files = getAllFiles();
		    var folders = getAllFoldersData();
		    var doc = new jspdf.jsPDF();
		    var yPos = 20;
		    var lineHeight = 7;
		    var pageHeight = doc.internal.pageSize.height;
    
		    doc.setFontSize(16);
		    doc.text('Complete Library Export', 15, yPos);
		    yPos += lineHeight * 2;
    
		    Object.keys(folders).sort().forEach(function(folderName) {
		        var folderDocs = Object.values(files).filter(function(f) {
		            return (f.folder || 'All Documents') === folderName;
		        }).sort(function(a, b) {
		            return new Date(a.lastModified) - new Date(b.lastModified);
		        });
        
		        if (folderDocs.length > 0) {
		            if (yPos > pageHeight - 30) {
		                doc.addPage();
		                yPos = 20;
		            }
            
		            doc.setFontSize(14);
		            doc.text(folderName, 15, yPos);
		            yPos += lineHeight * 2;
            
		            folderDocs.forEach(function(document) {
		                if (yPos > pageHeight - 30) {
		                    doc.addPage();
		                    yPos = 20;
		                }
                
		                doc.setFontSize(12);
		                doc.text(document.title, 20, yPos);
		                yPos += lineHeight * 1.5;
                
		                doc.setFontSize(10);
		                var lines = doc.splitTextToSize(document.text, 170);
		                lines.forEach(function(line) {
		                    if (yPos > pageHeight - 20) {
		                        doc.addPage();
		                        yPos = 20;
		                    }
		                    doc.text(line, 20, yPos);
		                    yPos += lineHeight;
		                });
                
		                yPos += lineHeight;
		            });
            
		            yPos += lineHeight * 2;
		        }
		    });
    
		    doc.save('Wraiter_Complete_Library_' + Date.now() + '.pdf');
		    showCustomAlert('Exported', 'Complete library exported as PDF');
		}

		function exportCurrentDocumentAsText() {
		    if (!currentDocumentId) {
		        showCustomAlert('No Document', 'Please open a document first');
		        return;
		    }
    
		    var files = getAllFiles();
		    var doc = files[currentDocumentId];
    
		    if (!doc) {
		        showCustomAlert('Error', 'Document not found');
		        return;
		    }
    
		    var text = '# ' + doc.title + '\n\n';
		    text += 'Created: ' + new Date(doc.lastModified).toLocaleString() + '\n';
		    if (doc.tags && doc.tags.length > 0) {
		        text += 'Tags: ' + doc.tags.map(function(t) { return '#' + t; }).join(', ') + '\n';
		    }
		    text += '\n' + '─'.repeat(50) + '\n\n';
		    text += doc.text;
    
		    var blob = new Blob([text], { type: 'text/plain' });
		    var url = URL.createObjectURL(blob);
		    var a = document.createElement('a');
		    a.href = url;
		    a.download = doc.title.replace(/[^a-z0-9]/gi, '_') + '_' + Date.now() + '.txt';
		    document.body.appendChild(a);
		    a.click();
		    document.body.removeChild(a);
		    URL.revokeObjectURL(url);
    
		    showCustomAlert('Exported', 'Document exported as text file');
		}

		function exportCurrentDocumentAsPDF() {
		    if (!currentDocumentId) {
		        showCustomAlert('No Document', 'Please open a document first');
		        return;
		    }
    
		    if (!window.jspdf) {
		        showCustomAlert('Error', 'PDF library not loaded');
		        return;
		    }
    
		    var files = getAllFiles();
		    var document = files[currentDocumentId];
    
		    if (!document) {
		        showCustomAlert('Error', 'Document not found');
		        return;
		    }
    
		    var doc = new jspdf.jsPDF();
		    var yPos = 20;
    
		    doc.setFontSize(16);
		    doc.text(document.title, 15, yPos);
		    yPos += 15;
    
		    doc.setFontSize(10);
		    var lines = doc.splitTextToSize(document.text, 180);
		    lines.forEach(function(line) {
		        if (yPos > 280) {
		            doc.addPage();
		            yPos = 20;
		        }
		        doc.text(line, 15, yPos);
		        yPos += 7;
		    });
    
		    doc.save(document.title.replace(/[^a-z0-9]/gi, '_') + '_' + Date.now() + '.pdf');
		    showCustomAlert('Exported', 'Document exported as PDF');
		}

		window.showAdvancedSaveOptions = showAdvancedSaveOptions;
		window.exportAllFoldersAsText = exportAllFoldersAsText;
		window.exportAllFoldersAsPDF = exportAllFoldersAsPDF;
		window.exportCurrentDocumentAsText = exportCurrentDocumentAsText;
		window.exportCurrentDocumentAsPDF = exportCurrentDocumentAsPDF;
		

		// ✅ ADD THIS FUNCTION AFTER YOUR OTHER FUNCTIONS
		function closePanelsExcept(keepOpen) {
		    // Close AI panel unless we want to keep it
		    if (keepOpen !== 'ai' && aiTopPanel.classList.contains('show')) {
		        hideAiPanel();
		        document.getElementById('ai-status-btn').classList.remove('active');
		    }
    
		    // Close library unless we want to keep it
		    if (keepOpen !== 'library' && document.body.classList.contains('library-visible')) {
		        document.body.classList.remove('library-visible');
		    }
    
		    // Close suggestion panel unless we want to keep it
		    if (keepOpen !== 'suggestion' && document.body.classList.contains('sidebar-visible')) {
		        document.body.classList.remove('sidebar-visible');
		    }
		}


		function handleAction(action) {
		    closeAllMenus();
    
		    var aiActions = ['rewrite-shorten', 'rewrite-expand', 'rewrite-paraphrase', 'rewrite-grammar', 'style-narrate', 'style-visualize', 'style-explain', 'style-creative', 'tone-candid', 'tone-humorous', 'tone-intense', 'tone-sarcastic', 'ai-suggest', 'ai-proofread', 'ai-custom', 'ai-translate'];
    
		    if (aiActions.indexOf(action) !== -1) {
		        // ✅ CHECK IF API OR LOCAL MODEL IS CONFIGURED
		        var customAPIs = getCustomAPIs();
		        var hasActiveAPI = customAPIs.some(function(api) {
		            return api.active && api.key && api.key.trim() !== '';
		        });
        
		        // Check if local model is loaded
		        var hasLocalModel = window.TaskModelBridge && 
		                           window.TaskModelBridge.isModelLoaded && 
		                           window.TaskModelBridge.isModelLoaded();
        
		        // If no API and no local model, show error
		        if (!hasActiveAPI && !hasLocalModel) {
		            showCustomAlert(
		                '⚠️ AI Not Configured',
		                '<div style="line-height: 1.6; text-align: left;">' +
		                '<p style="margin-bottom: 15px;">Please set up AI to use this feature:</p>' +
		                '<p style="margin-bottom: 10px;"><strong>Option 1: Custom API</strong><br>' +
		                '• Go to wr<span style="color: #4285F4;">Ai</span>ter≡ → AI Settings<br>' +
		                '• Add an API (Groq, OpenAI, Gemini, etc.)</p>' +
		                '<p style="margin-bottom: 10px;"><strong>Option 2: Local Model</strong><br>' +
		                '• Go to wr<span style="color: #4285F4;">Ai</span>ter≡ → Local AI<br>' +
		                '• Load a .task model file</p>' +
		                '</div>'
		            );
		            return; // Stop execution
		        }
        
		        // Check if AI is already processing
		        if (isProcessing) {
		            showCustomAlert('AI Processing', '🤖 AI is working on your request.<br><br>✍️ <strong>Keep typing!</strong><br>We\'ll notify you when the text is generated.<br><br>👁️ Watch the memory icon flicker when ready!');
		            return;
		        }
        
		        var contextText = window.getSelection().toString().trim() || editor.innerText.trim();
        
        
		        if (action === 'ai-custom') {
		            customPrompt('AI Custom Task', 'Enter your custom instruction for the AI:', 'e.g., make this more professional').then(function(instruction) {
		                if (!instruction) return;
                
		                if (!contextText) {
		                    contextText = 'No text provided. Please follow this instruction: ' + instruction;
		                }
                
		                var prompt = getWorkingPrompt(action, contextText, instruction);
		                callAiModel(prompt);
		            });
		            return;
		        }
        
				if (action === 'ai-translate') {
				    customPrompt('AI Translate', 'Enter target language', 'e.g., Spanish, French, German, Hindi').then(function(language) {
				        if (!language) return;
				        if (!contextText) return showCustomAlert('Input Needed', 'Please select text or write something in the editor first.');
        
				        // ✅ CONVERT LANGUAGE NAME TO CODE
				        const languageCode = getLanguageCode(language);
				        console.log('Converting "' + language + '" to code: ' + languageCode);
        
				        // ✅ SHOW PROCESSING STATE FIRST
				        isProcessing = true;
				        updateAiStatus('processing');
				        showAiPanel();
				        aiPanelContent.innerHTML = '<div style="padding: 40px; text-align: center;"><div style="font-size: 20px; margin-bottom: 15px;">🌐 Translating to ' + language + '...</div></div>';
        
				        // ✅ USE TRANSLATION API AND DISPLAY IN AI PANEL
				        translateTextOnly(contextText, languageCode).then(function(translatedText) {
				            // ✅ ADD TO AI RESULTS HISTORY
				            aiResults.unshift({
				                id: generateId(),
				                text: translatedText,
				                timestamp: new Date().toISOString(),
				                source: 'Translation to ' + language
				            });
            
				            // ✅ DISPLAY IN AI PANEL WITH INSERT/REPLACE/COPY BUTTONS
				            isProcessing = false;
				            displayAiResult(translatedText);
            
				        }).catch(function(error) {
				            isProcessing = false;
				            displayAiResult('❌ Translation failed: ' + error.message);
				        });
				    });
				    return;
				}	
        
		        if (!contextText && action !== 'ai-suggest') {
		            return showCustomAlert('Input Needed', 'Please select text or write something in the editor first.');
		        }
        
		        var prompt = getWorkingPrompt(action, contextText);
		        callAiModel(prompt);
		        return;
		    }
    
		    switch (action) {
	
			case 'toggle-main-menu':
								// ✅ FIX: Check if the AI panel is open first.
								if (aiTopPanel.classList.contains('show')) {
									// If the AI panel is open, the menu button's only job is to close it.
									hideAiPanel();
								} else {
									// If the AI panel is NOT open, then toggle the main menu as usual.
									var menu = document.getElementById('mobile-slider-menu');
									if (menu) {
										if (menu.classList.contains('show')) {
											menu.classList.remove('show');
										} else {
											closeAllMenus();
											menu.classList.add('show');
										}
									}
								}
								break;
		
				case 'toggle-focus':
				                   // Check if already in fullscreen mode
				                   if (document.body.classList.contains('focus-mode')) {
				                       // EXITING FULLSCREEN - Restore footer
				                       document.body.classList.remove('focus-mode');
				                       document.getElementById('mobile-bottom-bar').style.display = 'flex';

				                       // ✅ Notify native code to move the ad back to the BOTTOM
				                       if (window.TaskModelBridge) {
				                           window.TaskModelBridge.onFocusModeChanged(false);
				                       }
				                   } else {
				                       // ENTERING FULLSCREEN - Hide AI panel first, then footer
				                       if (aiTopPanel.classList.contains('show')) {
				                           hideAiPanel();
				                       }
				                       // Hide footer and enter fullscreen
				                       document.getElementById('mobile-bottom-bar').style.display = 'none';
				                       setTimeout(() => {
				                           document.body.classList.add('focus-mode');
                           
				                           // ✅ Notify native code to move the ad to the TOP
				                           if (window.TaskModelBridge) {
				                               window.TaskModelBridge.onFocusModeChanged(true);
				                           }
				                       }, 150);
				                   }
				                   break;

				               case 'exit-focus-mode':
				                   document.body.classList.remove('focus-mode');
				                   // ALWAYS restore footer when exiting fullscreen
				                   document.getElementById('mobile-bottom-bar').style.display = 'flex';

				                   // ✅ Notify native code to move the ad back to the BOTTOM
				                   if (window.TaskModelBridge) {
				                       window.TaskModelBridge.onFocusModeChanged(false);
				                   }
				                   break;
					
				case 'toggle-library':
				    // ✅ CLOSE AI PANEL FIRST IF IT'S OPEN
				    if (aiTopPanel.classList.contains('show')) {
				        hideAiPanel();
				        document.getElementById('ai-status-btn').classList.remove('active');
				    }
    
				    // ✅ THEN TOGGLE LIBRARY
				    document.body.classList.toggle('library-visible');
				    if(document.body.classList.contains('library-visible')) loadFileLibrary();
				    break;
		        case 'close-library':
		            document.body.classList.remove('library-visible');
		            break;
		        case 'close-sidebar':
		            document.body.classList.remove('sidebar-visible');
		            break;
		        case 'close-modal':
		            hideModal();
		            break;
		        case 'new-document':
		            createNewDocument();
		            document.body.classList.remove('library-visible');
		            break;
		        case 'toggle-ai-panel':
		            toggleAiPanel();
		            break;
		        case 'undo':
		            if (historyIndex > 0) {
		                historyIndex--;
		                editor.innerHTML = history[historyIndex];
		            }
		            break;
		        case 'redo':
		            if (historyIndex < history.length - 1) {
		                historyIndex++;
		                editor.innerHTML = history[historyIndex];
		            }
		            break;
		        case 'toggle-dark-mode':
		            document.body.classList.toggle('dark-mode');
		            darkModeIcon.textContent = document.body.classList.contains('dark-mode') ? 'dark_mode' : 'light_mode';
		            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
		            break;
		        case 'format-bold':
		            document.execCommand('bold');
		            updateEditorState();
		            break;
		        case 'format-italic':
		            document.execCommand('italic');
		            updateEditorState();
		            break;
		        case 'format-center':
		            document.execCommand('justifyCenter');
		            updateEditorState();
		            break;
		        case 'format-list':
		            document.execCommand('insertOrderedList');
		            updateEditorState();
		            break;
		        case 'format-quote':
		            document.execCommand('formatBlock', false, 'blockquote');
		            updateEditorState();
		            break;
					case 'font-increase':
					    if (currentFontSize < 32) {
					        updateEditorFontSize(currentFontSize + 2);
					    }
					    break;

					case 'font-decrease': 
					    if (currentFontSize > 12) {
					        updateEditorFontSize(currentFontSize - 2);
					    }
					    break;
			
		        case 'save-txt':
		            var text = editor.innerText;
		            if (window.TaskModelBridge) {
		                window.TaskModelBridge.saveTextFile(text);
		            } else {
		                showCustomAlert('Save', 'Text would be saved: ' + text.substring(0, 100) + '...');
		            }
		            break;
		        case 'save-pdf':
		            if (window.jspdf && window.TaskModelBridge) {
		                const { jsPDF } = window.jspdf;
		                const doc = new jsPDF();
		                const pdftext = editor.innerText;
		                const lines = doc.splitTextToSize(pdftext, 180);
		                doc.text(lines, 10, 10);
		                const pdfData = doc.output('datauristring');
		                window.TaskModelBridge.savePdfFile(pdfData);
		            } else {
		                showCustomAlert('Error', 'PDF save not available.');
		            }
		            break;
		        case 'open-text-file':
		            if (window.TaskModelBridge) {
		                window.TaskModelBridge.openTextFile();
		            } else {
		                showCustomAlert('Error', 'File open function not available');
		            }
		            break;
		        case 'share-content':
		            shareContent();
		            break;
				case 'save-as':
				    showAdvancedSaveOptions();
				    break;
		       
				case 'set-api-key':
				    showAiSettingsModal();
				    break;
		case 'ai-settings':
		    var customAPIs = getCustomAPIs();
		    if (customAPIs.length === 0) {
		        // ✅ AUTO-OPEN Add API if no APIs exist
		        showAddApiModal();
		    } else {
		        showApiManagerModal();
		    }
		    break;
		case 'manage-apis':
		    showApiManagerModal();
		    break;
		
		
					case 'local-ai':
					            handleLocalAi();
					            break;
								case 'local-instructions':
								    modalTitle.textContent = '📦 Download AI Models';
								    modalContent.innerHTML = 
								        '<div style="font-size: 14px; line-height: 1.6; max-height: 900px; overflow-y: auto; padding: 10px;">' +
								            '<div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(45deg, #4285F4, #34A853); color: white; border-radius: 8px; text-align: center;">' +
								                '<div style="font-size: 16px; font-weight: 600;">🤖 Ready-to-Use AI Models</div>' +
								                '<div style="font-weight: 600; margin-bottom: 10px;">📝 Instructions:</div>' +
								                '<div style="font-size: 13px; line-height: 1.4;">' +
								                    '1. Click download button below<br>' +
								                    '2. Save .task file to Downloads folder<br>' +
								                    '3. Go to Wraiter menu → Local AI<br>' +
								                    '4. Select the downloaded .task file<br>' +
								                    '5. Wait 1-2 minutes for loading<br>' +
								                    '<br>' +
								                    '<strong>💡 Tip:</strong> Both models are similar size. Qwen is faster, Gemma has better quality.' +
								                '</div>' +
								            '</div>' +
            
								            // ✅ MODEL DOWNLOADS SECTION SECOND
								            '<div class="model-item" style="margin: 15px 0; padding: 12px; border: 1px solid var(--mobile-border-color); border-radius: 8px;">' +
								                '<div style="font-weight: 600; margin-bottom: 5px;">🚀 Qwen2.5-0.5B-Instruct </div>' +
								                '<div style="font-size: 12px; color: var(--secondary-text-color); margin-bottom: 8px;">⚡ Ultra fast • 📱 Small size • 🎯 High quality • 🆓 Free</div>' +
								                '<button onclick="downloadModel(\'https://huggingface.co/litert-community/Qwen2.5-0.5B-Instruct/resolve/main/Qwen2.5-0.5B-Instruct_multi-prefill-seq_q8_ekv1280.task\')" style="background: #4285F4; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: 600;">Download (~547MB)</button>' +
								            '</div>' +
            
								            '<div class="model-item" style="margin: 15px 0; padding: 12px; border: 1px solid var(--mobile-border-color); border-radius: 8px;">' +
								                '<div style="font-weight: 600; margin-bottom: 5px;">💎 Gemma3-1B-IT</div>' +
								                '<div style="font-size: 12px; color: var(--secondary-text-color); margin-bottom: 8px;">🧠 Smart responses • 📈 Better quality • 🏆 Google model</div>' +
								                '<button onclick="downloadModel(\'https://huggingface.co/litert-community/Gemma3-1B-IT/resolve/main/gemma3-1b-it-int4.task\')" style="background: #34A853; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: 600;">Download (~555MB)</button>' +
								            '</div>' +
								        '</div>';
    
								    modal.className = 'custom-alert-modal';
								    modalBackdrop.style.display = 'block';
								    modal.style.display = 'flex';
									// ✅ ADD CLOSE BUTTON FUNCTIONALITY
									setTimeout(() => {
									    const modal = document.getElementById('modal');
									    if (modal) {
									        modal.style.maxHeight = '85vh';
									    }
									}, 50);

									setTimeout(() => {
									    const title = document.getElementById('modal-title');
									    if (title && !title.querySelector('.close-x')) {
									        title.innerHTML = '📦 Download AI Models<button id="local-close" class="close-x" style="position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 18px; color: var(--modal-text); cursor: pointer; padding: 4px; border-radius: 50%; opacity: 0.7; transition: all 0.2s;"><span class="material-symbols-outlined" style="font-size: 16px;">close</span></button>';
        
									        const closeBtn = document.getElementById('local-close');
									        if (closeBtn) {
									            closeBtn.addEventListener('click', function() {
									                hideModal();
									            });
									        }
									    }
									}, 50);
									    break;
						
				case 'ai-instructions':
				    const instructions = '<div style="font-size: 14px; line-height: 1.6; max-height: 600px; overflow-y: auto; padding-right: 10px;">' +
				        '<div style="text-align: center; margin-bottom: 20px; font-size: 16px; font-weight: 600; color: var(--primary-text-color);">🤖 AI API Setup Guide</div>' +
        
				        '<div style="background: linear-gradient(45deg, #8B5CF6, #06B6D4); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">' +
				            '<div style="font-size: 16px; font-weight: 600; margin-bottom: 5px;">🌐 Custom API </div>' +
				            '<div style="font-size: 12px; opacity: 0.9;">Add any AI provider • OpenAI, Claude, Groq, Gemini & 100+ more<br>⚡ Use any provider • 🎯 Your choice • 🔒 Your control</div>' +
				        '</div>' +
        
				         '<div style="margin: 15px 0;"><strong>Step 1:</strong> Click wr<span style="color: #4285F4;">Ai</span>ter<span style="color: #4285F4; font-weight: 300; margin-left: 4px;">≡</span> → AI Settings</div>' +
				        '<div style="margin: 15px 0;"><strong>Step 2:</strong> Click "Add New API"</div>' +
				        '<div style="margin: 15px 0;"><strong>Step 3:</strong> Enter API name, URL and key</div>' +
				        '<div style="margin: 15px 0;"><strong>Step 4:</strong> Click "Test" to verify connection</div>' +
				        '<div style="margin: 15px 0;"><strong>Step 5:</strong> Click "Save" to start using AI!</div>' +
        
				        '<hr style="border-color: var(--mobile-border-color); margin: 20px 0;">' +
        
				        '<div style="background: linear-gradient(45deg, #6B46C1, #EC4899); color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px;">' +
   					    '<div style="font-weight: 600; margin-bottom: 8px; color: white;">🌟 Get Your API Keys</div>' +
   					    '<div style="font-size: 13px; color: white; line-height: 1.8;">' +
   					        '• <strong style="color: white;">Gemini:</strong> <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: white; text-decoration: underline;">Create Key</a><br>' +
   					        '• <strong style="color: white;">Groq:</strong> <a href="https://console.groq.com/keys" target="_blank" style="color: white; text-decoration: underline;">Create Key</a><br>' +
   					        '• <strong style="color: white;">Perplexity:</strong> <a href="https://www.perplexity.ai/settings/api" target="_blank" style="color: white; text-decoration: underline;">View Keys</a><br>' +
   					        '• <strong style="color: white;">OpenAI:</strong> <a href="https://platform.openai.com/api-keys" target="_blank" style="color: white; text-decoration: underline;">Create Key</a><br>' +
   					        '• <strong style="color: white;">Anthropic:</strong> <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color: white; text-decoration: underline;">Create Key</a><br>' +
   					        '• <strong style="color: white;">DeepSeek:</strong> <a href="https://platform.deepseek.com/api_keys" target="_blank" style="color: white; text-decoration: underline;">View Keys</a><br>' +
				           
						   							 '<hr style="border-color: var(--mobile-border-color); margin: 10px 0;">' +
                
				                '<strong style="color: white;">💡 Pro Tip:</strong> Add multiple APIs for maximum reliability!' +
				            '</div>' +
				        '</div>' +
				    '</div>';
    
				    showCustomAlert('AI Setup Instructions', instructions);
	
    
				    // ✅ KEEP YOUR EXISTING MODAL ENHANCEMENTS
				    setTimeout(() => {
				        const modal = document.getElementById('modal');
				        if (modal) {
				            modal.style.maxHeight = '85vh';
				        }
				    }, 50);
    
				    setTimeout(() => {
				        const title = document.getElementById('modal-title');
				        if (title && !title.querySelector('.close-x')) {
				            title.innerHTML = 'AI Setup Instructions<button id="ai-instructions-close" class="close-x" style="position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 18px; color: var(--modal-text); cursor: pointer; padding: 4px; border-radius: 50%; opacity: 0.7; transition: all 0.2s;"><span class="material-symbols-outlined" style="font-size: 16px;">close</span></button>';
         
				            const closeBtn = document.getElementById('ai-instructions-close');
				            if (closeBtn) {
				                closeBtn.addEventListener('click', function() {
				                    hideModal();
				                });
				            }
				        }
				    }, 50);
				    break;
		
				case 'show-info':
				    const buttonInfo = '<div style="font-size: 13px; line-height: 1.6; max-height: 400px; overflow-y: auto; padding: 0 15px 15px 15px;">' +
        
						// Header Section - Simple
						'<div style="text-align: center; margin-bottom: 20px;">' +
						    '<div style="font-size: 18px; font-weight: 600; color: var(--primary-text-color);">WrAiter Button Guide</div>' +
						'</div>' +
		        
        
				        // Header Controls
				        '<div style="background: var(--modal-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--mobile-border-color); margin-bottom: 20px;">' +
				            '<div style="font-weight: 600; margin-bottom: 12px; color: var(--primary-text-color);">🔝 Header Controls</div>' +
            
							'<div style="margin: 8px 0;">' +
							    '<strong>wr<span style="color: #4285F4;">Ai</span>ter<span style="color: #4285F4;">≡</span></strong> - Main settings menu' +
							'</div>' +
		            
            
				            '<div style="margin: 8px 0; display: flex; align-items: center; gap: 8px;">' +
				                '<span class="material-symbols-outlined" style="font-size: 18px; color: var(--mobile-btn-color);">memory</span>' +
				                '<strong>AI Panel</strong> - View AI results history' +
				            '</div>' +
            
				            '<div style="margin: 8px 0; display: flex; align-items: center; gap: 8px;">' +
				                '<span class="material-symbols-outlined" style="font-size: 18px; color: var(--mobile-btn-color);">undo</span>' +
				                '<strong>Undo</strong> - Reverse last action' +
				            '</div>' +
            
				            '<div style="margin: 8px 0; display: flex; align-items: center; gap: 8px;">' +
				                '<span class="material-symbols-outlined" style="font-size: 18px; color: var(--mobile-btn-color);">redo</span>' +
				                '<strong>Redo</strong> - Restore undone action' +
				            '</div>' +
            
				            '<div style="margin: 8px 0; display: flex; align-items: center; gap: 8px;">' +
				                '<span class="material-symbols-outlined" style="font-size: 18px; color: var(--mobile-btn-color);">dark_mode</span>' +
				                '<strong>Dark Mode</strong> - Toggle light/dark theme' +
				            '</div>' +
            
				            '<div style="margin: 8px 0; display: flex; align-items: center; gap: 8px;">' +
				                '<span class="material-symbols-outlined" style="font-size: 18px; color: var(--mobile-btn-color);">fullscreen</span>' +
				                '<strong>Fullscreen</strong> - Focus writing mode' +
				            '</div>' +
            
				            '<div style="margin: 8px 0; display: flex; align-items: center; gap: 8px;">' +
				                '<span class="material-symbols-outlined" style="font-size: 18px; color: var(--mobile-btn-color);">library_books</span>' +
				                '<strong>Library</strong> - Manage saved documents' +
				            '</div>' +
				        '</div>' +
        
				        // Footer Tools
				        '<div style="background: var(--modal-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--mobile-border-color); margin-bottom: 20px;">' +
				            '<div style="font-weight: 600; margin-bottom: 12px; color: var(--primary-text-color);">🔧 Footer Tools</div>' +
            
				            '<div style="margin: 10px 0;">' +
				                '<strong>🤖 AI Tools:</strong> Suggest, Proofread, Custom, Translate' +
				            '</div>' +
            
				            '<div style="margin: 10px 0;">' +
				                '<strong>✍️ Rewrite:</strong> Shorten, Expand, Paraphrase, Fix Grammar' +
				            '</div>' +
            
				            '<div style="margin: 10px 0;">' +
				                '<strong>🎨 Styles:</strong> Narrate, Visualize, Explain, Creative' +
				            '</div>' +
            
				            '<div style="margin: 10px 0;">' +
				                '<strong>🎭 Tone:</strong> Candid, Humorous, Intense, Sarcastic' +
				            '</div>' +
            
				            '<div style="margin: 10px 0;">' +
				                '<strong>📝 Format:</strong> Font Size ±, Bold, Italic, Center, List, Quote' +
				            '</div>' +
				        '</div>' +
        
				        // Pro Tips
				        '<div style="background: linear-gradient(45deg, #8B5CF6, #06B6D4); color: white; padding: 12px; border-radius: 8px;">' +
				            '<div style="font-weight: 600; margin-bottom: 8px;">💡 Pro Tips</div>' +
				            '<div style="font-size: 12px; line-height: 1.4;">' +
				                '• Select text before using AI tools for better results<br>' +
				                '• Use Custom APIs for unlimited AI access<br>' +
				                '• Download local AI models for offline writing<br>' +
				                '• Documents auto-save to your library<br>' +
				                '• Dark mode reduces eye strain during long writing sessions' +
				            '</div>' +
				        '</div>' +
				    '</div>';
    
				    showCustomAlert('Button Guide', buttonInfo);
    
				    // ✅ ADD CLOSE BUTTON LIKE YOUR ABOUT MODAL
				    setTimeout(() => {
				        const modal = document.getElementById('modal');
				        if (modal) {
				            modal.style.maxHeight = '85vh';
				        }
				    }, 50);
    
				    setTimeout(() => {
				        const title = document.getElementById('modal-title');
				        if (title && !title.querySelector('.close-x')) {
				            title.innerHTML = 'Button Guide<button id="info-close" class="close-x" style="position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 18px; color: var(--modal-text); cursor: pointer; padding: 4px; border-radius: 50%; opacity: 0.7; transition: all 0.2s;"><span class="material-symbols-outlined" style="font-size: 16px;">close</span></button>';
            
				            const closeBtn = document.getElementById('info-close');
				            if (closeBtn) {
				                closeBtn.addEventListener('click', function() {
				                    hideModal();
				                });
				            }
				        }
				    }, 50);
				    break;
			
					case 'show-about':
					    const aboutContent = '<div style="font-size: 14px; line-height: 1.6; max-height: 600px; overflow-y: auto; padding: 0 15px 15px 15px;">' +
        
					        // App Header
					        '<div style="text-align: center; margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; color: white;">' +
					            '<div style="font-size: 24px; font-weight: 700; margin-bottom: 8px; letter-spacing: 1px;">wr<span style="color: #FFD700;">A</span>iter<span style="color: #4285F4;">≡</span></div>' +
					            '<div style="font-size: 13px; opacity: 0.9;">AI-Powered Writing Assistant</div>' +
					           '<div style="font-size: 11px; opacity: 0.7; margin-top: 8px;">Version 5.0 • <a href="https://thosho.github.io/" target="_blank" style="color: inherit; text-decoration: none;">@Thosho Tech</a></div>' +
					        '</div>' +
        
					        // What Makes Us Special
					        '<div style="margin-bottom: 20px;">' +
					            '<div style="background: var(--modal-bg); border-left: 4px solid #4285F4; padding: 12px; border-radius: 8px; margin-bottom: 15px;">' +
					                '<div style="font-weight: 500; margin-bottom: 8px;">🌍 Universal AI Support</div>' +
					                '<div style="font-size: 13px; color: var(--secondary-text-color);">Connect any AI provider - OpenAI, Claude, Groq, Gemini, DeepSeek and 100+ more. Your choice, your control.</div>' +
					            '</div>' +
					            '<div style="background: var(--modal-bg); border-left: 4px solid #10B981; padding: 12px; border-radius: 8px; margin-bottom: 15px;">' +
					                '<div style="font-weight: 500; margin-bottom: 8px;">🔒 Complete Privacy</div>' +
					                '<div style="font-size: 13px; color: var(--secondary-text-color);">Use local AI models that work 100% offline. No data leaves your device, ever.</div>' +
					            '</div>' +
					            '<div style="background: var(--modal-bg); border-left: 4px solid #8B5CF6; padding: 12px; border-radius: 8px;">' +
					                '<div style="font-weight: 500; margin-bottom: 8px;">🚀 Smart & Fast</div>' +
					                '<div style="font-size: 13px; color: var(--secondary-text-color);">Intelligent fallback system automatically tries multiple AI sources for maximum reliability.</div>' +
					            '</div>' +
					        '</div>' +
        
					        // Key Features
					        '<div style="margin-bottom: 20px;">' +
					            '<div style="font-weight: 600; margin-bottom: 12px; color: var(--primary-text-color); font-size: 16px;">🛠️ Key Features</div>' +
					            '<div style="display: grid; gap: 8px;">' +
					                '<div style="display: flex; align-items: center; gap: 8px;"><span class="material-symbols-outlined" style="font-size: 16px; color: #4285F4;">auto_fix_high</span><span style="font-size: 13px;">AI writing tools with custom prompts</span></div>' +
					                '<div style="display: flex; align-items: center; gap: 8px;"><span class="material-symbols-outlined" style="font-size: 16px; color: #10B981;">translate</span><span style="font-size: 13px;">Universal language translation</span></div>' +
					                '<div style="display: flex; align-items: center; gap: 8px;"><span class="material-symbols-outlined" style="font-size: 16px; color: #EF4444;">spellcheck</span><span style="font-size: 13px;">Advanced grammar checking</span></div>' +
					                '<div style="display: flex; align-items: center; gap: 8px;"><span class="material-symbols-outlined" style="font-size: 16px; color: #F59E0B;">palette</span><span style="font-size: 13px;">Multiple writing styles & tones</span></div>' +
					                '<div style="display: flex; align-items: center; gap: 8px;"><span class="material-symbols-outlined" style="font-size: 16px; color: #8B5CF6;">save</span><span style="font-size: 13px;">Auto-save with document library</span></div>' +
					                '<div style="display: flex; align-items: center; gap: 8px;"><span class="material-symbols-outlined" style="font-size: 16px; color: #6B7280;">dark_mode</span><span style="font-size: 13px;">Beautiful dark/light themes</span></div>' +
					            '</div>' +
					        '</div>' +
        
					        // Tech Stats
					        '<div style="margin-bottom: 20px;">' +
					            '<div style="font-weight: 600; margin-bottom: 12px; color: var(--primary-text-color); font-size: 16px;">📊 Technical Excellence</div>' +
					            '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">' +
					                '<div style="text-align: center; padding: 10px; background: var(--modal-bg); border-radius: 8px; border: 1px solid var(--mobile-border-color);">' +
					                    '<div style="font-weight: 600; color: #4285F4; font-size: 16px;">100+</div>' +
					                    '<div style="font-size: 11px; color: var(--secondary-text-color);">AI Providers</div>' +
					                '</div>' +
					                '<div style="text-align: center; padding: 10px; background: var(--modal-bg); border-radius: 8px; border: 1px solid var(--mobile-border-color);">' +
					                    '<div style="font-weight: 600; color: #10B981; font-size: 16px;">Zero</div>' +
					                    '<div style="font-size: 11px; color: var(--secondary-text-color);">Data Tracking</div>' +
					                '</div>' +
					                '<div style="text-align: center; padding: 10px; background: var(--modal-bg); border-radius: 8px; border: 1px solid var(--mobile-border-color);">' +
					                    '<div style="font-weight: 600; color: #8B5CF6; font-size: 16px;">24/7</div>' +
					                    '<div style="font-size: 11px; color: var(--secondary-text-color);">Offline Mode</div>' +
					                '</div>' +
					                '<div style="text-align: center; padding: 10px; background: var(--modal-bg); border-radius: 8px; border: 1px solid var(--mobile-border-color);">' +
					                    '<div style="font-weight: 600; color: #EF4444; font-size: 16px;">∞</div>' +
					                    '<div style="font-size: 11px; color: var(--secondary-text-color);">Possibilities</div>' +
					                '</div>' +
					            '</div>' +
					        '</div>' +
        
					        // Footer
					        '<div style="text-align: center; padding: 15px; background: var(--modal-bg); border-radius: 12px; border: 1px solid var(--mobile-border-color);">' +
					            '<div style="font-weight: 600; margin-bottom: 8px; color: var(--primary-text-color);">Created by Thosho Tech</div>' +
					            '<div style="font-size: 12px; color: var(--secondary-text-color); line-height: 1.4;">Empowering writers with cutting-edge AI technology. Built with passion for the writing community.</div>' +
					        '</div>' +
					    '</div>';
    
					    showCustomAlert('About wrAiter', aboutContent);
    
					    // Add close button like your existing modals
					    setTimeout(() => {
					        const modal = document.getElementById('modal');
					        if (modal) {
					            modal.style.maxHeight = '85vh';
					        }
					    }, 50);
    
					    setTimeout(() => {
					        const title = document.getElementById('modal-title');
					        if (title && !title.querySelector('.close-x')) {
					            title.innerHTML = 'About wrAiter<button id="about-close" class="close-x" style="position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 18px; color: var(--modal-text); cursor: pointer; padding: 4px; border-radius: 50%; opacity: 0.7; transition: all 0.2s;"><span class="material-symbols-outlined" style="font-size: 16px;">close</span></button>';
            
					            const closeBtn = document.getElementById('about-close');
					            if (closeBtn) {
					                closeBtn.addEventListener('click', function() {
					                    hideModal();
					                });
					            }
					        }
					    }, 50);
					    break;
						
						// ✅ ADD THIS NEW CASE
						        case 'remove-ads':
						            if (window.TaskModelBridge) {
						                window.TaskModelBridge.startPurchaseFlow();
						            } else {
						                showCustomAlert('Not Available', 'This feature is only available in the Android app.');
						            }
						            break;
			
        
		    }
		}

		document.addEventListener('click', function(e) {
		    const target = e.target;
		    const actionEl = target.closest('[data-action]');
		    const toggleEl = target.closest('.popup-menu-toggle');
    
		    if (target.id === 'alert-close-btn') {
		        hideModal();
		        return;
		    }
    
		    if (target.id === 'confirm-delete' || target.id === 'confirm-cancel') {
		        if (target.onclick) {
		            target.onclick();
		        }
		        return;
		    }
    
		    if (target.classList.contains('modal-button')) {
		        if (target.onclick) {
		            target.onclick();
		        }
		        return;
		    }
    
		    if (target.classList.contains('insert-btn')) {
		        const resultText = document.querySelector('.ai-result-text').textContent.trim();
		        insertTextAtCursor(resultText);
		        setTimeout(hideAiPanel, 300);
		        return;
		    }
    
		    if (target.classList.contains('replace-btn')) {
		        const resultText = document.querySelector('.ai-result-text').textContent.trim();
		        replaceSelectedText(resultText);
		        setTimeout(hideAiPanel, 300);
		        return;
		    }
    
		    if (target.classList.contains('copy-btn')) {
		        const resultText = document.querySelector('.ai-result-text').textContent.trim();
		        copyToClipboard(resultText);
		        setTimeout(hideAiPanel, 300);
		        return;
		    }
    
		    if (actionEl) {
		        handleAction(actionEl.dataset.action);
		        return;
		    }
    
		    if (toggleEl) {
		        const menuId = toggleEl.dataset.menu;
		        if (menuId) {
		            const menu = document.getElementById(menuId);
		            if (menu.classList.contains('show')) {
		                closeAllMenus();
		            } else {
		                closeAllMenus();
		                menu.classList.add('show');
		                setTimeout(() => positionPopupMenu(menu, toggleEl), 10);
		            }
		        }
		        return;
		    }
    
			if (!target.closest('.popup-menu') && !target.closest('mobile-slider-menu') && !target.closest('ai-top-panel') && !target.closest('.wraiter-btn')) {
			    closeAllMenus();
			}
    
		});

		window.deleteFile = deleteFile;
		window.createNewFolder = createNewFolder;
		window.getAllFolders = getAllFolders;
		window.getAllFoldersData = getAllFoldersData;
		window.saveFoldersData = saveFoldersData;
		window.deleteFolder = deleteFolder;
		window.renameFolder = renameFolder;
		window.moveDocumentToFolder = moveDocumentToFolder;
		

		// ✅ Ensure this block looks exactly like this
		editor.addEventListener('input', function() {
		    updateEditorState();
		    floatingToolbar.ensureCursorVisible();
		});
	
				

				editor.addEventListener('click', function(e) {
				    // Only move cursor to end if clicking on empty space, not on existing text
				    if (e.target.id === 'editor') {
				        moveCursorToEnd();
				    }
				    floatingToolbar.ensureCursorVisible();
				});
				

				editor.addEventListener('keydown', function() {
				  floatingToolbar.ensureCursorVisible();
				});
		
				editor.addEventListener('focus', function() {
				    floatingToolbar.ensureCursorVisible();
				});

				modalBackdrop.addEventListener('click', hideModal);
				
		if (localStorage.getItem('darkMode') === 'true') {
		    document.body.classList.add('dark-mode');
		} else {
		    document.body.classList.remove('dark-mode');
		}

		createNewDocument();
		updateEditorState();
		darkModeIcon.textContent = document.body.classList.contains('dark-mode') ? 'dark_mode' : 'light_mode';

		updateAiStatus('');

		const savedAiResults = localStorage.getItem('wraiterAiResults');
		if (savedAiResults) {
		    try {
		        aiResults = JSON.parse(savedAiResults);
		        if (aiResults.length > 0) {
		            updateAiStatus('has-results');
		        }
		    } catch(e) {
		        aiResults = [];
		    }
		}

		setInterval(function() {
		    if (aiResults.length > 0) {
		        localStorage.setItem('wraiterAiResults', JSON.stringify(aiResults.slice(0, 20)));
		    }
		}, 10000);
      

	   // Check if user is online or offline
	   function isOnline() {
	       return navigator.onLine;
	   }

	  function showTopAd() {
	  // ✅ ADD THIS CHECK AT THE TOP OF THE FUNCTION
	      if (window.TaskModelBridge && typeof window.TaskModelBridge.isUserPro === 'function' && window.TaskModelBridge.isUserPro()) {
	          console.log("Top ad skipped - User is Pro");
	          hideTopAd(); // Ensure it's hidden just in case
	          return;
	      }
		  
	      if (!topAdContainer || !topBar) return;

	      // Clear any existing timer
	      if (topAdTimer) {
	          clearTimeout(topAdTimer);
	          topAdTimer = null;
	      }

	      // CHECK IF WE'RE IN NORMAL MODE (not in AI panel or fullscreen)
	      const isInAiPanel = document.getElementById("ai-top-panel")?.classList.contains("show");
	      const isInFullscreen = document.body.classList.contains("focus-mode");
    
	      // Don't show ad if we're in AI history panel or fullscreen mode
	      if (isInAiPanel || isInFullscreen) {
	          console.log("Top ad skipped - Not in normal editor mode");
	          return;
	      }

		 if (isOnline()) {
		     // ONLINE: Move the banner ad from footer to top
		     if (window.TaskModelBridge) {
		         // Tell Android to move the actual banner ad to the top
		         window.TaskModelBridge.moveAdToTop();
        
		         // Clear the container (Android will handle the ad placement)
		         topAdContainer.innerHTML = '';
		     } else {
		 
		         // Fallback: Show ToScript link if bridge not available
		         topAdContainer.innerHTML = `
		             <div style="background: #4285F4; color: white; display: flex; align-items: center; justify-content: center; text-align: center; height: 50px; padding: 0 10px; font-family: Roboto, sans-serif;">
		                 <a href="https://play.google.com/store/apps/details?id=com.thosho.toscript&hl=en_IN" target="_blank" style="text-decoration: none; color: white; display: block;">
		                     <strong style="font-size: 14px;">Try ToScript</strong>
		                     <span style="font-size: 13px; opacity: 0.9; margin-left: 8px;">Your Screenplay writing App</span>
		                 </a>
		             </div>
		         `;
		     }
		 }
	     
	      // Show the ad and push the header down
	      topAdContainer.style.display = "block";
	      topBar.style.transition = "margin-top 0.3s ease";
	      topBar.style.marginTop = "50px"; // 50px is the standard banner height
		  
			  // ✅ ADD THESE TWO LINES TO PUSH THE EDITOR DOWN
		     	  mainContainer.style.transition = "margin-top 0.3s ease";
		      	  mainContainer.style.marginTop = "100px"; 
			  
			  // ✅ FIX: Resize the editor container to make room for the footer
			      mainContainer.style.height = "calc(100vh - 100px)";

	     	  // Set a timer to hide the ad after the specified duration
	      topAdTimer = setTimeout(hideTopAd, adDuration);
	  }
	  
	   function hideTopAd() {
	       if (!topAdContainer || !topBar) return;

	       // Hide the ad and move the header back up
	       topAdContainer.style.display = "none";
	       topBar.style.marginTop = "0";
		   
		   // ✅ ADD THIS LINE TO MOVE THE EDITOR BACK UP
		      mainContainer.style.marginTop = "50px"; 
			  
		   // ✅ FIX: Restore the editor container's original height
			  mainContainer.style.height = "calc(100vh - 50px)";

	       // Tell Android to move the ad back to the bottom (if online)
	       if (isOnline() && window.TaskModelBridge) {
	           window.TaskModelBridge.moveAdToBottom();
	       }

	       // Clear the timer reference
	       topAdTimer = null;
	   }

	   // Listen for online/offline changes
	   window.addEventListener('online', function() {
	       console.log('App is now ONLINE');
	       // If top ad is currently showing, update it
	       if (topAdContainer && topAdContainer.style.display === "block") {
	           showTopAd();
	       }
	   });

	   window.addEventListener('offline', function() {
	       console.log('App is now OFFLINE');
	       // If top ad is currently showing, update it
	       if (topAdContainer && topAdContainer.style.display === "block") {
	           showTopAd();
	       }
	   });

	   document.addEventListener('DOMContentLoaded', () => {
   	 // Wait just a moment for the webview to settle before showing the ad
    	setTimeout(showTopAd, 200); 
		});
	  
	  function showFallbackAd() {
	      console.log("Showing fallback ToScript ad in AI history footer");
    
	      const aiPanel = document.getElementById("ai-top-panel");
	      const aiPanelContent = document.getElementById("ai-panel-content");
    
	      if (!aiPanel || !aiPanel.classList.contains("show") || !aiPanelContent) {
	          console.log("AI panel not open, skipping fallback ad");
	          return;
	      }
    
	      let fallbackAdContainer = document.getElementById("fallback-ad-container");
    
	      if (!fallbackAdContainer) {
	          fallbackAdContainer = document.createElement("div");
	          fallbackAdContainer.id = "fallback-ad-container";
	          // ✅ CRITICAL FIX: Use position: fixed with proper bottom offset
	          fallbackAdContainer.style.cssText = "width: 100%; background: #4285F4; color: white; display: flex; align-items: center; justify-content: center; text-align: center; height: 50px; padding: 0 10px; font-family: Roboto, sans-serif; position: fixed; bottom: 0; left: 0; right: 0; z-index: 20001;";
        
	          fallbackAdContainer.innerHTML = '<a href="https://play.google.com/store/apps/details?id=com.thosho.toscript&hl=en_IN" target="_blank" style="text-decoration: none; color: white; display: block;"><strong style="font-size: 14px;">Try ToScript</strong><span style="font-size: 13px; opacity: 0.9; margin-left: 8px;">Your Screenwriting App</span></a>';
        
	          // ✅ IMPORTANT: Append to body, not AI panel, but only show when panel is open
	          document.body.appendChild(fallbackAdContainer);
	      }
    
	      // ✅ Only show when AI panel is visible
	      if (aiPanel.classList.contains("show")) {
	          fallbackAdContainer.style.display = "flex";
	      }
	  }
	  
	  

	  // ✅ Hide fallback ad when AI history panel closes
	  function hideFallbackAd() {
	      const fallbackAdContainer = document.getElementById("fallback-ad-container");
	      if (fallbackAdContainer) {
	          fallbackAdContainer.style.display = "none";
	      }
	  }
	  // ====== END OF FALLBACK AD FUNCTIONS ======
	  
	  // ✅ Check initial pro status when the webview has loaded
	      setTimeout(() => {
	          if (window.TaskModelBridge && typeof window.TaskModelBridge.isUserPro === 'function') {
	              const isPro = window.TaskModelBridge.isUserPro();
	              console.log('Initial pro check from JS:', isPro);
	              updateUiForProStatus(isPro);
	          }
	      }, 200); // Small delay to ensure bridge is ready
	   
       

		console.log('🚀 Wraiter v3 - Enhanced Experience');
		});
		
		
		// Enable mobile drag and drop
		var draggedElement = null;
		var draggedDocId = null;

		document.addEventListener('touchstart', function(e) {
		    var target = e.target.closest('[data-doc-id]');
		    if (target) {
		        draggedElement = target;
		        draggedDocId = target.getAttribute('data-doc-id');
		        target.style.opacity = '0.5';
		    }
		}, { passive: true });

		document.addEventListener('touchend', function(e) {
		    if (draggedElement) {
		        draggedElement.style.opacity = '1';
        
		        var dropTarget = document.elementFromPoint(
		            e.changedTouches[0].clientX,
		            e.changedTouches[0].clientY
		        );
        
		        var folderHeader = dropTarget ? dropTarget.closest('[data-folder]') : null;
		        if (folderHeader && draggedDocId) {
		            var folderName = folderHeader.getAttribute('data-folder');
		            moveDocumentToFolder(draggedDocId, folderName);
		        }
        
		        draggedElement = null;
		        draggedDocId = null;
		    }
		}, { passive: true });
		

		</script>
		</body>
		</html>
